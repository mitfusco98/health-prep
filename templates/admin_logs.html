
{% extends "base.html" %}

{% block title %}Admin Logs - Healthcare App{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-clipboard-list"></i> Admin Activity Logs</h2>
                <div class="btn-group">
                    <a href="{{ url_for('export_admin_logs', format='json', days=30) }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-download"></i> Export JSON
                    </a>
                    <a href="{{ url_for('export_admin_logs', format='csv', days=30) }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-download"></i> Export CSV
                    </a>
                </div>
            </div>

            <!-- Statistics Summary -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body">
                            <h5 class="card-title">Total Logs</h5>
                            <h3 class="mb-0">{{ total_logs }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body">
                            <h5 class="card-title">Today's Activity</h5>
                            <h3 class="mb-0">{{ today_logs }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-warning text-white">
                        <div class="card-body">
                            <h5 class="card-title">Failed Logins Today</h5>
                            <h3 class="mb-0">{{ failed_logins_today }}</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body">
                            <h5 class="card-title">Active Users</h5>
                            <h3 class="mb-0" id="active-users">-</h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-filter"></i> Filters
                        <button class="btn btn-sm btn-outline-secondary float-end" type="button" onclick="clearFilters()">
                            Clear All
                        </button>
                    </h5>
                </div>
                <div class="card-body">
                    <form method="GET" id="filter-form">
                        <div class="row">
                            <div class="col-md-2">
                                <label for="event_type" class="form-label">Event Type</label>
                                <select name="event_type" id="event_type" class="form-select form-select-sm">
                                    <option value="">All Events</option>
                                    {% for event_type in event_types %}
                                    <option value="{{ event_type }}" 
                                            {% if current_filters.event_type == event_type %}selected{% endif %}>
                                        {{ event_type.replace('_', ' ').title() }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label for="user" class="form-label">User</label>
                                <input type="text" name="user" id="user" class="form-control form-control-sm" 
                                       value="{{ current_filters.user }}" placeholder="Username...">
                            </div>
                            <div class="col-md-2">
                                <label for="date_from" class="form-label">From Date</label>
                                <input type="date" name="date_from" id="date_from" class="form-control form-control-sm" 
                                       value="{{ current_filters.date_from }}">
                            </div>
                            <div class="col-md-2">
                                <label for="date_to" class="form-label">To Date</label>
                                <input type="date" name="date_to" id="date_to" class="form-control form-control-sm" 
                                       value="{{ current_filters.date_to }}">
                            </div>
                            <div class="col-md-2">
                                <label for="search" class="form-label">Search</label>
                                <input type="text" name="search" id="search" class="form-control form-control-sm" 
                                       value="{{ current_filters.search }}" placeholder="Search details...">
                            </div>
                            <div class="col-md-2">
                                <label for="per_page" class="form-label">Per Page</label>
                                <select name="per_page" id="per_page" class="form-select form-select-sm">
                                    <option value="25" {% if current_filters.per_page == 25 %}selected{% endif %}>25</option>
                                    <option value="50" {% if current_filters.per_page == 50 %}selected{% endif %}>50</option>
                                    <option value="100" {% if current_filters.per_page == 100 %}selected{% endif %}>100</option>
                                </select>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary btn-sm">
                                    <i class="fas fa-search"></i> Apply Filters
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Logs Table -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Activity Logs</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="table-dark">
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Event Type</th>
                                    <th>User</th>
                                    <th>IP Address</th>
                                    <th>Details</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for log in logs %}
                                <tr>
                                    <td>
                                        <small>{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</small>
                                    </td>
                                    <td>
                                        <span class="badge 
                                            {% if 'login_fail' in log.event_type %}bg-danger
                                            {% elif 'delete' in log.event_type %}bg-warning
                                            {% elif 'admin' in log.event_type %}bg-info
                                            {% elif 'patient' in log.event_type %}bg-success
                                            {% else %}bg-secondary{% endif %}">
                                            {{ log.event_type.replace('_', ' ').title() }}
                                        </span>
                                    </td>
                                    <td>{{ log.user }}</td>
                                    <td>
                                        <small>{{ log.ip_address or 'Unknown' }}</small>
                                    </td>
                                    <td>
                                        <div class="details-preview" style="max-width: 300px;">
                                            {% if log.details %}
                                                {% if log.details.patient_name %}
                                                    <strong>Patient:</strong> {{ log.details.patient_name }}<br>
                                                {% endif %}
                                                {% if log.details.route %}
                                                    <strong>Route:</strong> {{ log.details.route }}<br>
                                                {% endif %}
                                                {% if log.details.method %}
                                                    <strong>Method:</strong> {{ log.details.method }}<br>
                                                {% endif %}
                                                {% if log.details.data_type %}
                                                    <strong>Data Type:</strong> {{ log.details.data_type }}<br>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                    </td>
                                    <td>
                                        <button class="btn btn-outline-primary btn-sm" 
                                                onclick="viewLogDetails({{ log.id | tojson }}, {{ log.details | tojson }})">
                                            <i class="fas fa-eye"></i> View
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Pagination -->
            {% if pagination.pages > 1 %}
            <nav aria-label="Logs pagination" class="mt-4">
                <ul class="pagination justify-content-center">
                    {% if pagination.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('admin_logs', page=pagination.prev_num, **current_filters) }}">
                            Previous
                        </a>
                    </li>
                    {% endif %}
                    
                    {% for page_num in pagination.iter_pages() %}
                        {% if page_num %}
                            {% if page_num != pagination.page %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('admin_logs', page=page_num, **current_filters) }}">
                                    {{ page_num }}
                                </a>
                            </li>
                            {% else %}
                            <li class="page-item active">
                                <span class="page-link">{{ page_num }}</span>
                            </li>
                            {% endif %}
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if pagination.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('admin_logs', page=pagination.next_num, **current_filters) }}">
                            Next
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
</div>

<!-- Log Details Modal -->
<div class="modal fade" id="logDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Log Entry Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <pre id="logDetailsContent" class="bg-light p-3" style="max-height: 400px; overflow-y: auto;"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
function viewLogDetails(logId, details) {
    const content = document.getElementById('logDetailsContent');
    content.textContent = JSON.stringify(details, null, 2);
    
    const modal = new bootstrap.Modal(document.getElementById('logDetailsModal'));
    modal.show();
}

function clearFilters() {
    window.location.href = '{{ url_for("admin_logs") }}';
}

// Auto-refresh stats every 30 seconds
setInterval(async () => {
    try {
        const response = await fetch('/admin/logs/stats');
        const stats = await response.json();
        
        if (stats.today_logs !== undefined) {
            document.querySelector('.card.bg-info h3').textContent = stats.today_logs;
        }
        if (stats.failed_logins_24h !== undefined) {
            document.querySelector('.card.bg-warning h3').textContent = stats.failed_logins_24h;
        }
    } catch (error) {
        console.error('Error refreshing stats:', error);
    }
}, 30000);
</script>

{% endblock %}
