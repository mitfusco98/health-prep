{% extends "base_demo.html" %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Screening Types Management</h1>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addScreeningTypeModal">
            <i class="fas fa-plus me-1"></i> Add New Screening Type
        </button>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">Available Screening Types</h5>
        </div>
        <div class="card-body">
            {% if screening_types %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Name & Keywords</th>
                                <th>Frequency</th>
                                <th>Gender Specific</th>
                                <th>Age Range</th>
                                <th>Status</th>
                                <th width="150">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for screening_type in screening_types %}
                                <tr>
                                    <td>
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <strong>{{ screening_type.name }}</strong>
                                                <div class="keyword-tags mt-2" id="keywords-{{ screening_type.id }}" data-screening-id="{{ screening_type.id }}">
                                                    <small class="text-muted">Loading keywords...</small>
                                                </div>
                                            </div>
                                            <button type="button" class="btn btn-sm btn-outline-primary ms-2 manage-keywords-btn" 
                                                    data-screening-id="{{ screening_type.id }}"
                                                    data-screening-name="{{ screening_type.name }}">
                                                <i class="fas fa-tags me-1"></i>Keywords
                                            </button>
                                        </div>
                                    </td>
                                    <td>{{ screening_type.formatted_frequency }}</td>
                                    <td>
                                        {% if screening_type.gender_specific %}
                                            {{ screening_type.gender_specific }}
                                        {% else %}
                                            All Genders
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if screening_type.min_age and screening_type.max_age %}
                                            Ages {{ screening_type.min_age }} to {{ screening_type.max_age }}
                                        {% elif screening_type.min_age %}
                                            Age {{ screening_type.min_age }}+
                                        {% elif screening_type.max_age %}
                                            Up to age {{ screening_type.max_age }}
                                        {% else %}
                                            All Ages
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if screening_type.is_active %}
                                            <span class="badge bg-success">Active</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Inactive</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-outline-primary edit-screening-btn" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#editScreeningTypeModal"
                                                data-id="{{ screening_type.id }}"
                                                data-name="{{ screening_type.name }}"
                                                data-description=""
                                                data-frequency-number="{{ screening_type.frequency_number or '' }}"
                                                data-frequency-unit="{{ screening_type.frequency_unit or '' }}"
                                                data-gender="{{ screening_type.gender_specific or '' }}"
                                                data-min-age="{{ screening_type.min_age or '' }}"
                                                data-max-age="{{ screening_type.max_age or '' }}"
                                                data-active="{{ 'checked' if screening_type.is_active else '' }}">
                                            Edit
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-danger delete-screening-btn"
                                                data-bs-toggle="modal" 
                                                data-bs-target="#deleteScreeningTypeModal"
                                                data-id="{{ screening_type.id }}"
                                                data-name="{{ screening_type.name }}">
                                            Delete
                                        </button>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i> No screening types have been defined yet. Use the "Add New Screening Type" button to create one.
                </div>
            {% endif %}
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-light">
            <h5 class="mb-0">About Screening Types</h5>
        </div>
        <div class="card-body">
            <p>Screening types define the preventive health screenings that will appear on patient prep sheets. 
               You can customize which screenings appear based on patient age, gender, and other factors.</p>

            <h6>Important Notes:</h6>
            <ul>
                <li>Screenings will only appear for patients matching the specified criteria.</li>
                <li>Inactive screenings will not appear on prep sheets but are preserved in the database.</li>
                <li>If a screening is used by existing patients, it cannot be completely deleted, only deactivated.</li>
            </ul>
        </div>
    </div>
</div>

<!-- Add Screening Type Modal -->
<div class="modal fade" id="addScreeningTypeModal" tabindex="-1" aria-labelledby="addScreeningTypeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addScreeningTypeModalLabel">Add New Screening Type</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('add_screening_type') }}">
                <div class="modal-body">
                    {{ add_form.hidden_tag() }}

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="form-group">
                                {{ add_form.name.label(class="form-label") }}
                                {{ add_form.name(class="form-control") }}
                                <small class="form-text text-muted">{{ add_form.name.description }}</small>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label">Frequency</label>
                            <div class="row">
                                <div class="col-md-4">
                                    {{ add_form.frequency_number(class="form-control", placeholder="1") }}
                                    <small class="form-text text-muted">Number</small>
                                </div>
                                <div class="col-md-8">
                                    {{ add_form.frequency_unit(class="form-select") }}
                                    <small class="form-text text-muted">Time unit</small>
                                </div>
                            </div>
                            <small class="form-text text-muted">Set how often this screening should be performed</small>
                        </div>
                    </div>

                    <div class="form-group mb-3">
                        <label class="form-label">Document Keywords</label>
                        <div class="keyword-input-container">
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" id="addKeywordInput" placeholder="Enter keyword (e.g., 'mammogram', 'glucose')">
                                <select class="form-select" id="addSectionSelect" style="max-width: 150px;">
                                    <option value="labs">Labs</option>
                                    <option value="imaging">Imaging</option>
                                    <option value="procedures">Procedures</option>
                                    <option value="vitals">Vitals</option>
                                    <option value="consults">Consults</option>
                                    <option value="medications">Medications</option>
                                    <option value="general" selected>General</option>
                                </select>
                                <button type="button" class="btn btn-outline-primary" id="addKeywordBtn">
                                    <i class="fas fa-plus"></i> Add
                                </button>
                            </div>
                            <div id="addKeywordsList" class="keywords-display mb-2">
                                <!-- Keywords will appear here as tags -->
                            </div>
                            <input type="hidden" name="keywords" id="addKeywordsData">
                        </div>
                        <small class="form-text text-muted">Define keywords to help identify documents related to this screening. Keywords will be used for document matching when FHIR codes are not available.</small>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="form-group">
                                {{ add_form.gender_specific.label(class="form-label") }}
                                {{ add_form.gender_specific(class="form-select") }}
                                <small class="form-text text-muted">{{ add_form.gender_specific.description }}</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                {{ add_form.min_age.label(class="form-label") }}
                                {{ add_form.min_age(class="form-control") }}
                                <small class="form-text text-muted">{{ add_form.min_age.description }}</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                {{ add_form.max_age.label(class="form-label") }}
                                {{ add_form.max_age(class="form-control") }}
                                <small class="form-text text-muted">{{ add_form.max_age.description }}</small>
                            </div>
                        </div>
                    </div>

                    <div class="form-check mb-3">
                        {{ add_form.is_active(class="form-check-input") }}
                        {{ add_form.is_active.label(class="form-check-label") }}
                        <div><small class="form-text text-muted">{{ add_form.is_active.description }}</small></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    {{ add_form.submit(class="btn btn-primary") }}
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Screening Type Modal -->
<div class="modal fade" id="editScreeningTypeModal" tabindex="-1" aria-labelledby="editScreeningTypeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editScreeningTypeModalLabel">Edit Screening Type</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('edit_screening_type', screening_type_id=0) }}" id="editScreeningForm">
                <div class="modal-body">
                    {{ edit_form.hidden_tag() }}

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="form-group">
                                {{ edit_form.name.label(class="form-label") }}
                                {{ edit_form.name(class="form-control") }}
                                <small class="form-text text-muted">{{ edit_form.name.description }}</small>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label">Frequency</label>
                            <div class="row">
                                <div class="col-md-4">
                                    {{ edit_form.frequency_number(class="form-control", placeholder="1") }}
                                    <small class="form-text text-muted">Number</small>
                                </div>
                                <div class="col-md-8">
                                    {{ edit_form.frequency_unit(class="form-select") }}
                                    <small class="form-text text-muted">Time unit</small>
                                </div>
                            </div>
                            <small class="form-text text-muted">Set how often this screening should be performed</small>
                        </div>
                    </div>

                    <div class="form-group mb-3">
                        <label class="form-label">Document Keywords</label>
                        <div class="keyword-input-container">
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" id="editKeywordInput" placeholder="Enter keyword (e.g., 'mammogram', 'glucose')">
                                <select class="form-select" id="editSectionSelect" style="max-width: 150px;">
                                    <option value="labs">Labs</option>
                                    <option value="imaging">Imaging</option>
                                    <option value="procedures">Procedures</option>
                                    <option value="vitals">Vitals</option>
                                    <option value="consults">Consults</option>
                                    <option value="medications">Medications</option>
                                    <option value="general" selected>General</option>
                                </select>
                                <button type="button" class="btn btn-outline-primary" onclick="addEditModalKeyword()">
                                    <i class="fas fa-plus"></i> Add
                                </button>
                            </div>
                            <div id="editKeywordsList" class="keywords-display mb-2">
                                <!-- Keywords will appear here as tags -->
                            </div>
                            <input type="hidden" name="keywords" id="editKeywordsData">
                        </div>
                        <small class="form-text text-muted">Define keywords to help identify documents related to this screening. Keywords will be used for document matching when FHIR codes are not available.</small>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="form-group">
                                {{ edit_form.gender_specific.label(class="form-label") }}
                                {{ edit_form.gender_specific(class="form-select") }}
                                <small class="form-text text-muted">{{ edit_form.gender_specific.description }}</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                {{ edit_form.min_age.label(class="form-label") }}
                                {{ edit_form.min_age(class="form-control") }}
                                <small class="form-text text-muted">{{ edit_form.min_age.description }}</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                {{ edit_form.max_age.label(class="form-label") }}
                                {{ edit_form.max_age(class="form-control") }}
                                <small class="form-text text-muted">{{ edit_form.max_age.description }}</small>
                            </div>
                        </div>
                    </div>

                    <div class="form-check mb-3">
                        {{ edit_form.is_active(class="form-check-input") }}
                        {{ edit_form.is_active.label(class="form-check-label") }}
                        <div><small class="form-text text-muted">{{ edit_form.is_active.description }}</small></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    {{ edit_form.submit(class="btn btn-primary") }}
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Screening Type Modal -->
<div class="modal fade" id="deleteScreeningTypeModal" tabindex="-1" aria-labelledby="deleteScreeningTypeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteScreeningTypeModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the screening type <strong id="deleteScreeningName"></strong>?</p>
                <p class="text-danger">This action cannot be undone. If this screening is used by any patients, it will be marked as inactive instead of being deleted.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" action="{{ url_for('delete_screening_type', screening_type_id=0) }}" id="deleteScreeningForm">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Keyword Management Modal -->
<div class="modal fade" id="keywordManagementModal" tabindex="-1" aria-labelledby="keywordManagementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="keywordManagementModalLabel">Manage Keywords for <span id="modalScreeningName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Keywords help identify documents related to this screening type. They're used when FHIR codes aren't available.
                </div>

                <div class="keyword-input-container">
                    <div class="d-flex mb-2">
                        <input type="text" class="form-control me-2" id="manageKeywordInput" placeholder="Enter keyword" onkeypress="if(event.key==='Enter'){addManageModalKeyword(); return false;}">
                        <button type="button" class="btn btn-outline-primary" onclick="addManageModalKeyword()">Add</button>
                    </div>
                    <div id="manageKeywordsList" class="keywords-display">
                        <!-- Keywords will be rendered here -->
                    </div>
                </div>

                <div class="mt-4">
                    <h6>Common Keywords by Section:</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Labs:</strong> glucose, cholesterol, hemoglobin, hba1c, creatinine<br>
                            <strong>Imaging:</strong> mammogram, x-ray, ct scan, mri, ultrasound<br>
                            <strong>Procedures:</strong> colonoscopy, biopsy, endoscopy
                        </div>
                        <div class="col-md-6">
                            <strong>Vitals:</strong> blood pressure, heart rate, weight, height<br>
                            <strong>Consults:</strong> cardiology, oncology, neurology<br>
                            <strong>Medications:</strong> insulin, metformin, lisinopril
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveKeywordsBtn">Save Keywords</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
.keywords-display {
    min-height: 60px;
    border: 1px dashed #ccc;
    border-radius: 4px;
    padding: 10px;
}

.keyword-tag {
    display: inline-block;
    background-color: #e9ecef;
    border: 1px solid #ced4da;
    border-radius: 15px;
    padding: 4px 12px;
    margin: 2px;
    font-size: 0.875rem;
}

.keyword-tag .section-label {
    background-color: #007bff;
    color: white;
    padding: 2px 6px;
    border-radius: 8px;
    font-size: 0.75rem;
    margin-right: 6px;
}

.keyword-tag .remove-btn {
    margin-left: 6px;
    color: #dc3545;
    cursor: pointer;
    font-weight: bold;
}

.keyword-tag .remove-btn:hover {
    color: #c82333;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentScreeningId = null;
    let currentKeywords = [];

    // Cache to prevent duplicate API calls
    const keywordCache = new Map();
    const loadingStates = new Set();

    // Keyword management functionality
    class KeywordManager {
        constructor(prefix) {
            this.prefix = prefix;
            this.keywords = [];
            this.setupEventListeners();
        }

        setupEventListeners() {
            const addBtn = document.getElementById(this.prefix + 'KeywordBtn');
            const input = document.getElementById(this.prefix + 'KeywordInput');

            if (addBtn) {
                addBtn.addEventListener('click', () => this.addKeyword());
            }

            if (input) {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.addKeyword();
                    }
                });
            }
        }

        addKeyword() {
            const input = document.getElementById(this.prefix + 'KeywordInput');
            const sectionSelect = document.getElementById(this.prefix + 'SectionSelect');

            const keyword = input.value.trim();
            const section = sectionSelect.value;

            if (!keyword) return;

            // Check for duplicates
            const exists = this.keywords.some(k => 
                k.keyword.toLowerCase() === keyword.toLowerCase() && k.section === section
            );

            if (exists) {
                alert('This keyword already exists for this section');
                return;
            }

            // Add keyword
            this.keywords.push({
                keyword: keyword,
                section: section,
                weight: 1.0,
                case_sensitive: false,
                exact_match: false,
                description: ''
            });

            input.value = '';
            this.renderKeywords();
            this.updateHiddenField();
        }

        removeKeyword(index) {
            this.keywords.splice(index, 1);
            this.renderKeywords();
            this.updateHiddenField();
        }

        renderKeywords() {
            const container = document.getElementById(this.prefix + 'KeywordsList');
            if (!container) return;

            // Clear container completely
            container.innerHTML = '';

            // Only render if we have keywords
            if (!this.keywords || this.keywords.length === 0) {
                return;
            }

            // Final duplicate protection - convert everything to strings and remove duplicates
            const stringKeywords = this.keywords.map(k => 
                typeof k === 'string' ? k.trim() : (k.keyword || '').trim()
            ).filter(k => k.length > 0);

            const uniqueKeywords = [...new Set(stringKeywords.map(k => k.toLowerCase()))].map(k => 
                stringKeywords.find(orig => orig.toLowerCase() === k)
            );

            // Update internal array to ensure consistency
            this.keywords = uniqueKeywords;

            // Render each unique keyword
            uniqueKeywords.forEach((keyword, index) => {
                const keywordElement = document.createElement('span');
                keywordElement.className = 'badge bg-secondary me-2 mb-2';
                keywordElement.innerHTML = `
                    ${keyword}
                    <button type="button" class="btn-close btn-close-white ms-1" style="font-size: 0.75em;" onclick="${this.prefix}KeywordManager.removeKeyword(${index})"></button>
                `;
                container.appendChild(keywordElement);
            });
        }

        updateHiddenField() {
            const hiddenField = document.getElementById(this.prefix + 'KeywordsData');
            if (hiddenField) {
                // For form submission, use the field name expected by the backend
                const fieldName = this.prefix === 'add' ? 'keywords' : 'keywords';
                const actualField = document.querySelector(`input[name="${fieldName}"]`) || hiddenField;

                // Send just the keyword strings (they're already strings now)
                try {
                    actualField.value = JSON.stringify(this.keywords || []);
                } catch (e) {
                    console.error('Error stringifying keywords:', e);
                    actualField.value = '[]';
                }
            }
        }

        setKeywords(keywords) {
            // Only use setKeywords for add/manage modals, not edit
            if (this.prefix === 'edit') {
                console.log(`${this.prefix} setKeywords: skipping for edit modal to prevent duplication`);
                return;
            }

            // Complete reset first
            this.keywords = [];

            const container = document.getElementById(this.prefix + 'KeywordsList');
            const hiddenField = document.getElementById(this.prefix + 'KeywordsData');

            if (container) {
                container.innerHTML = '';
            }
            if (hiddenField) {
                hiddenField.value = '[]';
            }

            // Only process if we have valid, non-empty keywords
            if (!keywords || !Array.isArray(keywords) || keywords.length === 0) {
                console.log(`${this.prefix} setKeywords: no keywords provided, staying empty`);
                return;
            }

            // Simple conversion to strings with deduplication
            const stringKeywords = [];
            const seen = new Set();

            for (const k of keywords) {
                let keywordText = '';
                if (typeof k === 'string') {
                    keywordText = k.trim();
                } else if (k && typeof k === 'object' && k.keyword) {
                    keywordText = k.keyword.trim();
                }

                if (keywordText && !seen.has(keywordText.toLowerCase())) {
                    stringKeywords.push(keywordText);
                    seen.add(keywordText.toLowerCase());
                }
            }

            this.keywords = stringKeywords;
            console.log(`${this.prefix} setKeywords: set ${stringKeywords.length} unique keywords`);

            this.renderKeywords();
            this.updateHiddenField();
        }
    }

    // Initialize keyword managers
    window.keywordManagers = {
        'add': new KeywordManager('add'),
        'edit': new KeywordManager('edit'),
        'manage': new KeywordManager('manage')
    };

    // Add Enter key support for edit modal keyword input
    document.addEventListener('keypress', function(e) {
        if (e.target.id === 'editKeywordInput' && e.key === 'Enter') {
            e.preventDefault();
            addEditModalKeyword();
        }
    });

    // Cached keyword loading function to prevent duplicate API calls
    function loadKeywordDisplaysOnDemand() {
        document.querySelectorAll('.keyword-tags').forEach(container => {
            const screeningElement = container.closest('[data-screening-id]');
            if (screeningElement) {
                const screeningId = screeningElement.getAttribute('data-screening-id');

                // Skip if already loaded or currently loading
                if (keywordCache.has(screeningId) || loadingStates.has(screeningId)) {
                    if (keywordCache.has(screeningId)) {
                        displayCachedKeywords(container, keywordCache.get(screeningId));
                    }
                    return;
                }

                // Mark as loading
                loadingStates.add(screeningId);
                container.innerHTML = '<small class="text-muted">Loading...</small>';

                // Load keywords for this specific screening
                fetch(`/api/screening-keywords/${screeningId}`)
                    .then(response => response.json())
                    .then(data => {
                        // Cache the result
                        const keywords = data.success && data.keywords ? data.keywords : [];
                        keywordCache.set(screeningId, keywords);

                        // Display keywords
                        displayCachedKeywords(container, keywords);
                    })
                    .catch(error => {
                        console.error(`Error loading keywords for display (screening ${screeningId}):`, error);
                        container.innerHTML = '<small class="text-muted">Click edit to manage keywords</small>';
                        keywordCache.set(screeningId, []); // Cache empty result to prevent retries
                    })
                    .finally(() => {
                        loadingStates.delete(screeningId);
                    });
            }
        });
    }

    // Helper function to display cached keywords
    function displayCachedKeywords(container, keywords) {
        if (keywords && keywords.length > 0) {
            container.innerHTML = '';
            keywords.forEach(keyword => {
                const badge = document.createElement('span');
                badge.className = 'badge bg-secondary me-1 mb-1';
                badge.textContent = keyword;
                container.appendChild(badge);
            });
        } else {
            container.innerHTML = '<small class="text-muted">No keywords set</small>';
        }
    }

    // Function to get keywords for a specific screening (used by edit modal) with caching
    function getKeywordsForScreening(screeningId) {
        // Return cached data if available
        if (keywordCache.has(screeningId)) {
            return Promise.resolve(keywordCache.get(screeningId));
        }

        // Skip if already loading
        if (loadingStates.has(screeningId)) {
            return new Promise((resolve) => {
                // Wait for loading to complete by checking cache periodically
                const checkCache = () => {
                    if (keywordCache.has(screeningId)) {
                        resolve(keywordCache.get(screeningId));
                    } else {
                        setTimeout(checkCache, 100);
                    }
                };
                checkCache();
            });
        }

        // Mark as loading and fetch from API
        loadingStates.add(screeningId);
        return fetch(`/api/screening-keywords/${screeningId}`)
            .then(response => response.json())
            .then(data => {
                const keywords = data.success && data.keywords ? data.keywords : [];
                keywordCache.set(screeningId, keywords);
                return keywords;
            })
            .catch(error => {
                console.error('Error loading keywords:', error);
                keywordCache.set(screeningId, []); // Cache empty result
                return [];
            })
            .finally(() => {
                loadingStates.delete(screeningId);
            });
    }

    // Keywords will be loaded on demand when needed
    // Removed automatic initialization to prevent duplication

    // Handle manage keywords button clicks
    document.querySelectorAll('.manage-keywords-btn').forEach(button => {
        button.addEventListener('click', function() {
            currentScreeningId = this.getAttribute('data-screening-id');
            const screeningName = this.getAttribute('data-screening-name');

            document.getElementById('modalScreeningName').textContent = screeningName;

            // Reset manage modal keywords
            manageModalKeywords = [];
            document.getElementById('manageKeywordsList').innerHTML = '';

            // Load keywords from API
            console.log(`Loading keywords for manage modal (screening ${currentScreeningId})`);
            
            getKeywordsForScreening(currentScreeningId).then(keywordsToLoad => {
                console.log(`Loaded ${keywordsToLoad.length} keywords for manage modal`);
                
                // Set keywords ensuring they're strings
                manageModalKeywords = keywordsToLoad.filter(k => k && typeof k === 'string').map(k => k.trim());
                renderManageModalKeywords();
            }).catch(error => {
                console.error('Error loading keywords for manage modal:', error);
                manageModalKeywords = [];
                renderManageModalKeywords();
            });

            const modal = new bootstrap.Modal(document.getElementById('keywordManagementModal'));
            modal.show();
        });
    });

    // Handle save keywords button
    document.getElementById('saveKeywordsBtn').addEventListener('click', function() {
        if (!currentScreeningId) return;

        // Remove duplicates from manageModalKeywords before saving
        const uniqueKeywords = [...new Set(manageModalKeywords.map(k => k.toLowerCase()))].map(k => 
            manageModalKeywords.find(orig => orig.toLowerCase() === k)
        );

        // Save to server
        fetch(`/api/screening-keywords/${currentScreeningId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ keywords: uniqueKeywords })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update cache with new keywords
                keywordCache.set(currentScreeningId, uniqueKeywords);

                // Update the specific display
                const container = document.querySelector(`[data-screening-id="${currentScreeningId}"] .keyword-tags`);
                if (container) {
                    displayCachedKeywords(container, uniqueKeywords);
                }

                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('keywordManagementModal'));
                modal.hide();

                // Show success message
                showAlert('Keywords saved successfully', 'success');
            } else {
                showAlert('Error saving keywords: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error saving keywords:', error);
            showAlert('Error saving keywords', 'danger');
        });
    });

    // Load keyword displays on demand when page loads (only once)
    setTimeout(loadKeywordDisplaysOnDemand, 500);

    // Utility function to show alerts
    function showAlert(message, type) {
        const alertContainer = document.querySelector('.container');
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        alertContainer.insertBefore(alert, alertContainer.firstChild);

        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 5000);
    }

    // Fresh edit modal implementation - completely isolated from other keyword systems
    let editModalKeywords = [];

    // Simple function to render edit modal keywords
    function renderEditModalKeywords() {
        const container = document.getElementById('editKeywordsList');
        const hiddenField = document.getElementById('editKeywordsData');

        if (!container) return;

        // Clear completely
        container.innerHTML = '';

        // Render each keyword as a badge
        editModalKeywords.forEach((keyword, index) => {
            const badge = document.createElement('span');
            badge.className = 'badge bg-secondary me-2 mb-2';
            badge.innerHTML = `
                ${keyword}
                <button type="button" class="btn-close btn-close-white ms-1" style="font-size: 0.75em;" 
                        onclick="removeEditModalKeyword(${index})" aria-label="Remove"></button>
            `;
            container.appendChild(badge);
        });

        // Update hidden field
        if (hiddenField) {
            hiddenField.value = JSON.stringify(editModalKeywords);
        }
    }

    // Function to remove keyword from edit modal
    window.removeEditModalKeyword = function(index) {
        editModalKeywords.splice(index, 1);
        renderEditModalKeywords();
    };

    // Function to add keyword to edit modal with comprehensive duplicate prevention
    window.addEditModalKeyword = function() {
        const input = document.getElementById('editKeywordInput');
        const keyword = input.value.trim();

        if (!keyword) {
            console.log('Empty keyword attempted, ignoring');
            return;
        }

        // Ensure editModalKeywords is always an array
        if (!Array.isArray(editModalKeywords)) {
            editModalKeywords = [];
        }

        // Triple-check for duplicates with comprehensive validation
        const lowerKeyword = keyword.toLowerCase();

        // Check 1: Exact match
        if (editModalKeywords.includes(keyword)) {
            alert('This exact keyword already exists.');
            input.focus();
            return;
        }

        // Check 2: Case-insensitive match
        const hasCaseInsensitiveDuplicate = editModalKeywords.some(k => 
            k && typeof k === 'string' && k.toLowerCase() === lowerKeyword
        );

        if (hasCaseInsensitiveDuplicate) {
            alert('A keyword with this text already exists (case-insensitive match).');
            input.focus();
            return;
        }

        // Check 3: Verify array integrity before adding
        const currentLength = editModalKeywords.length;
        editModalKeywords.push(keyword);

        // Check 4: Verify addition was successful and no duplicates created
        const newLength = editModalKeywords.length;
        if (newLength !== currentLength + 1) {
            console.error('Keyword array manipulation error detected');
            editModalKeywords = editModalKeywords.filter((k, i, arr) => arr.indexOf(k) === i); // Emergency dedup
        }

        input.value = '';
        renderEditModalKeywords();

        console.log(`Successfully added keyword: "${keyword}". Total keywords: ${editModalKeywords.length}`);
    };

    // Handle edit button clicks with completely fresh implementation
    document.querySelectorAll('.edit-screening-btn').forEach(button => {
        button.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            const name = this.getAttribute('data-name');
            const frequencyNumber = this.getAttribute('data-frequency-number');
            const frequencyUnit = this.getAttribute('data-frequency-unit');
            const gender = this.getAttribute('data-gender');
            const minAge = this.getAttribute('data-min-age');
            const maxAge = this.getAttribute('data-max-age');
            const active = this.getAttribute('data-active');

            // Update form action URL
            document.getElementById('editScreeningForm').action = "{{ url_for('edit_screening_type', screening_type_id=0) }}".replace("0", id);

            // Populate form fields
            document.querySelector('#editScreeningForm #name').value = name;
            document.querySelector('#editScreeningForm #frequency_number').value = frequencyNumber;
            document.querySelector('#editScreeningForm #frequency_unit').value = frequencyUnit;
            document.querySelector('#editScreeningForm #gender_specific').value= gender;
            document.querySelector('#editScreeningForm #min_age').value = minAge;
            document.querySelector('#editScreeningForm #max_age').value = maxAge;
            document.querySelector('#editScreeningForm #is_active').checked = active === "checked";

            // Reset edit modal keywords completely
            editModalKeywords = [];
            document.getElementById('editKeywordsList').innerHTML = '';
            document.getElementById('editKeywordsData').value = '[]';

            // Load keywords with fresh API call
            console.log(`Loading keywords for edit modal (screening ${id})`);
            fetch(`/api/screening-keywords/${id}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.keywords && Array.isArray(data.keywords)) {
                        // Simple string filtering and deduplication
                        const cleanKeywords = data.keywords
                            .filter(k => k && typeof k === 'string' && k.trim())
                            .map(k => k.trim())
                            .filter((k, i, arr) => arr.indexOf(k) === i); // Remove duplicates

                        editModalKeywords = cleanKeywords;
                        console.log(`Edit modal: loaded ${cleanKeywords.length} unique keywords`);
                        renderEditModalKeywords();
                    } else {
                        console.log(`Edit modal: no keywords found for screening ${id}`);
                        editModalKeywords = [];
                        renderEditModalKeywords();
                    }
                })
                .catch(error => {
                    console.error('Edit modal keyword load error:', error);
                    editModalKeywords = [];
                    renderEditModalKeywords();
                });
        });
    });

    // Handle delete button clicks
    document.querySelectorAll('.delete-screening-btn').forEach(button => {
        button.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            const name = this.getAttribute('data-name');

            // Update form action URL
            document.getElementById('deleteScreeningForm').action = "{{ url_for('delete_screening_type', screening_type_id=0) }}".replace("0", id);

            // Update modal text
            document.getElementById('deleteScreeningName').textContent = name;
        });
    });
    // Note: Individual keyword loading removed - keywords are now loaded via bulk API
    // and displayed by the updateKeywordDisplay() function called from loadAllKeywordsBulk()

});
</script>

<script>
// Manage modal keyword management
let manageModalKeywords = [];

// Function to add keyword to manage modal
function addManageModalKeyword() {
    const keywordInput = document.getElementById('manageKeywordInput');
    const keyword = keywordInput.value.trim();

    if (!keyword) {
        return;
    }

    // Check for duplicates (case-insensitive)
    const isDuplicate = manageModalKeywords.some(k => k.toLowerCase() === keyword.toLowerCase());
    
    if (isDuplicate) {
        alert('Keyword already exists.');
        keywordInput.focus();
        return;
    }

    // Add to array
    manageModalKeywords.push(keyword);
    
    // Clear input
    keywordInput.value = '';
    
    // Re-render keywords
    renderManageModalKeywords();
}

// Function to remove keyword from manage modal
function removeManageModalKeyword(index) {
    manageModalKeywords.splice(index, 1);
    renderManageModalKeywords();
}

// Function to render manage modal keywords
function renderManageModalKeywords() {
    const container = document.getElementById('manageKeywordsList');
    if (!container) return;

    container.innerHTML = '';

    manageModalKeywords.forEach((keyword, index) => {
        const badge = document.createElement('span');
        badge.className = 'badge bg-secondary me-2 mb-2';
        badge.innerHTML = `
            ${keyword}
            <button type="button" class="btn-close btn-close-white ms-1" style="font-size: 0.75em;" 
                    onclick="removeManageModalKeyword(${index})" aria-label="Remove"></button>
        `;
        container.appendChild(badge);
    });
}

</script>
{% endblock %}