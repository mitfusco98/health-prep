{% extends "base_demo.html" %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Screening Types Management</h1>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addScreeningTypeModal">
            <i class="fas fa-plus me-1"></i> Add New Screening Type
        </button>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">Available Screening Types</h5>
        </div>
        <div class="card-body">
            {% if screening_types %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Name & Keywords</th>
                                <th>Frequency</th>
                                <th>Gender Specific</th>
                                <th>Age Range</th>
                                <th>Status</th>
                                <th width="150">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for screening_type in screening_types %}
                                <tr>
                                    <td>
                                        <div class="d-flex justify-content-between align-items-start">
                                            <div class="flex-grow-1">
                                                <strong>{{ screening_type.name }}</strong>
                                                <div class="keyword-tags mt-2" id="keywords-{{ screening_type.id }}" data-screening-id="{{ screening_type.id }}">
                                                    <small class="text-muted">Loading keywords...</small>
                                                </div>
                                            </div>
                                            <button type="button" class="btn btn-sm btn-outline-primary ms-2 manage-keywords-btn" 
                                                    data-screening-id="{{ screening_type.id }}"
                                                    data-screening-name="{{ screening_type.name }}">
                                                <i class="fas fa-tags me-1"></i>Keywords
                                            </button>
                                        </div>
                                    </td>
                                    <td>{{ screening_type.formatted_frequency }}</td>
                                    <td>
                                        {% if screening_type.gender_specific %}
                                            {{ screening_type.gender_specific }}
                                        {% else %}
                                            All Genders
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if screening_type.min_age and screening_type.max_age %}
                                            Ages {{ screening_type.min_age }} to {{ screening_type.max_age }}
                                        {% elif screening_type.min_age %}
                                            Age {{ screening_type.min_age }}+
                                        {% elif screening_type.max_age %}
                                            Up to age {{ screening_type.max_age }}
                                        {% else %}
                                            All Ages
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if screening_type.is_active %}
                                            <span class="badge bg-success">Active</span>
                                        {% else %}
                                            <span class="badge bg-secondary">Inactive</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <button type="button" class="btn btn-sm btn-outline-primary edit-screening-btn" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#editScreeningTypeModal"
                                                data-id="{{ screening_type.id }}"
                                                data-name="{{ screening_type.name }}"
                                                data-description=""
                                                data-frequency-number="{{ screening_type.frequency_number or '' }}"
                                                data-frequency-unit="{{ screening_type.frequency_unit or '' }}"
                                                data-gender="{{ screening_type.gender_specific or '' }}"
                                                data-min-age="{{ screening_type.min_age or '' }}"
                                                data-max-age="{{ screening_type.max_age or '' }}"
                                                data-active="{{ 'checked' if screening_type.is_active else '' }}">
                                            Edit
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-danger delete-screening-btn"
                                                data-bs-toggle="modal" 
                                                data-bs-target="#deleteScreeningTypeModal"
                                                data-id="{{ screening_type.id }}"
                                                data-name="{{ screening_type.name }}">
                                            Delete
                                        </button>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i> No screening types have been defined yet. Use the "Add New Screening Type" button to create one.
                </div>
            {% endif %}
        </div>
    </div>

    <div class="card">
        <div class="card-header bg-light">
            <h5 class="mb-0">About Screening Types</h5>
        </div>
        <div class="card-body">
            <p>Screening types define the preventive health screenings that will appear on patient prep sheets. 
               You can customize which screenings appear based on patient age, gender, and other factors.</p>

            <h6>Important Notes:</h6>
            <ul>
                <li>Screenings will only appear for patients matching the specified criteria.</li>
                <li>Inactive screenings will not appear on prep sheets but are preserved in the database.</li>
                <li>If a screening is used by existing patients, it cannot be completely deleted, only deactivated.</li>
            </ul>
        </div>
    </div>
</div>

<!-- Add Screening Type Modal -->
<div class="modal fade" id="addScreeningTypeModal" tabindex="-1" aria-labelledby="addScreeningTypeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addScreeningTypeModalLabel">Add New Screening Type</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('add_screening_type') }}">
                <div class="modal-body">
                    {{ add_form.hidden_tag() }}

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="form-group">
                                {{ add_form.name.label(class="form-label") }}
                                {{ add_form.name(class="form-control") }}
                                <small class="form-text text-muted">{{ add_form.name.description }}</small>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label">Frequency</label>
                            <div class="row">
                                <div class="col-md-4">
                                    {{ add_form.frequency_number(class="form-control", placeholder="1") }}
                                    <small class="form-text text-muted">Number</small>
                                </div>
                                <div class="col-md-8">
                                    {{ add_form.frequency_unit(class="form-select") }}
                                    <small class="form-text text-muted">Time unit</small>
                                </div>
                            </div>
                            <small class="form-text text-muted">Set how often this screening should be performed</small>
                        </div>
                    </div>

                    <div class="form-group mb-3">
                        <label class="form-label">Document Keywords</label>
                        <div class="keyword-input-container">
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" id="addKeywordInput" placeholder="Enter keyword (e.g., 'mammogram', 'glucose')">
                                <select class="form-select" id="addSectionSelect" style="max-width: 150px;">
                                    <option value="labs">Labs</option>
                                    <option value="imaging">Imaging</option>
                                    <option value="procedures">Procedures</option>
                                    <option value="vitals">Vitals</option>
                                    <option value="consults">Consults</option>
                                    <option value="medications">Medications</option>
                                    <option value="general" selected>General</option>
                                </select>
                                <button type="button" class="btn btn-outline-primary" id="addKeywordBtn">
                                    <i class="fas fa-plus"></i> Add
                                </button>
                            </div>
                            <div id="addKeywordsList" class="keywords-display mb-2">
                                <!-- Keywords will appear here as tags -->
                            </div>
                            <input type="hidden" name="keywords" id="addKeywordsData">
                        </div>
                        <small class="form-text text-muted">Define keywords to help identify documents related to this screening. Keywords will be used for document matching when FHIR codes are not available.</small>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="form-group">
                                {{ add_form.gender_specific.label(class="form-label") }}
                                {{ add_form.gender_specific(class="form-select") }}
                                <small class="form-text text-muted">{{ add_form.gender_specific.description }}</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                {{ add_form.min_age.label(class="form-label") }}
                                {{ add_form.min_age(class="form-control") }}
                                <small class="form-text text-muted">{{ add_form.min_age.description }}</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                {{ add_form.max_age.label(class="form-label") }}
                                {{ add_form.max_age(class="form-control") }}
                                <small class="form-text text-muted">{{ add_form.max_age.description }}</small>
                            </div>
                        </div>
                    </div>

                    <div class="form-check mb-3">
                        {{ add_form.is_active(class="form-check-input") }}
                        {{ add_form.is_active.label(class="form-check-label") }}
                        <div><small class="form-text text-muted">{{ add_form.is_active.description }}</small></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    {{ add_form.submit(class="btn btn-primary") }}
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Screening Type Modal -->
<div class="modal fade" id="editScreeningTypeModal" tabindex="-1" aria-labelledby="editScreeningTypeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editScreeningTypeModalLabel">Edit Screening Type</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('edit_screening_type', screening_type_id=0) }}" id="editScreeningForm">
                <div class="modal-body">
                    {{ edit_form.hidden_tag() }}

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="form-group">
                                {{ edit_form.name.label(class="form-label") }}
                                {{ edit_form.name(class="form-control") }}
                                <small class="form-text text-muted">{{ edit_form.name.description }}</small>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label">Frequency</label>
                            <div class="row">
                                <div class="col-md-4">
                                    {{ edit_form.frequency_number(class="form-control", placeholder="1") }}
                                    <small class="form-text text-muted">Number</small>
                                </div>
                                <div class="col-md-8">
                                    {{ edit_form.frequency_unit(class="form-select") }}
                                    <small class="form-text text-muted">Time unit</small>
                                </div>
                            </div>
                            <small class="form-text text-muted">Set how often this screening should be performed</small>
                        </div>
                    </div>

                    <div class="form-group mb-3">
                        <label class="form-label">Document Keywords</label>
                        <div class="keyword-input-container">
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" id="editKeywordInput" placeholder="Enter keyword (e.g., 'mammogram', 'glucose')">
                                <select class="form-select" id="editSectionSelect" style="max-width: 150px;">
                                    <option value="labs">Labs</option>
                                    <option value="imaging">Imaging</option>
                                    <option value="procedures">Procedures</option>
                                    <option value="vitals">Vitals</option>
                                    <option value="consults">Consults</option>
                                    <option value="medications">Medications</option>
                                    <option value="general" selected>General</option>
                                </select>
                                <button type="button" class="btn btn-outline-primary" id="editKeywordBtn">
                                    <i class="fas fa-plus"></i> Add
                                </button>
                            </div>
                            <div id="editKeywordsList" class="keywords-display mb-2">
                                <!-- Keywords will appear here as tags -->
                            </div>
                            <input type="hidden" name="keywords" id="editKeywordsData">
                        </div>
                        <small class="form-text text-muted">Define keywords to help identify documents related to this screening. Keywords will be used for document matching when FHIR codes are not available.</small>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <div class="form-group">
                                {{ edit_form.gender_specific.label(class="form-label") }}
                                {{ edit_form.gender_specific(class="form-select") }}
                                <small class="form-text text-muted">{{ edit_form.gender_specific.description }}</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                {{ edit_form.min_age.label(class="form-label") }}
                                {{ edit_form.min_age(class="form-control") }}
                                <small class="form-text text-muted">{{ edit_form.min_age.description }}</small>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                {{ edit_form.max_age.label(class="form-label") }}
                                {{ edit_form.max_age(class="form-control") }}
                                <small class="form-text text-muted">{{ edit_form.max_age.description }}</small>
                            </div>
                        </div>
                    </div>

                    <div class="form-check mb-3">
                        {{ edit_form.is_active(class="form-check-input") }}
                        {{ edit_form.is_active.label(class="form-check-label") }}
                        <div><small class="form-text text-muted">{{ edit_form.is_active.description }}</small></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    {{ edit_form.submit(class="btn btn-primary") }}
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Screening Type Modal -->
<div class="modal fade" id="deleteScreeningTypeModal" tabindex="-1" aria-labelledby="deleteScreeningTypeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteScreeningTypeModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the screening type <strong id="deleteScreeningName"></strong>?</p>
                <p class="text-danger">This action cannot be undone. If this screening is used by any patients, it will be marked as inactive instead of being deleted.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form method="POST" action="{{ url_for('delete_screening_type', screening_type_id=0) }}" id="deleteScreeningForm">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Keyword Management Modal -->
<div class="modal fade" id="keywordManagementModal" tabindex="-1" aria-labelledby="keywordManagementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="keywordManagementModalLabel">Manage Keywords for <span id="modalScreeningName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Keywords help identify documents related to this screening type. They're used when FHIR codes aren't available.
                </div>

                <div class="keyword-input-container">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="manageKeywordInput" placeholder="Enter keyword (e.g., 'mammogram', 'glucose')">
                        <select class="form-select" id="manageSectionSelect" style="max-width: 150px;">
                            <option value="labs">Labs</option>
                            <option value="imaging">Imaging</option>
                            <option value="procedures">Procedures</option>
                            <option value="vitals">Vitals</option>
                            <option value="consults">Consults</option>
                            <option value="medications">Medications</option>
                            <option value="general" selected>General</option>
                        </select>
                        <button type="button" class="btn btn-primary" id="manageAddKeywordBtn">
                            <i class="fas fa-plus"></i> Add Keyword
                        </button>
                    </div>

                    <div id="manageKeywordsList" class="keywords-display">
                        <!-- Keywords will appear here as removable tags -->
                    </div>
                </div>

                <div class="mt-4">
                    <h6>Common Keywords by Section:</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Labs:</strong> glucose, cholesterol, hemoglobin, hba1c, creatinine<br>
                            <strong>Imaging:</strong> mammogram, x-ray, ct scan, mri, ultrasound<br>
                            <strong>Procedures:</strong> colonoscopy, biopsy, endoscopy
                        </div>
                        <div class="col-md-6">
                            <strong>Vitals:</strong> blood pressure, heart rate, weight, height<br>
                            <strong>Consults:</strong> cardiology, oncology, neurology<br>
                            <strong>Medications:</strong> insulin, metformin, lisinopril
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveKeywordsBtn">Save Keywords</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
.keywords-display {
    min-height: 60px;
    border: 1px dashed #ccc;
    border-radius: 4px;
    padding: 10px;
}

.keyword-tag {
    display: inline-block;
    background-color: #e9ecef;
    border: 1px solid #ced4da;
    border-radius: 15px;
    padding: 4px 12px;
    margin: 2px;
    font-size: 0.875rem;
}

.keyword-tag .section-label {
    background-color: #007bff;
    color: white;
    padding: 2px 6px;
    border-radius: 8px;
    font-size: 0.75rem;
    margin-right: 6px;
}

.keyword-tag .remove-btn {
    margin-left: 6px;
    color: #dc3545;
    cursor: pointer;
    font-weight: bold;
}

.keyword-tag .remove-btn:hover {
    color: #c82333;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let currentScreeningId = null;
    let currentKeywords = [];

    // Keyword management functionality
    class KeywordManager {
        constructor(prefix) {
            this.prefix = prefix;
            this.keywords = [];
            this.setupEventListeners();
        }

        setupEventListeners() {
            const addBtn = document.getElementById(this.prefix + 'KeywordBtn');
            const input = document.getElementById(this.prefix + 'KeywordInput');

            if (addBtn) {
                addBtn.addEventListener('click', () => this.addKeyword());
            }

            if (input) {
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.addKeyword();
                    }
                });
            }
        }

        addKeyword() {
            const input = document.getElementById(this.prefix + 'KeywordInput');
            const sectionSelect = document.getElementById(this.prefix + 'SectionSelect');

            const keyword = input.value.trim();
            const section = sectionSelect.value;

            if (!keyword) return;

            // Check for duplicates
            const exists = this.keywords.some(k => 
                k.keyword.toLowerCase() === keyword.toLowerCase() && k.section === section
            );

            if (exists) {
                alert('This keyword already exists for this section');
                return;
            }

            // Add keyword
            this.keywords.push({
                keyword: keyword,
                section: section,
                weight: 1.0,
                case_sensitive: false,
                exact_match: false,
                description: ''
            });

            input.value = '';
            this.renderKeywords();
            this.updateHiddenField();
        }

        removeKeyword(index) {
            this.keywords.splice(index, 1);
            this.renderKeywords();
            this.updateHiddenField();
        }

        renderKeywords() {
            const container = document.getElementById(this.prefix + 'KeywordsList');
            if (!container) return;

            // Clear container completely
            container.innerHTML = '';

            // Only render if we have keywords
            if (!this.keywords || this.keywords.length === 0) {
                return;
            }

            // Final duplicate protection - convert everything to strings and remove duplicates
            const stringKeywords = this.keywords.map(k => 
                typeof k === 'string' ? k.trim() : (k.keyword || '').trim()
            ).filter(k => k.length > 0);

            const uniqueKeywords = [...new Set(stringKeywords.map(k => k.toLowerCase()))].map(k => 
                stringKeywords.find(orig => orig.toLowerCase() === k)
            );

            // Update internal array to ensure consistency
            this.keywords = uniqueKeywords;

            // Render each unique keyword
            uniqueKeywords.forEach((keyword, index) => {
                const keywordElement = document.createElement('span');
                keywordElement.className = 'badge bg-secondary me-2 mb-2';
                keywordElement.innerHTML = `
                    ${keyword}
                    <button type="button" class="btn-close btn-close-white ms-1" style="font-size: 0.75em;" onclick="${this.prefix}KeywordManager.removeKeyword(${index})"></button>
                `;
                container.appendChild(keywordElement);
            });
        }

        updateHiddenField() {
            const hiddenField = document.getElementById(this.prefix + 'KeywordsData');
            if (hiddenField) {
                // For form submission, use the field name expected by the backend
                const fieldName = this.prefix === 'add' ? 'keywords' : 'keywords';
                const actualField = document.querySelector(`input[name="${fieldName}"]`) || hiddenField;

                // Send just the keyword strings (they're already strings now)
                try {
                    actualField.value = JSON.stringify(this.keywords || []);
                } catch (e) {
                    console.error('Error stringifying keywords:', e);
                    actualField.value = '[]';
                }
            }
        }

        setKeywords(keywords) {
            // Force immediate clear of everything
            this.keywords = [];

            // Clear DOM immediately
            const container = document.getElementById(this.prefix + 'KeywordsList');
            if (container) {
                container.innerHTML = '';
            }

            // Clear hidden field immediately  
            const hiddenField = document.getElementById(this.prefix + 'KeywordsData');
            if (hiddenField) {
                hiddenField.value = '';
            }

            // Only process if we have valid keywords
            if (keywords && Array.isArray(keywords) && keywords.length > 0) {
                // Convert to simple strings, remove duplicates case-insensitively
                const processedKeywords = keywords.map(k => {
                    if (typeof k === 'string') {
                        return k.trim();
                    } else if (k && typeof k === 'object' && k.keyword) {
                        return k.keyword.trim();
                    }
                    return '';
                }).filter(k => k.length > 0);

                // Remove duplicates case-insensitively but preserve original case
                const uniqueKeywords = [];
                const seenLower = new Set();

                for (const keyword of processedKeywords) {
                    const lowerKeyword = keyword.toLowerCase();
                    if (!seenLower.has(lowerKeyword)) {
                        uniqueKeywords.push(keyword);
                        seenLower.add(lowerKeyword);
                    }
                }

                this.keywords = uniqueKeywords;
                console.log(`${this.prefix} setKeywords: processed ${keywords.length} -> ${uniqueKeywords.length} unique keywords`);
            }

            // Render immediately without delay
            this.renderKeywords();
            this.updateHiddenField();
        }
    }

    // Initialize keyword managers
    window.keywordManagers = {
        'add': new KeywordManager('add'),
        'edit': new KeywordManager('edit'),
        'manage': new KeywordManager('manage')
    };

    // Global storage for bulk-loaded keywords
    let bulkKeywordsData = {};

    // In-memory keyword cache
    const keywordCache = new Map();

    // Function to load all keywords in bulk
    function loadAllKeywordsBulk() {
        fetch('/api/screening-keywords/bulk')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    bulkKeywordsData = data.data;
                    // Cache the bulk data
                    Object.keys(bulkKeywordsData).forEach(screeningId => {
                        keywordCache.set(screeningId, { keywords: bulkKeywordsData[screeningId].keywords });
                    });
                    // Update all keyword displays
                    Object.keys(bulkKeywordsData).forEach(screeningId => {
                        updateKeywordDisplay(screeningId, bulkKeywordsData[screeningId]);
                    });
                } else {
                    console.error('Error loading bulk keywords:', data.error);
                    // Fallback to showing placeholder text
                    document.querySelectorAll('.keyword-tags').forEach(container => {
                        container.innerHTML = '<small class="text-muted">Click edit to manage keywords</small>';
                    });
                }
            })
            .catch(error => {
                console.error('Error loading bulk keywords:', error);
                // Fallback to showing placeholder text
                document.querySelectorAll('.keyword-tags').forEach(container => {
                    container.innerHTML = '<small class="text-muted">Click edit to manage keywords</small>';
                });
            });
    }

    // Function to update keyword display for a specific screening
    function updateKeywordDisplay(screeningId, keywordData) {
        const container = document.querySelector(`[data-screening-id="${screeningId}"] .keyword-tags`);
        if (!container) return;

        if (keywordData.keywords && keywordData.keywords.length > 0) {
            displayKeywordsAsBadges(container, keywordData.keywords);
        } else {
            container.innerHTML = '<small class="text-muted">No keywords set</small>';
        }
    }

    // Function to load keywords for display (fallback for individual requests)
    function loadKeywordsForDisplay(screeningId) {
        // First check if we have bulk data
        if (bulkKeywordsData[screeningId]) {
            updateKeywordDisplay(screeningId, bulkKeywordsData[screeningId]);
            return;
        }

        const container = document.querySelector(`[data-screening-id="${screeningId}"] .keyword-tags`);
        if (!container) return;

        // Show loading state
        container.innerHTML = '<small class="text-muted">Loading keywords...</small>';

        fetch(`/api/screening-keywords/${screeningId}`)
            .then(response => {
                if (response.status === 429) {
                    // Rate limited, show fallback message
                    container.innerHTML = '<small class="text-muted">Keywords available - click edit to manage</small>';
                    return null;
                }
                return response.json();
            })
            .then(data => {
                if (!data) return; // Rate limited case

                if (data.success && data.keywords && data.keywords.length > 0) {
                    displayKeywordsAsBadges(container, data.keywords);
                } else {
                    container.innerHTML = '<small class="text-muted">No keywords set</small>';
                }
            })
            .catch(error => {
                console.error('Error loading keywords:', error);
                container.innerHTML = '<small class="text-muted">Error loading keywords</small>';
            });
    }

    // Function to display keywords as badges
    function displayKeywordsAsBadges(container, keywords) {
        container.innerHTML = '';
        if (keywords && keywords.length > 0) {
            keywords.forEach(keyword => {
                const badge = document.createElement('span');
                badge.className = 'badge bg-secondary me-1 mb-1';
                badge.textContent = keyword;
                container.appendChild(badge);
            });
        } else {
            container.innerHTML = '<small class="text-muted">No keywords set</small>';
        }
    }

    // Load all keywords in bulk when the page loads
    loadAllKeywordsBulk();

    // Handle manage keywords button clicks
    document.querySelectorAll('.manage-keywords-btn').forEach(button => {
        button.addEventListener('click', function() {
            currentScreeningId = this.getAttribute('data-screening-id');
            const screeningName = this.getAttribute('data-screening-name');

            document.getElementById('modalScreeningName').textContent = screeningName;
            loadKeywords(currentScreeningId);

            const modal = new bootstrap.Modal(document.getElementById('keywordManagementModal'));
            modal.show();
        });
    });

    // Handle save keywords button
    document.getElementById('saveKeywordsBtn').addEventListener('click', function() {
        if (!currentScreeningId) return;

        const keywords = keywordManagers.manage.keywords;

        // Extract just the keyword strings for saving
        const keywordStrings = keywords.map(k => k.keyword);

        saveKeywords(currentScreeningId, keywordStrings)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the keywords display on the main page
                    updateKeywordsDisplay(currentScreeningId, keywords);

                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('keywordManagementModal'));
                    modal.hide();

                    // Show success message
                    showAlert('Keywords saved successfully', 'success');
                } else {
                    showAlert('Error saving keywords: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error saving keywords:', error);
                showAlert('Error saving keywords', 'danger');
            });
    });

    // Update keywords display on main page
    function updateKeywordsDisplay(screeningId, keywords) {
        const container = document.getElementById(`keywords-${screeningId}`);
        if (!container) return;

        container.innerHTML = '';

        if (keywords.length === 0) {
            container.innerHTML = '<small class="text-muted">No keywords defined</small>';
            return;
        }

        // Group keywords by section
        const bySection = {};
        keywords.forEach(k => {
            if (!bySection[k.section]) bySection[k.section] = [];
            bySection[k.section].push(k.keyword);
        });

        // Display keywords by section
        Object.entries(bySection).forEach(([section, sectionKeywords]) => {
            const badge = document.createElement('span');
            badge.className = 'badge bg-secondary me-1 mb-1';
            badge.innerHTML = `${section}: ${sectionKeywords.slice(0, 3).join(', ')}${sectionKeywords.length > 3 ? '...' : ''}`;
            container.appendChild(badge);
        });
    }

    ```html
// Set default text for keyword containers without loading them automatically        const keywordContainers = document.querySelectorAll('.keyword-tags');
    keywordContainers.forEach(container => {
        container.innerHTML = '<small class="text-muted">Click edit to manage keywords</small>';
    });

    // Utility function to show alerts
    function showAlert(message, type) {
        const alertContainer = document.querySelector('.container');
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show`;
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        alertContainer.insertBefore(alert, alertContainer.firstChild);

        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 5000);
    }

    // Handle edit button clicks with improved keyword loading
    document.querySelectorAll('.edit-screening-btn').forEach(button => {
        button.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            const name = this.getAttribute('data-name');
            const frequencyNumber = this.getAttribute('data-frequency-number');
            const frequencyUnit = this.getAttribute('data-frequency-unit');
            const gender = this.getAttribute('data-gender');
            const minAge = this.getAttribute('data-min-age');
            const maxAge = this.getAttribute('data-max-age');
            const active = this.getAttribute('data-active');

            // Update form action URL
            document.getElementById('editScreeningForm').action = "{{ url_for('edit_screening_type', screening_type_id=0) }}".replace("0", id);

            // Populate form fields
            document.querySelector('#editScreeningForm #name').value = name;
            document.querySelector('#editScreeningForm #frequency_number').value = frequencyNumber;
            document.querySelector('#editScreeningForm #frequency_unit').value = frequencyUnit;
            document.querySelector('#editScreeningForm #gender_specific').value= gender;
            document.querySelector('#editScreeningForm #min_age').value = minAge;
            document.querySelector('#editScreeningForm #max_age').value = maxAge;
            document.querySelector('#editScreeningForm #is_active').checked = active === "checked";

            // Clear the keyword manager completely and immediately
            keywordManagers.edit.keywords = [];

            const editKeywordsList = document.getElementById('editKeywordsList');
            const editKeywordsData = document.getElementById('editKeywordsData');
            if (editKeywordsList) {
                editKeywordsList.innerHTML = '';
            }
            if (editKeywordsData) {
                editKeywordsData.value = '';
            }

            // Load keywords using priority: cache > bulk data > empty
            let keywordsToLoad = [];

            // Check cache first
            if (keywordCache.has(id)) {
                const cachedData = keywordCache.get(id);
                if (cachedData.keywords) {
                    keywordsToLoad = cachedData.keywords;
                    console.log(`Using cached data for screening ${id}: ${keywordsToLoad.length} keywords`);
                }
            }
            // Fallback to bulk data
            else if (bulkKeywordsData[id] && bulkKeywordsData[id].keywords) {
                keywordsToLoad = bulkKeywordsData[id].keywords;
                console.log(`Using bulk data for screening ${id}: ${keywordsToLoad.length} keywords`);
            }

            // Set keywords immediately - no timeout needed
            keywordManagers.edit.setKeywords(keywordsToLoad);
        });
    });

    // Handle delete button clicks
    document.querySelectorAll('.delete-screening-btn').forEach(button => {
        button.addEventListener('click', function() {
            const id = this.getAttribute('data-id');
            const name = this.getAttribute('data-name');

            // Update form action URL
            document.getElementById('deleteScreeningForm').action = "{{ url_for('delete_screening_type', screening_type_id=0) }}".replace("0", id);

            // Update modal text
            document.getElementById('deleteScreeningName').textContent = name;
        });
    });
    // Note: Individual keyword loading removed - keywords are now loaded via bulk API
    // and displayed by the updateKeywordDisplay() function called from loadAllKeywordsBulk()

});
</script>
{% endblock %}