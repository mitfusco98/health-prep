<script>
function handleFileSelection(input) {
    const file = input.files[0];
    const fileInfo = document.getElementById('file-info');

    if (file) {
        const maxSize = 10 * 1024 * 1024; // 10MB
        if (file.size > maxSize) {
            alert('File size must be less than 10MB');
            input.value = '';
            if (fileInfo) {
                fileInfo.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>File too large (${(file.size / 1024 / 1024).toFixed(2)} MB). Maximum size is 10MB.
                    </div>
                `;
            }
            return;
        }

        // Check file type
        const allowedTypes = ['application/pdf', 'text/plain', 'image/jpeg', 'image/png', 'image/jpg'];
        if (!allowedTypes.includes(file.type) && !file.name.match(/\.(pdf|txt|jpg|jpeg|png)$/i)) {
            alert('Please select a valid file type (PDF, TXT, JPG, PNG)');
            input.value = '';
            if (fileInfo) {
                fileInfo.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>Invalid file type. Please select PDF, TXT, JPG, or PNG files.
                    </div>
                `;
            }
            return;
        }

        // Update UI to show file selected
        if (fileInfo) {
            fileInfo.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-file me-2"></i>Selected: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)
                </div>
            `;
        }
    } else {
        if (fileInfo) {
            fileInfo.innerHTML = '';
        }
    }
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Add form submission handler to show loading state
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form[enctype="multipart/form-data"]');
    const submitBtn = document.getElementById('submit-btn');
    const progressDiv = document.getElementById('file-upload-progress');

    if (form && submitBtn) {
        form.addEventListener('submit', function(e) {
            // Show loading state
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Uploading...';

            if (progressDiv) {
                progressDiv.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-upload me-2"></i>Uploading document...
                    </div>
                `;
            }

            // Track upload start time
            const uploadStartTime = Date.now();

            // Set a timeout to re-enable button if something goes wrong
            const uploadTimeout = setTimeout(function() {
                if (submitBtn.disabled) {
                    const elapsedTime = Math.round((Date.now() - uploadStartTime) / 1000);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Upload Document';
                    if (progressDiv) {
                        progressDiv.innerHTML = `
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle me-2"></i>Upload timed out after ${elapsedTime} seconds. Please check your file and try again.
                            </div>
                        `;
                    }
                }
            }, 30000); // 30 second timeout

            // Clear timeout when form actually submits successfully
            form.addEventListener('submit', function() {
                clearTimeout(uploadTimeout);
            });
        });
    }
});

// Background task status checking function (for OCR status links)
function checkOCRStatus(taskId) {
    fetch(`/api/ocr/status/${taskId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const task = data.task;
                const progress = Math.round(task.progress * 100);

                let statusMessage = `OCR Task Status: ${task.status} (${progress}%)`;

                if (task.status === 'completed') {
                    if (task.result && task.result.success) {
                        statusMessage = `‚úÖ OCR completed successfully! Extracted ${task.result.text_length || 0} characters.`;
                    } else {
                        statusMessage = `‚ùå OCR failed: ${task.error_message || 'Unknown error'}`;
                    }
                } else if (task.status === 'running') {
                    statusMessage = `üîÑ OCR in progress... (${progress}%)`;
                } else if (task.status === 'pending') {
                    statusMessage = `‚è≥ OCR queued and waiting to start...`;
                }

                alert(statusMessage);
            } else {
                alert(`‚ùå Could not get task status: ${data.error}`);
            }
        })
        .catch(error => {
            console.error('Error checking OCR status:', error);
            alert('‚ùå Error checking OCR status. Please try again.');
        });
}
</script>


{% extends 'base_demo.html' %}

{% block title %}HealthPrep - {{ title | default('Upload Document') }}{% endblock %}

{% block content %}
<div class="mb-4">
    <h1>
        <i class="fas fa-file-medical me-2"></i>{{ title | default('Upload Medical Document') }}
    </h1>
</div>

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card border-0 mb-4">
            <div class="card-header bg-secondary bg-opacity-25">
                <h5 class="mb-0">
                    {% if unified_upload %}
                        Upload Medical Document
                    {% else %}
                        Upload Document for {{ patient.full_name }}
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    {{ form.hidden_tag() }}

                    <div class="mb-3">
                        <label for="file" class="form-label">{{ form.file.label }}</label>
                        {{ form.file(class="form-control", onchange="handleFileSelection(this)") }}
                        {% if form.file.errors %}
                            {% for error in form.file.errors %}
                            <div class="text-danger mt-1">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                        <div class="form-text">
                            Optional: Upload text documents from EMR systems. You can create document entries without attaching files if needed.
                        </div>
                        <div id="file-upload-progress" style="display: none;"></div>
                        <div id="file-info"></div>
                    </div>

                    {% if unified_upload %}
                    <div class="mb-3">
                        <label for="patient_id" class="form-label">{{ form.patient_id.label }}</label>
                        {{ form.patient_id(class="form-select") }}
                        {% if form.patient_id.errors %}
                            {% for error in form.patient_id.errors %}
                            <div class="text-danger mt-1">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                        {% if form.patient_id.description %}
                            <div class="form-text">{{ form.patient_id.description }}</div>
                        {% endif %}
                    </div>
                    {% endif %}

                    <div class="mb-3">
                        <label for="document_name" class="form-label">{{ form.document_name.label }}</label>
                        {{ form.document_name(class="form-control") }}
                        {% if form.document_name.errors %}
                            {% for error in form.document_name.errors %}
                            <div class="text-danger mt-1">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                        {% if form.document_name.description %}
                            <div class="form-text">{{ form.document_name.description }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="document_type" class="form-label">{{ form.document_type.label }}</label>
                        {{ form.document_type(class="form-select") }}
                        {% if form.document_type.errors %}
                            {% for error in form.document_type.errors %}
                            <div class="text-danger mt-1">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                        {% if form.document_type.description %}
                            <div class="form-text">{{ form.document_type.description }}</div>
                        {% endif %}
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="source_system" class="form-label">{{ form.source_system.label }}</label>
                                {{ form.source_system(class="form-control") }}
                                {% if form.source_system.errors %}
                                    {% for error in form.source_system.errors %}
                                    <div class="text-danger mt-1">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                                {% if form.source_system.description %}
                                    <div class="form-text">{{ form.source_system.description }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="document_date" class="form-label">{{ form.document_date.label }}</label>
                                {{ form.document_date(class="form-control") }}
                                {% if form.document_date.errors %}
                                    {% for error in form.document_date.errors %}
                                    <div class="text-danger mt-1">{{ error }}</div>
                                    {% endfor %}
                                {% endif %}
                                {% if form.document_date.description %}
                                    <div class="form-text">{{ form.document_date.description }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>



                    <div class="d-grid gap-2">
                        {{ form.submit(class="btn btn-primary", id="submit-btn") }}
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}