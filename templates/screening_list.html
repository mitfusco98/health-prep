{% extends 'base_demo.html' %}

{% block title %}HealthPrep - Screening List{% endblock %}

{% block extra_js %}
<script>
// Load keywords and display as badges
function loadKeywordsAsBadges() {
    const keywordContainers = document.querySelectorAll('.keywords-badges-container');
    console.log(`loadKeywordsAsBadges: Found ${keywordContainers.length} keyword containers to load`);

    keywordContainers.forEach(container => {
        const screeningTypeId = container.id.replace('keywords-display-', '');

        console.log(`loadKeywordsAsBadges: Loading keywords for screening ${screeningTypeId}`);

        fetch(`/api/screening-keywords/${screeningTypeId}`)
            .then(response => {
                console.log(`loadKeywordsAsBadges: API response status for screening ${screeningTypeId}: ${response.status}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(`Received keywords data for screening ${screeningTypeId}:`, data);
                if (data.success && data.keywords && Array.isArray(data.keywords) && data.keywords.length > 0) {
                    // Display keywords as badges
                    const keywordsHtml = data.keywords.map(keyword => 
                        `<span class="badge bg-primary me-1 mb-1">${keyword}</span>`
                    ).join('');
                    container.innerHTML = keywordsHtml;

                    console.log(`Successfully updated keywords display for screening ${screeningTypeId} with ${data.keywords.length} keywords`);
                } else {
                    // Show no keywords message
                    container.innerHTML = '<small class="text-muted">No keywords defined</small>';
                    console.log(`No keywords found for screening ${screeningTypeId}`);
                }
            })
            .catch(error => {
                console.error(`Error loading keywords for screening ${screeningTypeId}:`, error);
                container.innerHTML = '<small class="text-danger">Error loading keywords</small>';
            });
    });
}

// Initialize keyword display when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Content Loaded - checking for keyword containers...');

    // Check if keyword containers exist
    const hasKeywordContainers = document.querySelectorAll('.keywords-badges-container').length > 0;

    if (hasKeywordContainers) {
        console.log('Loading keywords for display...');
        // Load keywords immediately
        loadKeywordsAsBadges();

        // Also load after a delay to ensure DOM is fully ready
        setTimeout(() => {
            loadKeywordsAsBadges();
        }, 1000);
    } else {
        console.log('No keyword containers found - skipping keyword loading');
    }
});

// No additional JavaScript needed for the simplified interface
</script>
{% endblock %}

{% block extra_css %}
<style>
/* Override for buttons - added May 18, 2025 */
.btn .fas, .btn .fa {
    display: none !important;
}
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h1>Screening List</h1>
        <p class="lead">View and manage patient screening recommendations</p>
    </div>
</div>

<!-- Nav Tabs -->
<ul class="nav nav-tabs mb-3">
    <li class="nav-item">
        <a class="nav-link {% if active_tab == 'screenings' %}active{% endif %}" href="{{ url_for('screening_list', tab='screenings', search=search_query) }}">
            Screening List
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if active_tab == 'types' %}active{% endif %}" href="{{ url_for('screening_list', tab='types', search=search_query) }}">
            Manage Screening Types
        </a>
    </li>

    <li class="nav-item">
        <a class="nav-link {% if active_tab == 'checklist' %}active{% endif %}" href="{{ url_for('screening_list', tab='checklist', search=search_query) }}">
            Prep Sheet Settings
        </a>
    </li>
</ul>

<!-- Tab Content -->
{% if active_tab == 'screenings' %}
<!-- Screening List Tab Content -->
<div class="card border-0">
    <div class="card-header bg-secondary bg-opacity-25">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="mb-0">
                    <i class="fas fa-clipboard-check me-2"></i>Screening List
                </h5>
            </div>
            <div class="col-auto d-flex">
                <form class="d-flex me-2" method="get">
                    <input type="hidden" name="tab" value="screenings">
                    <input class="form-control me-2" type="search" placeholder="Search patients..." name="search" value="{{ search_query }}">
                    <button class="btn btn-outline-secondary" type="submit">Search</button>
                </form>
                <a href="{{ url_for('screening_list', tab='screenings', regenerate='true') }}" class="btn btn-success me-2" onclick="return confirm('Regenerate all automated screenings? This may take a moment.')">
                    <i class="fas fa-sync-alt me-1"></i>Regenerate
                </a>
                <a href="{{ url_for('add_screening_form') }}" class="btn btn-primary">
                    Add Screening
                </a>
            </div>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="card-body border-bottom">
        <form method="get" class="row g-3">
            <input type="hidden" name="tab" value="screenings">
            
            <div class="col-md-3">
                <label class="form-label">Filter by Patient Name</label>
                <input type="text" name="search" class="form-control" placeholder="Patient name..." value="{{ search_query }}">
            </div>
            
            <div class="col-md-3">
                <label class="form-label">Filter by Status</label>
                <select name="status" class="form-select" onchange="this.form.submit()">
                    <option value="">All Statuses</option>
                    {% for status in distinct_statuses %}
                    <option value="{{ status }}" {% if status == status_filter %}selected{% endif %}>{{ status }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-3">
                <label class="form-label">Filter by Screening Type</label>
                <select name="screening_type" class="form-select" onchange="this.form.submit()">
                    <option value="">All Types</option>
                    {% for type in all_screening_types %}
                    <option value="{{ type.name }}" {% if type.name == screening_type_filter %}selected{% endif %}>{{ type.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-primary me-2">Apply Filters</button>
                {% if search_query or status_filter or screening_type_filter %}
                <a href="{{ url_for('screening_list', tab='screenings') }}" class="btn btn-outline-secondary">
                    Clear Filters
                </a>
                {% endif %}
            </div>
        </form>
    </div>
    <div class="card-body p-0">
        {% if screenings %}
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0">
                <thead>
                    <tr>
                        <th>Patient</th>
                        <th>Screening Type</th>
                        <th>Status</th>
                        <th>Last Completed</th>
                        <th>Frequency</th>
                        <th>Matched Documents</th>
                        <th width="120">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for screening in screenings %}
                    <tr>
                        <td>
                            <a href="{{ url_for('patient_detail', patient_id=screening.patient.id) }}">
                                {{ screening.patient.full_name }}
                            </a>
                        </td>
                        <td>{{ screening.screening_type }}</td>
                        <td>
                            {% set status_class = {
                                'Due': 'danger',
                                'Due Soon': 'warning',
                                'Incomplete': 'secondary', 
                                'Complete': 'success'
                            } %}
                            <span class="badge bg-{{ status_class.get(screening.status, 'secondary') }}">
                                {{ screening.status or 'Incomplete' }}
                            </span>
                        </td>
                        <td>
                            {% if screening.last_completed %}
                                {{ screening.last_completed.strftime('%m/%d/%Y') }}
                            {% else %}
                                <span class="text-muted">No records</span>
                            {% endif %}
                        </td>
                        <td>{{ screening.frequency or '-' }}</td>
                        <td>
                            {% if screening.notes %}
                                {% set note_parts = screening.notes.split('|') %}
                                {% for part in note_parts %}
                                    {% if 'Document ID:' in part %}
                                        {% set doc_id = part.replace('Document ID:', '').strip() %}
                                        <a href="{{ url_for('view_document', document_id=doc_id) }}" class="badge bg-info text-decoration-none me-1" target="_blank">
                                            Document {{ doc_id }}
                                        </a>
                                    {% else %}
                                        <small class="text-muted">{{ part.strip() }}</small>
                                    {% endif %}
                                {% endfor %}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a href="{{ url_for('patient_detail', patient_id=screening.patient_id) }}" 
                                   class="btn btn-outline-primary btn-sm" title="View Patient">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <button type="button" class="btn btn-outline-primary btn-sm edit-screening-btn" 
                                   data-bs-toggle="modal" data-bs-target="#editScreeningModal"
                                   data-id="{{ screening.id }}"
                                   data-patient-id="{{ screening.patient.id }}"
                                   data-patient-name="{{ screening.patient.full_name }}"
                                   data-screening-type="{{ screening.screening_type }}"
                                   data-last-completed="{{ screening.last_completed.strftime('%Y-%m-%d') if screening.last_completed else '' }}"
                                   data-frequency="{{ screening.frequency or '' }}"
                                   data-status="{{ screening.status or '' }}"
                                   data-notes="{{ screening.notes or '' }}"
                                   title="Edit Screening">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-search fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">No screenings found</h5>
            <p class="text-muted">
                {% if search_query or status_filter or screening_type_filter %}
                    No screenings found with current filters. <a href="{{ url_for('screening_list', tab='screenings') }}">Clear all filters</a> to view all.
                {% else %}
                    Click "Regenerate" above to generate automated screenings for eligible patients.
                {% endif %}
            </p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add Screening Recommendation Modal -->
<div class="modal fade" id="addScreeningRecommendationModal" tabindex="-1" aria-labelledby="addScreeningRecommendationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addScreeningRecommendationModalLabel">Add Screening Recommendation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('add_screening_recommendation', ts=cache_timestamp) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Patient <span class="text-danger">*</span></label>
                        <select class="form-select" name="patient_id" id="patient" required>
                            <option value="">Select a patient</option>
                            {% for patient in patients %}
                                <option value="{{ patient.id }}">{{ patient.full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Screening Type <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="screening_type" id="screening_type" required list="screening-types-list">
                        <datalist id="screening-types-list">
                            {% for type in all_screening_types %}
                                <option value="{{ type.name }}">
                            {% endfor %}
                        </datalist>
                        <small class="text-muted">Type or select from available screening types</small>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Due Date</label>
                                <input type="date" class="form-control" name="due_date">
                                <small class="text-muted">When should this screening be completed</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Last Completed</label>
                                <input type="date" class="form-control" name="last_completed">
                                <small class="text-muted">When was this screening last done</small>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Frequency</label>
                                <input type="text" class="form-control" name="frequency" placeholder="e.g. Annual, Every 5 years">
                                <small class="text-muted">How often this screening should be done</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Priority</label>
                                <select class="form-select" name="priority">
                                    <option value="">Select priority</option>
                                    <option value="High">High</option>
                                    <option value="Medium">Medium</option>
                                    <option value="Low">Low</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" name="notes" rows="3"></textarea>
                        <small class="text-muted">Any additional information about this screening recommendation</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Screening Modal -->
<div class="modal fade" id="editScreeningModal" tabindex="-1" aria-labelledby="editScreeningModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editScreeningModalLabel">Edit Screening Recommendation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" id="editScreeningForm" action="">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="patient_id" id="edit-patient-id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Patient</label>
                        <p class="form-control-plaintext" id="edit-patient-name"></p>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Screening Type <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="screening_type" id="edit-screening-type" required list="screening-types-list">
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Due Date</label>
                                <input type="date" class="form-control" name="due_date" id="edit-due-date">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Last Completed</label>
                                <input type="date" class="form-control" name="last_completed" id="edit-last-completed">
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Frequency</label>
                                <input type="text" class="form-control" name="frequency" id="edit-frequency">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Priority</label>
                                <select class="form-select" name="priority" id="edit-priority">
                                    <option value="">Select priority</option>
                                    <option value="High">High</option>
                                    <option value="Medium">Medium</option>
                                    <option value="Low">Low</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" name="notes" id="edit-notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% elif active_tab == 'types' %}
<!-- Screening Types Tab Content -->
<div class="card border-0">
    <div class="card-header bg-secondary bg-opacity-25">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="mb-0">
                    <i class="fas fa-cog me-2"></i>Screening Types
                </h5>
            </div>
            <div class="col-auto d-flex">
                <form class="d-flex me-2" method="get">
                    <input type="hidden" name="tab" value="types">
                    <input class="form-control me-2" type="search" placeholder="Search screening types" name="search" value="{{ search_query }}">
                    <button class="btn btn-outline-secondary" type="submit">Search</button>
                </form>


                <a href="{{ url_for('add_screening_type_form') }}" class="btn btn-primary">
                    Add Type
                </a>
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        {% if screening_types %}
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0">
                <thead>
                    <tr>
                        <th>Name & Keywords</th>
                        <th>Frequency</th>
                        <th>Gender Specific</th>
                        <th>Age Range</th>
                        <th>Trigger Conditions</th>
                        <th>Status</th>
                        <th width="200">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for screening_type in screening_types %}
                    <tr>
                        <td>
                            <div>
                                <div>
                                    <strong>{{ screening_type.name }}</strong>
                                </div>
                                <div class="mt-1">
                                    <div id="keywords-display-{{ screening_type.id }}" class="keywords-badges-container">
                                        <small class="text-muted">Loading keywords...</small>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td>{{ screening_type.formatted_frequency }}</td>
                        <td>
                            {% if screening_type.gender_specific %}
                                {{ screening_type.gender_specific }}
                            {% else %}
                                All Genders
                            {% endif %}
                        </td>
                        <td>
                            {% if screening_type.min_age and screening_type.max_age %}
                                Ages {{ screening_type.min_age }} to {{ screening_type.max_age }}
                            {% elif screening_type.min_age %}
                                Age {{ screening_type.min_age }}+
                            {% elif screening_type.max_age %}
                                Up to age {{ screening_type.max_age }}
                            {% else %}
                                All Ages
                            {% endif %}
                        </td>
                        <td>
                            {% set trigger_conditions = screening_type.get_trigger_conditions() %}
                            {% if trigger_conditions %}
                                <div class="d-flex flex-wrap gap-1">
                                    {% for condition in trigger_conditions[:3] %}
                                        <span class="badge bg-info text-dark small" title="{{ condition.display }} ({{ condition.code }})">
                                            {{ condition.display|truncate(20) }}
                                        </span>
                                    {% endfor %}
                                    {% if trigger_conditions|length > 3 %}
                                        <span class="badge bg-light text-dark small">+{{ trigger_conditions|length - 3 }} more</span>
                                    {% endif %}
                                </div>
                            {% else %}
                                <small class="text-muted">None</small>
                            {% endif %}
                        </td>
                        <td>
                            {% if screening_type.is_active %}
                                <span class="badge bg-success">Active</span>
                            {% else %}
                                <span class="badge bg-secondary">Inactive</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <a href="{{ url_for('edit_screening_type', screening_type_id=screening_type.id) }}" 
                                   class="btn btn-sm btn-outline-primary">
                                    Edit
                                </a>
                                <a href="{{ url_for('delete_screening_type', screening_type_id=screening_type.id, ts=cache_timestamp) }}" class="btn btn-sm btn-outline-danger" 
                                   onclick="return confirm('Are you sure you want to delete this screening type?');">
                                    Delete
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <p class="text-muted mb-0">No screening types found {% if search_query %}matching "{{ search_query }}"{% endif %}</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add Screening Type Modal -->
<div class="modal fade" id="addScreeningTypeModal" tabindex="-1" aria-labelledby="addScreeningTypeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addScreeningTypeModalLabel">Add Screening Type</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('add_screening_type', ts=cache_timestamp) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="name" required>
                        <small class="text-muted">Name of the screening (e.g., 'Mammogram', 'Colonoscopy')</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Keywords for Document Matching</label>
                        <div class="border rounded p-3 bg-light">
                            <div id="add-form-keywords-container">
                                <div class="d-flex mb-2">
                                    <input type="text" class="form-control me-2" id="add-form-keyword-input" placeholder="Enter keyword">
                                    <button type="button" class="btn btn-outline-primary" onclick="addKeywordToForm('add-form')">Add</button>
                                </div>
                                <div id="add-form-keywords-list" class="keywords-list"></div>
                            </div>
                        </div>
                        <small class="text-muted">Keywords help identify relevant documents for this screening type</small>
                        <input type="hidden" name="keywords" id="add-form-keywords-data">
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Default Frequency</label>
                                <input type="text" class="form-control" name="default_frequency">
                                <small class="text-muted">How often this screening should be done (e.g., 'Annual', 'Every 5 years')</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Gender Specific</label>
                                <select class="form-select" name="gender_specific">
                                    <option value="">All Genders</option>
                                    <option value="Male">Male Only</option>
                                    <option value="Female">Female Only</option>
                                </select>
                                <small class="text-muted">Is this screening specific to a particular gender?</small>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Minimum Age</label>
                                <input type="number" class="form-control" name="min_age" min="0" max="120">
                                <small class="text-muted">Minimum age to start this screening</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Maximum Age</label>
                                <input type="number" class="form-control" name="max_age" min="0" max="120">
                                <small class="text-muted">Maximum age for this screening (leave blank if no upper limit)</small>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Trigger Conditions (FHIR)</label>
                        <div class="border rounded p-3 bg-light">
                            <div id="add-form-trigger-conditions-container">
                                <div class="d-flex mb-2">
                                    <select class="form-select me-2" id="add-form-condition-system" style="max-width: 200px;">
                                        <option value="http://snomed.info/sct">SNOMED CT</option>
                                        <option value="http://hl7.org/fhir/sid/icd-10-cm">ICD-10-CM</option>
                                        <option value="http://hl7.org/fhir/sid/icd-9-cm">ICD-9-CM</option>
                                        <option value="custom">Custom</option>
                                    </select>
                                    <input type="text" class="form-control me-2" id="add-form-condition-code" placeholder="Condition code">
                                    <input type="text" class="form-control me-2" id="add-form-condition-display" placeholder="Display name">
                                    <button type="button" class="btn btn-outline-primary" onclick="addTriggerCondition('add-form')">Add</button>
                                </div>
                                <div id="add-form-trigger-conditions-list" class="trigger-conditions-list"></div>
                            </div>
                        </div>
                        <small class="text-muted">Medical conditions that should trigger this screening recommendation</small>
                        <input type="hidden" name="trigger_conditions" id="add-form-trigger-conditions-data">
                    </div>

                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="is_active" id="isActive" checked>
                        <label class="form-check-label" for="isActive">
                            Active
                        </label>
                        <div class="form-text">Whether this screening should appear in checklists</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>


{% elif active_tab == 'checklist' %}
<!-- Prep Sheet Settings Tab Content -->
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h4 class="mb-4">Prep Sheet Checklist Settings</h4>

            <!-- Status Options Configuration -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Status Options for Prep Sheets</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">These status options will appear as autocomplete suggestions when filling out screening checklists in prep sheets.</p>

                    <form id="status-form" method="POST" action="{{ url_for('save_status_options_simple') }}" onsubmit="console.log('Form submitting!'); return updateCustomStatusBeforeSubmit()">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                        <div class="mb-3">
                            <label class="form-label">Available Status Options</label>
                            <div id="status-buttons" class="d-flex flex-wrap gap-2 mb-3">
                                {% set current_status_list = settings.status_options_list if settings else ['due'] %}

                                <button type="button" class="btn status-btn {% if 'due' in current_status_list %}btn-success{% else %}btn-outline-success{% endif %}" 
                                        data-value="due" onclick="toggleStatus(this)">Due</button>

                                <button type="button" class="btn status-btn {% if 'due_soon' in current_status_list %}btn-success{% else %}btn-outline-success{% endif %}" 
                                        data-value="due_soon" onclick="toggleStatus(this)">Due Soon</button>

                                <button type="button" class="btn status-btn {% if 'incomplete' in current_status_list %}btn-success{% else %}btn-outline-success{% endif %}" 
                                        data-value="incomplete" onclick="toggleStatus(this)">Incomplete</button>

                                <button type="button" class="btn status-btn {% if 'completed' in current_status_list %}btn-success{% else %}btn-outline-success{% endif %}" 
                                        data-value="completed" onclick="toggleStatus(this)">Completed</button>
                            </div>
                        </div>

                        <div id="selected-status-display" class="mb-3">
                            <small class="text-muted">Selected: <span id="status-list-display">{{ ', '.join(current_status_list) }}</span></small>
                        </div>

                        

                        <!-- Hidden input that will contain the final selections -->
                        <input type="hidden" id="status-selections" name="status_selections" value="{{ ','.join(current_status_list) }}">

                        <button type="submit" class="btn btn-primary">Save Status Options</button>
                    </form>
                </div>
            </div>

            <!-- Default Items Configuration -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Default Checklist Items</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">These screening types will automatically appear in every patient's prep sheet checklist.</p>

                    <form id="default-items-form" method="POST" action="{{ url_for('save_default_items_simple') }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                        {% if active_screening_types %}
                            <div class="mb-3">
                                <label class="form-label">Available Screening Types</label>
                                <div id="screening-buttons" class="d-flex flex-wrap gap-2 mb-3">
                                    {% set current_default_list = settings.default_items_list if settings and settings.default_items_list else [] %}

                                    {% for screening in active_screening_types %}
                                    <button type="button" class="btn screening-btn {% if screening.name in current_default_list %}btn-primary{% else %}btn-outline-primary{% endif %}" 
                                            data-value="{{ screening.name }}" onclick="toggleScreening(this)">
                                        {{ screening.name }}
                                        {% if screening.formatted_frequency %}
                                        <br><small>{{ screening.formatted_frequency }}</small>
                                        {% endif %}
                                    </button>
                                    {% endfor %}
                                </div>
                            </div>

                            <div id="selected-screening-display" class="mb-3">
                                <small class="text-muted">Selected: <span id="screening-list-display">{{ ', '.join(current_default_list) if current_default_list else 'None' }}</span></small>
                            </div>

                            <!-- Hidden input for final selections -->
                            <input type="hidden" id="screening-selections" name="screening_selections" value="{% for item in current_default_list %}{{ item }}{% if not loop.last %},{% endif %}{% endfor %}">

                            <button type="submit" class="btn btn-primary">Save Default Items</button>
                        {% else %}
                            <div class="alert alert-warning">
                                No active screening types found. <a href="{{ url_for('screening_list', tab='types') }}">Add screening types</a> first.
                            </div>
                        {% endif %}
                    </form>
                </div>
            </div>

            <!-- Data Cutoff Settings -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Data Cutoff Settings</h5>
                    <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#cutoffModal">
                        <i class="fas fa-cog me-1"></i>Configure Cutoffs
                    </button>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">Control how far back to look for medical data in prep sheet quality checklists.</p>

                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <h6 class="text-primary">Laboratories</h6>
                                <span class="badge bg-info">{{ 'To Last Appointment Date' if settings and settings.labs_cutoff_months == 0 else (settings.labs_cutoff_months ~ ' months' if settings else 'To Last Appointment Date') }}</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h6 class="text-success">Imaging</h6>
                                <span class="badge bg-info">{{ 'To Last Appointment Date' if settings and settings.imaging_cutoff_months == 0 else (settings.imaging_cutoff_months ~ ' months' if settings else 'To Last Appointment Date') }}</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h6 class="text-warning">Consults</h6>
                                <span class="badge bg-info">{{ 'To Last Appointment Date' if settings and settings.consults_cutoff_months == 0 else (settings.consults_cutoff_months ~ ' months' if settings else 'To Last Appointment Date') }}</span>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <h6 class="text-danger">Hospital Visits</h6>
                                <span class="badge bg-info">{{ 'To Last Appointment Date' if settings and settings.hospital_cutoff_months == 0 else (settings.hospital_cutoff_months ~ ' months' if settings else 'To Last Appointment Date') }}</span>
                            </div>
                        </div>
                    </div>

                    {% if active_screening_types %}
                    <hr class="my-4">
                    <h6 class="mb-3">Active Screening Types Cutoffs</h6>
                    <p class="text-muted small mb-3">These cutoffs apply to all active screening types in default checklist items</p>

                    <div class="row">
                        {% for screening in active_screening_types %}
                            {% if screening.name in (settings.default_items_list if settings and settings.default_items_list else []) %}
                            <div class="col-md-4 col-lg-3 mb-2">
                                <div class="text-center">
                                    <h6 class="text-info">{{ screening.name }}</h6>
                                    {% set cutoff_value = settings.screening_cutoffs_dict.get(screening.name, 0) if settings and settings.screening_cutoffs_dict else 0 %}
                                    <span class="badge bg-info">{{ cutoff_value ~ ' months' if cutoff_value > 0 else 'To Last Appointment Date' }}</span>
                                </div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Current Settings Display -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Current Settings Summary</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Status Options:</h6>
                            <ul class="list-unstyled">
                                {% if settings and settings.status_options_list %}
                                    {% for status in settings.status_options_list %}
                                    <li><span class="badge bg-success">{{ status.replace('_', ' ').title() }}</span></li>
                                    {% endfor %}
                                {% else %}
                                    <li class="text-muted">None configured</li>
                                {% endif %}
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>Default Items:</h6>
                            <ul class="list-unstyled">
                                {% if settings and settings.default_items_list %}
                                    {% for item in settings.default_items_list %}
                                    <li><span class="badge bg-primary">{{ item }}</span></li>
                                    {% endfor %}
                                {% else %}
                                    <li class="text-muted">None configured</li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Data Cutoff Configuration Modal -->
<div class="modal fade" id="cutoffModal" tabindex="-1" aria-labelledby="cutoffModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cutoffModalLabel">Configure Data Cutoff Windows</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('save_cutoff_settings') }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <p class="text-muted mb-4">
                        Set how far back to look for medical data in prep sheet quality checklists. 
                        For example, excluding labs older than 6 months helps focus on recent results.
                    </p>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="labs_cutoff_months" class="form-label">
                                <i class="fas fa-flask text-primary me-2"></i>Laboratory Results
                            </label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="labs_cutoff_months" 
                                       name="labs_cutoff_months" min="0" max="120" 
                                       value="{{ settings.labs_cutoff_months if settings and settings.labs_cutoff_months != 0 else 0 }}" required>
                                <span class="input-group-text">months</span>
                            </div>
                            <div class="form-text">How old lab results to include (0 = to last appointment)</div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="imaging_cutoff_months" class="form-label">
                                <i class="fas fa-x-ray text-success me-2"></i>Imaging Studies
                            </label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="imaging_cutoff_months" 
                                       name="imaging_cutoff_months" min="0" max="120" 
                                       value="{{ settings.imaging_cutoff_months if settings and settings.imaging_cutoff_months != 0 else 0 }}" required>
                                <span class="input-group-text">months</span>
                            </div>
                            <div class="form-text">How old imaging studies to include (0 = to last appointment)</div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="consults_cutoff_months" class="form-label">
                                <i class="fas fa-user-md text-warning me-2"></i>Consult Reports
                            </label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="consults_cutoff_months" 
                                       name="consults_cutoff_months" min="0" max="120" 
                                       value="{{ settings.consults_cutoff_months if settings and settings.consults_cutoff_months != 0 else 0 }}" required>
                                <span class="input-group-text">months</span>
                            </div>
                            <div class="form-text">How old consult reports to include (0 = to last appointment)</div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="hospital_cutoff_months" class="form-label">
                                <i class="fas fa-hospital text-danger me-2"></i>Hospital Visits
                            </label>
                            <div class="input-group">
                                <input type="number" class="form-control" id="hospital_cutoff_months" 
                                       name="hospital_cutoff_months" min="0" max="120" 
                                       value="{{ settings.hospital_cutoff_months if settings and settings.hospital_cutoff_months != 0 else 0 }}" required>
                                <span class="input-group-text">months</span>
                            </div>
                            <div class="form-text">How old hospital visits to include (0 = to last appointment)</div>
                        </div>
                    </div>

                    {% if active_screening_types %}
                    <hr class="my-4">
                    <h6 class="mb-3">Active Screening Types Cutoffs</h6>
                    <p class="text-muted small mb-3">Individual cutoff settings for each active screening type in default checklist items</p>
                    <div class="row">
                        {% for screening in active_screening_types %}
                            {% if screening.name in (settings.default_items_list if settings and settings.default_items_list else []) %}
                            <div class="col-md-6 mb-3">
                                <label for="screening_cutoff_{{ loop.index }}" class="form-label">
                                    <i class="fas fa-check-circle text-info me-2"></i>{{ screening.name }}
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control screening-cutoff" 
                                           id="screening_cutoff_{{ loop.index }}" 
                                           name="screening_cutoff_{{ screening.name|replace(' ', '_')|lower }}"
                                           data-screening-name="{{ screening.name }}"
                                           data-original-value="{{ settings.get_screening_cutoff(screening.name) if settings else 0 }}"
                                           data-user-modified="false"
                                           data-preset-modified="false"
                                           min="0" max="120" 
                                           value="{{ settings.get_screening_cutoff(screening.name) if settings else 0 }}" required>
                                    <span class="input-group-text">months</span>
                                </div>
                                <div class="form-text">Cutoff for {{ screening.name }} documents</div>
                            </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    {% endif %}

                    <div class="mt-4">
                        <h6>Quick Preset Options</h6>
                        <div class="d-flex flex-wrap gap-2 mb-3">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setPresetCutoffs(3, 3, 3, 3)">
                                Conservative (3m/3m/3m/3m)
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setPresetCutoffs(6, 6, 6, 6)">
                                Standard (6m/6m/6m/6m)
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="setPresetCutoffs(12, 12, 12, 12)">
                                Extended (12m/12m/12m/12m)
                            </button>
                            <button type="button" class="btn btn-outline-info btn-sm" onclick="setToLastAppointmentDate()">
                                To Last Appointment Date
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Cutoff Settings</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Preset cutoff configuration function
function setPresetCutoffs(labs, imaging, consults, hospital) {
    // Check if any screening fields have been modified by user
    const screeningInputs = document.querySelectorAll('.screening-cutoff');
    let hasUserInput = false;

    screeningInputs.forEach(input => {
        if (input.dataset.userModified === 'true') {
            hasUserInput = true;
        }
    });

    if (hasUserInput) {
        if (!confirm('This will override your existing screening cutoff settings. Continue?')) {
            return;
        }
    }

    // Set main cutoff values
    document.getElementById('labs_cutoff_months').value = labs;
    document.getElementById('imaging_cutoff_months').value = imaging;
    document.getElementById('consults_cutoff_months').value = consults;
    document.getElementById('hospital_cutoff_months').value = hospital;

    // Apply the same preset value to all screening-specific cutoffs
    screeningInputs.forEach(input => {
        // Only apply preset if user hasn't manually modified this field
        if (input.dataset.userModified !== 'true') {
            input.value = labs; // Use the same value for all screening cutoffs
            input.dataset.presetModified = 'true'; // Mark as preset modified
            input.dataset.originalValue = labs; // Update original value
        }
    });
}

// Set all cutoffs to use each patient's last appointment date
function setToLastAppointmentDate() {
    // Check if user has input values and confirm override
    const screeningInputs = document.querySelectorAll('.screening-cutoff');
    let hasUserInput = false;

    screeningInputs.forEach(input => {
        if (input.dataset.userModified === 'true') {
            hasUserInput = true;
        }
    });

    if (hasUserInput) {
        if (!confirm('This will reset all cutoffs to use last appointment date. Continue?')) {
            return;
        }
    }

    // Clear all cutoff values to trigger patient-specific last appointment fallback
    document.getElementById('labs_cutoff_months').value = 0;
    document.getElementById('imaging_cutoff_months').value = 0;
    document.getElementById('consults_cutoff_months').value = 0;
    document.getElementById('hospital_cutoff_months').value = 0;

    // Clear all screening-specific cutoffs
    screeningInputs.forEach(input => {
        // Only set to 0 if user hasn't manually modified this field
        if (input.dataset.userModified !== 'true') {
            input.value = 0;
            input.dataset.presetModified = 'true'; // Mark as preset modified
            input.dataset.originalValue = '0'; // Update original value
        }
    });

    // Show confirmation
    alert('Cutoffs set to use each patient\'s last appointment date (excluding today\'s appointments)');
}

// Calculate exact months difference between two dates
function calculateExactMonthsDifference(startDate, endDate) {
    const start = new Date(startDate);
    const end = new Date(endDate);

    let months = (end.getFullYear() - start.getFullYear()) * 12;
    months += end.getMonth() - start.getMonth();

    // If the day hasn't been reached yet in the final month, subtract one
    if (end.getDate() < start.getDate()) {
        months--;
    }

    return Math.max(1, Math.ceil(months)); // Always at least 1 month, rounded up
}

// Calculate months between two dates (legacy function for compatibility)
function monthsBetween(date1, date2) {
    return calculateExactMonthsDifference(date1, date2);
}

// Set cutoffs based on appointment date
function setAppointmentBasedCutoffs(appointmentDate) {
    const today = new Date();
    const months = monthsBetween(appointmentDate, today);

    // Set all cutoffs to the calculated months from the appointment date
    document.getElementById('labs_cutoff_months').value = months;
    document.getElementById('imaging_cutoff_months').value = months;
    document.getElementById('consults_cutoff_months').value = months;
    document.getElementById('hospital_cutoff_months').value = months;
}

// Load recent appointments when modal is shown
document.addEventListener('DOMContentLoaded', function() {
    const cutoffModal = document.getElementById('cutoffModal');
    if (cutoffModal) {
        cutoffModal.addEventListener('show.bs.modal', function() {
            loadRecentAppointments();
        });
    }
});

// Load recent appointments for appointment-based cutoffs
function loadRecentAppointments() {
    fetch('/api/recent-appointments')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('appointment-presets');
            if (data.success && data.appointments.length > 0) {
                container.innerHTML = '';
                data.appointments.forEach((apt, index) => {
                    const label = index === 0 ? 'Last appointment' : 
                                  index === 1 ? 'Second last' : 
                                  index === 2 ? 'Third last' : 
                                  `${index + 1}th last`;

                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'btn btn-outline-info btn-sm';
                    button.innerHTML = `${label}<br><small>${apt.formatted_date}</small>`;
                    button.onclick = () => setAppointmentBasedCutoffs(apt.date);

                    container.appendChild(button);
                });
            } else {
                container.innerHTML = '<div class="text-muted small">No recent appointments found</div>';
            }
        })
        .catch(error => {
            console.error('Error loading appointments:', error);
            const container = document.getElementById('appointment-presets');
            container.innerHTML = '<div class="text-muted small">Error loading appointments</div>';
        });
}

function toggleStatus(button) {
    // Toggle button appearance
    if (button.classList.contains('btn-success')) {
        button.classList.remove('btn-success');
        button.classList.add('btn-outline-success');
    } else {
        button.classList.remove('btn-outline-success');
        button.classList.add('btn-success');
    }

    updateStatusSelections();
}

function toggleScreening(button) {
    // Toggle button appearance
    if (button.classList.contains('btn-primary')) {
        button.classList.remove('btn-primary');
        button.classList.add('btn-outline-primary');
    } else {
        button.classList.remove('btn-outline-primary');
        button.classList.add('btn-primary');
    }

    updateScreeningSelections();
}

function updateStatusSelections() {
    const selectedButtons = document.querySelectorAll('#status-buttons .btn-success');
    const values = Array.from(selectedButtons).map(btn => btn.dataset.value);

    document.getElementById('status-selections').value = values.join(',');
    document.getElementById('status-list-display').textContent = values.length > 0 ? values.join(', ') : 'None';

    console.log('Status selections updated:', values);
}

function updateScreeningSelections() {
    const selectedButtons = document.querySelectorAll('#screening-buttons .btn-primary');
    const values = Array.from(selectedButtons).map(btn => btn.dataset.value);

    document.getElementById('screening-selections').value = values.join(',');
    document.getElementById('screening-list-display').textContent = values.length > 0 ? values.join(', ') : 'None';

    console.log('Screening selections updated:', values);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    updateStatusSelections();
    updateScreeningSelections();

    // Ensure buttons are properly initialized based on current selections
    const currentSelections = document.getElementById('screening-selections').value;
    if (currentSelections) {
        const selectedItems = currentSelections.split(',');
        document.querySelectorAll('#screening-buttons .screening-btn').forEach(btn => {
            const value = btn.dataset.value;
            if (selectedItems.includes(value)) {
                btn.classList.remove('btn-outline-primary');
                btn.classList.add('btn-primary');
            }
        });
    }

    // Custom status options handler
    const addCustomStatusBtn = document.getElementById('add_custom_status');
    const customStatusInput = document.getElementById('custom_status_input');
    const customStatusList = document.getElementById('custom_status_list');

    if (addCustomStatusBtn) {
        addCustomStatusBtn.addEventListener('click', function() {
            addCustomStatus();
        });
    }

    if (customStatusInput) {
        customStatusInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addCustomStatus();
            }
        });
    }

    // Add close button functionality to existing status items
    document.querySelectorAll('#custom_status_list .btn-close').forEach(button => {
        button.addEventListener('click', function() {
            const status = this.getAttribute('data-status');
            if (status) {
                removeCustomStatus(status, this.closest('.custom-status-item'));
            }
        });
    });

    // Function to add a new custom status
    function addCustomStatus() {
        const status = customStatusInput.value.trim();
        if (!status) return;

        // Check if status already exists
        const existingStatuses = Array.from(customStatusList.querySelectorAll('.custom-status-item input[name="custom_status_options"]'))
            .map(input => input.value);

        if (existingStatuses.includes(status)) {
            alert('This status option already exists');
            return;
        }

        // Create a new status item
        const statusItem = document.createElement('div');
        statusItem.className = 'custom-status-item badge bg-light text-dark p-2 d-flex align-items-center';
        statusItem.setAttribute('data-status', status);
        statusItem.innerHTML = `
            ${status}
            <button type="button" class="btn-close btn-close-dark ms-2 shadow-sm" style="background-color: #f8d7da; padding: 4px; border-radius: 50%;" aria-label="Remove" data-status="${status}"></button>
            <input type="hidden" name="custom_status_options" value="${status}">
        `;

        // Add remove functionality to the new button
        statusItem.querySelector('.btn-close').addEventListener('click', function() {
            removeCustomStatus(status, statusItem);
        });

        // Add to the list
        customStatusList.appendChild(statusItem);

        // Clear input
        customStatusInput.value = '';
        customStatusInput.focus();
    }

    // Function to remove a custom status
    function removeCustomStatus(status, element) {
        if (confirm(`Remove "${status}" from custom status options?`)) {
            element.remove();
        }
    }

    // Make functions available globally for form submission
    window.addCustomStatus = addCustomStatus;
    window.removeCustomStatus = removeCustomStatus;
});

// Function to update custom status options before form submission
function updateCustomStatusBeforeSubmit() {
    console.log('=== FORM SUBMISSION DEBUG ===');

    // Get all current custom status items
    const customStatusItems = document.querySelectorAll('#custom_status_list .custom-status-item input[name="custom_status_options"]');
    console.log(`Found ${customStatusItems.length} custom status options in DOM`);

    // List all items found in DOM
    customStatusItems.forEach((input, index) => {
        console.log(`DOM Custom status ${index + 1}: "${input.value}" (parent: ${input.closest('.custom-status-item').dataset.status})`);
    });

    // Check if any items are missing or duplicated
    const form = document.getElementById('status-form');
    const allCustomInputs = form.querySelectorAll('input[name="custom_status_options"]');
    console.log(`Total custom_status_options inputs in form: ${allCustomInputs.length}`);

    allCustomInputs.forEach((input, index) => {
        const isInCustomStatusItem = input.closest('.custom-status-item') !== null;
        console.log(`Form input ${index + 1}: "${input.value}" (in custom-status-item: ${isInCustomStatusItem})`);
    });

    // Final check - get all form data to see what's actually being submitted
    const formData = new FormData(form);
    const customStatusValues = formData.getAll('custom_status_options');
    console.log(`FormData will submit ${customStatusValues.length} custom status options:`, customStatusValues);

    if (customStatusValues.length === 0) {
        console.log('WARNING: No custom status options found in form data!');
    } else if (customStatusValues.length !== customStatusItems.length) {
        console.log(`WARNING: Mismatch between DOM items (${customStatusItems.length}) and FormData items (${customStatusValues.length})!`);
    }

    console.log('=== END FORM SUBMISSION DEBUG ===');

    return true; // Allow form submission to continue
}
</script>


    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<!-- Loading our custom modal handler script with a unique timestamp to prevent caching -->
<script src="{{ url_for('static', filename='js/screening_modals.js') }}?v={{ cache_timestamp|default(999999999) }}"></script>

<!-- Conditional JavaScript based on active tab -->
{% if active_tab == 'checklist' %}
<script>
    // Add user input tracking for screening cutoff fields
document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing user input tracking for screening cutoff fields...');

    const screeningInputs = document.querySelectorAll('.screening-cutoff');
    console.log(`Found ${screeningInputs.length} screening cutoff inputs`);

    screeningInputs.forEach(input => {
        // Store original value to detect changes
        if (!input.dataset.originalValue) {
            input.dataset.originalValue = input.value;
        }

        // Initialize user modification tracking
        if (!input.dataset.userModified) {
            input.dataset.userModified = 'false';
        }
        if (!input.dataset.presetModified) {
            input.dataset.presetModified = 'false';
        }

        console.log(`Initialized tracking for ${input.dataset.screeningName}: original=${input.dataset.originalValue}, current=${input.value}`);

        // Track when user manually changes the input
        input.addEventListener('input', function() {
            // Mark as user modified for any direct input
            this.dataset.userModified = 'true';
            // Clear any preset modification flag
            this.dataset.presetModified = 'false';
            console.log(`User input detected for ${this.dataset.screeningName}: ${this.value}`);
        });

        // Also track on change event
        input.addEventListener('change', function() {
            // Mark as user modified for any change unless it's clearly a preset
            if (this.dataset.presetModified !== 'true') {
                this.dataset.userModified = 'true';
                console.log(`User changed cutoff for ${this.dataset.screeningName}: ${this.value}`);
            }
            // Clear preset flag after processing
            this.dataset.presetModified = 'false';
        });

        // Track on focus to detect user interaction
        input.addEventListener('focus', function() {
            this.dataset.userFocused = 'true';
        });

        // Track actual typing/keystrokes
        input.addEventListener('keypress', function() {
            // Any keystroke indicates user modification
            this.dataset.userModified = 'true';
            this.dataset.presetModified = 'false';
            console.log(`User keystroke detected for ${this.dataset.screeningName}`);
        });

        // Track on blur to clear focus flag
        input.addEventListener('blur', function() {
            this.dataset.userFocused = 'false';
        });
    });
});

    // Custom status options handler
    document.addEventListener('DOMContentLoaded', function() {
        // Update selections whenever checkboxes change
        document.addEventListener('change', function(e) {
            if (e.target.matches('#status-options-grid input[type="checkbox"]')) {
                updateStatusSelections();
            }
        });

        // Reset button functionality
        document.getElementById('reset-status-options').addEventListener('click', function() {
            // Uncheck all checkboxes
            document.querySelectorAll('#status-options-grid input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateStatusSelections();
        });

        // Custom status options handler
        const addCustomStatusBtn = document.getElementById('add_custom_status');
        const customStatusInput = document.getElementById('custom_status_input');
        const customStatusList = document.getElementById('custom_status_list');

        if (addCustomStatusBtn) {
            addCustomStatusBtn.addEventListener('click', function() {
                addCustomStatus();
            });
        }

        if (customStatusInput) {
            customStatusInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addCustomStatus();
                }
            });
        }

        // Add close button functionality to existing status items
        document.querySelectorAll('.btn-close').forEach(button => {
            button.addEventListener('click', function() {
                const status = this.getAttribute('data-status');
                if (status) {
                    removeCustomStatus(status, this.closest('.custom-status-item'));
                }
            });
        });

        // Function to add a new custom status
        function addCustomStatus() {
            const status = customStatusInput.value.trim();
            if (!status) return;

            // Check if status already exists
            const existingStatuses = Array.from(customStatusList.querySelectorAll('.custom-status-item'))
                .map(item => item.querySelector('input').value);

            if (existingStatuses.includes(status)) {
                alert('This status option already exists');
                return;
            }

            // Create a new status item
            const statusItem = document.createElement('div');
            statusItem.className = 'custom-status-item badge bg-light text-dark p-2 d-flex align-items-center';
            statusItem.innerHTML = `
                ${status}
                <button type="button" class="btn-close btn-close-dark ms-2 shadow-sm" style="background-color: #f8d7da; padding: 4px; border-radius: 50%;" aria-label="Remove" data-status="${status}"></button>
                <input type="hidden" name="custom_status_options" value="${status}">
            `;

            // Add remove functionality to the new button
            statusItem.querySelector('.btn-close').addEventListener('click', function() {
                removeCustomStatus(status, statusItem);
            });

            // Add to the list
            customStatusList.appendChild(statusItem);

            // Clear input
            customStatusInput.value = '';
            customStatusInput.focus();
        }

        // Function to remove a custom status
        function removeCustomStatus(status, element) {
            if (confirm(`Remove "${status}" from custom status options?`)) {
                element.remove();
            }
        }
    });

    // Trigger Conditions Management
    window.triggerConditionsData = {
        'add-form': [],
        'edit-form': []
    };

    window.addTriggerCondition = function(formType) {
        const systemSelect = document.getElementById(`${formType}-condition-system`);
        const codeInput = document.getElementById(`${formType}-condition-code`);
        const displayInput = document.getElementById(`${formType}-condition-display`);

        const system = systemSelect.value;
        const code = codeInput.value.trim();
        const display = displayInput.value.trim();

        if (!code || !display) {
            alert('Please enter both condition code and display name');
            return;
        }

        const condition = {
            system: system,
            code: code,
            display: display
        };

        // Add to data array
        if (!window.triggerConditionsData[formType]) {
            window.triggerConditionsData[formType] = [];
        }
        window.triggerConditionsData[formType].push(condition);

        // Update hidden input
        document.getElementById(`${formType}-trigger-conditions-data`).value = JSON.stringify(window.triggerConditionsData[formType]);

        // Update display
        renderTriggerConditions(formType);

        // Clear inputs
        codeInput.value = '';
        displayInput.value = '';
    };

    window.removeTriggerCondition = function(formType, index) {
        if (window.triggerConditionsData[formType]) {
            window.triggerConditionsData[formType].splice(index, 1);
            document.getElementById(`${formType}-trigger-conditions-data`).value = JSON.stringify(window.triggerConditionsData[formType]);
            renderTriggerConditions(formType);
        }
    };

    function renderTriggerConditions(formType) {
        const container = document.getElementById(`${formType}-trigger-conditions-list`);
        if (!container) return;

        const conditions = window.triggerConditionsData[formType] || [];

        if (conditions.length === 0) {
            container.innerHTML = '<div class="text-muted small">No trigger conditions added</div>';
            return;
        }

        let html = '';
        conditions.forEach((condition, index) => {
            html += `
                <div class="d-flex justify-content-between align-items-center mb-2 p-2 bg-white border rounded">
                    <div class="flex-grow-1">
                        <strong>${condition.display}</strong><br>
                        <small class="text-muted">${condition.code} (${getSystemDisplayName(condition.system)})</small>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeTriggerCondition('${formType}', ${index})">
                        Remove
                    </button>
                </div>
            `;
        });

        container.innerHTML = html;
    }

    function getSystemDisplayName(system) {
        const systemNames = {
            'http://snomed.info/sct': 'SNOMED CT',
            'http://hl7.org/fhir/sid/icd-10-cm': 'ICD-10-CM',
            'http://hl7.org/fhir/sid/icd-9-cm': 'ICD-9-CM',
            'custom': 'Custom'
        };
        return systemNames[system] || system;
    }

    window.loadTriggerConditionsForEdit = function(triggerConditionsJson) {
        try {
            const conditions = triggerConditionsJson ? JSON.parse(triggerConditionsJson) : [];
            window.triggerConditionsData['edit-form'] = conditions;
            document.getElementById('edit-form-trigger-conditions-data').value = triggerConditionsJson || '';
            renderTriggerConditions('edit-form');
        } catch (e) {
            console.error('Error parsing trigger conditions:', e);
            window.triggerConditionsData['edit-form'] = [];
            renderTriggerConditions('edit-form');
        }
    };

    // Clear trigger conditions when modals close
    const addModal = document.getElementById('addScreeningTypeModal');
    // Edit modal removed - now redirects to dedicated edit page

    if (addModal) {
        addModal.addEventListener('hidden.bs.modal', function() {
            window.triggerConditionsData['add-form'] = [];
            const dataInput = document.getElementById('add-form-trigger-conditions-data');
            if (dataInput) dataInput.value = '';
            renderTriggerConditions('add-form');
        });
    }

    if (editModal) {
        editModal.addEventListener('hidden.bs.modal', function() {
            window.triggerConditionsData['edit-form'] = [];
            const dataInput = document.getElementById('edit-form-trigger-conditions-data');
            if (dataInput) dataInput.value = '';
            renderTriggerConditions('edit-form');
        });
    }

    // Initialize trigger conditions displays
    renderTriggerConditions('add-form');
    renderTriggerConditions('edit-form');

    // Handle edit screening type button clicks
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('edit-screening-type-btn')) {
            const button = e.target;
            const id = button.getAttribute('data-id');
            const name = button.getAttribute('data-name');
            const frequency = button.getAttribute('data-frequency');
            const gender = button.getAttribute('data-gender');
            const minAge = button.getAttribute('data-min-age');
            const maxAge = button.getAttribute('data-max-age');
            const active = button.getAttribute('data-active') === '1';
            const triggerConditions = button.getAttribute('data-trigger-conditions');

            // Set form values
            const form = document.getElementById('editScreeningTypeForm');
            form.action = `/screening-types/${id}/edit?ts=${Date.now()}`;

            document.getElementById('edit-name').value = name;
            document.getElementById('edit-frequency').value = frequency || '';
            document.getElementById('edit-gender').value = gender || '';
            document.getElementById('edit-min-age').value = minAge || '';
            document.getElementById('edit-max-age').value = maxAge || '';
            document.getElementById('edit-active').checked = active;

            // Load trigger conditions
            window.loadTriggerConditionsForEdit(triggerConditions);

            // Load keywords (existing functionality)
            if (window.keywordManagers && window.keywordManagers.edit) {
                window.keywordManagers.edit.loadKeywords(id);
            }
        }
    });
</script>
{% endif %}
{% endblock %}

{% block extra_styles %}
<style>
    /* Override any colored backgrounds for the screening table */
    .table-danger, 
    .table-warning,
    .table-info,
    .table-success,
    .table tbody tr.table-danger,
    .table tbody tr.table-warning {
        background-color: transparent !important;
    }

    /* Add some extra styling to make badges stand out better */
    .badge {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }

    /* Modal styling */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1050;
        width: 100%;
        height: 100%;
        overflow: hidden;
        outline: 0;
    }

    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1040;
        width: 100vw;
        height: 100vh;
        background-color: #000;
        background-color: #000;
    }

    .modal-backdrop.fade {
        opacity: 0;
    }

    .modal-backdrop.show {
        opacity: 0.5;
    }
</style>

<!-- Keyword Management Modal -->
<div class="modal fade" id="keywordManagerModal" tabindex="-1" aria-labelledby="keywordManagerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="keywordManagerModalLabel">Manage Keywords</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <strong>Document Matching Strategy:</strong> Keywords help identify relevant documents for screening types. 
                    The system uses FHIR codes first, then filename/section detection, and finally these user-defined keywords as fallback.
                </div>

                <div class="mb-3">
                    <label class="form-label">Add New Keyword</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="newKeywordInput" placeholder="Enter keyword">
                        <button class="btn btn-primary" type="button" onclick="addKeyword()"><i class="fas fa-plus"></i> Add</button>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Current Keywords</label>
                    <div id="keywordsList" class="border rounded p-3 min-height-100 bg-light">
                        <div class="text-muted text-center">Loading keywords...</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveKeywords()">Save Keywords</button>
            </div>
        </div>
    </div>

</div>

<!-- Keyword Management JavaScript -->
<script>
let currentScreeningTypeId = null;
let currentKeywords = [];





// Open keyword manager modal
function openKeywordManager(screeningTypeId, screeningName) {
    currentScreeningTypeId = screeningTypeId;
    document.getElementById('keywordManagerModalLabel').textContent = `Manage Keywords - ${screeningName}`;

    // Load existing keywords
    fetch(`/api/screening-keywords/${screeningTypeId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentKeywords = data.keywords || [];
                displayKeywords();
            } else {
                console.error('Error loading keywords:', data.error);
                currentKeywords = [];
                displayKeywords();
            }
        })
        .catch(error => {
            console.error('Error loading keywords:', error);
            currentKeywords = [];
            displayKeywords();
        });

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('keywordManagerModal'));
    modal.show();
}

// Display keywords in the modal
function displayKeywords() {
    const container = document.getElementById('keywordsList');
    if (currentKeywords.length === 0) {
        container.innerHTML = '<div class="text-muted text-center">No keywords defined yet</div>';
        return;
    }

    const keywordsHtml = currentKeywords.map((keyword, index) => 
        `<span class="badge bg-primary me-2 mb-2">
            ${keyword}
            <button type="button" class="btn-close btn-close-white ms-1" 
                    onclick="removeKeyword(${index})" aria-label="Remove"></button>
        </span>`
    ).join('');

    container.innerHTML = keywordsHtml;
}

// Add keyword
function addKeyword() {
    const input = document.getElementById('newKeywordInput');
    const keyword = input.value.trim();

    if (keyword && !currentKeywords.includes(keyword)) {
        currentKeywords.push(keyword);
        displayKeywords();
        input.value = '';
    }
}

// Remove keyword
function removeKeyword(index) {
    currentKeywords.splice(index, 1);
    displayKeywords();
}

// Save keywords
function saveKeywords() {
    // Convert simple keyword list to proper format for the API
    const keywordObjects = currentKeywords.map(keyword => ({
        keyword: keyword,
        section: 'general',
        weight: 1.0,
        case_sensitive: false,
        exact_match: false,
        description: `Keyword for screening type`
    }));

    fetch(`/api/screening-keywords/${currentScreeningTypeId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrf_token]').value
        },
        body: JSON.stringify({ keywords: keywordObjects })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('keywordManagerModal'));
            modal.hide();

            // Refresh the keywords display
            loadKeywordsAsBadges();

            // Show success message
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show';
            alert.innerHTML = `
                Keywords updated successfully!
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.container').insertBefore(alert, document.querySelector('.container').firstChild);

            // Auto-dismiss the alert after 3 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 3000);
        } else {
            alert('Error saving keywords: ' + (data.message || data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error saving keywords:', error);
        alert('Error saving keywords. Please try again.');
    });
}

// Add keyword to form (for add/edit modals)
function addKeywordToForm(formPrefix) {
    const input = document.getElementById(`${formPrefix}-keyword-input`);
    const keyword = input.value.trim();

    if (keyword) {
        const container = document.getElementById(`${formPrefix}-keywords-list`);
        const keywordElement = document.createElement('span');
        keywordElement.className = 'badge bg-primary me-2 mb-2';
        keywordElement.innerHTML = `
            ${keyword}
            <button type="button" class="btn-close btn-close-white ms-1" 
                    onclick="removeFormKeyword(this)" aria-label="Remove"></button>
        `;
        container.appendChild(keywordElement);
        input.value = '';
        updateFormKeywordsData(formPrefix);
    }
}

// Remove keyword from form
function removeFormKeyword(button) {
    const keywordElement = button.closest('.badge');
    const formPrefix = keywordElement.closest('[id$="-keywords-container"]').id.replace('-keywords-container', '');
    keywordElement.remove();
    updateFormKeywordsData(formPrefix);
}

// Update hidden form data
function updateFormKeywordsData(formPrefix) {
    const container = document.getElementById(`${formPrefix}-keywords-list`);
    const keywords = Array.from(container.querySelectorAll('.badge')).map(badge => {
        // Get only the text content, excluding the close button
        const clone = badge.cloneNode(true);
        const closeButton = clone.querySelector('.btn-close');
        if (closeButton) {
            closeButton.remove();
        }
        return clone.textContent.trim();
    }).filter(keyword => keyword !== '');
    const hiddenInput = document.getElementById(`${formPrefix}-keywords-data`);
    if (hiddenInput) {
        hiddenInput.value = JSON.stringify(keywords);
    }
}

// Handle Enter key in keyword inputs
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Content Loaded - checking for keyword displays...');

    // Initialize keyword display
    initializeKeywordDisplay();

    // Handle Enter key in main keyword input
    document.getElementById('newKeywordInput')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            addKeyword();
        }
    });

    // Handle Enter key in form keyword inputs
    document.querySelectorAll('[id$="-keyword-input"]').forEach(input => {
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const formPrefix = this.id.replace('-keyword-input', '');
                addKeywordToForm(formPrefix);
            }
        });
    });


});


</script>

<style>
.keywords-list {
    min-height: 60px;
}
.min-height-100 {
    min-height: 100px;
}
.btn-close-white {
    filter: invert(1) grayscale(100%) brightness(200%);
}
.keywords-badges-container {
    line-height: 1.5;
}
.keywords-badges-container .badge {
    font-size: 0.75rem;
    margin-bottom: 2px;
}
</style>
{% endblock %}