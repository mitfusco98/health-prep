{% extends 'base_demo.html' %}

{% block title %}HealthPrep - Screening List{% endblock %}

{% block extra_js %}
<script>
// Load keywords and display as badges
function loadKeywordsAsBadges() {
    const keywordContainers = document.querySelectorAll('.keywords-badges-container');
    console.log(`loadKeywordsAsBadges: Found ${keywordContainers.length} keyword containers to load`);

    keywordContainers.forEach(container => {
        const screeningTypeId = container.id.replace('keywords-display-', '');

        console.log(`loadKeywordsAsBadges: Loading keywords for screening ${screeningTypeId}`);

        fetch(`/api/screening-keywords/${screeningTypeId}`)
            .then(response => {
                console.log(`loadKeywordsAsBadges: API response status for screening ${screeningTypeId}: ${response.status}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(`Received keywords data for screening ${screeningTypeId}:`, data);
                if (data.success && data.keywords && Array.isArray(data.keywords) && data.keywords.length > 0) {
                    // Display keywords as badges
                    const keywordsHtml = data.keywords.map(keyword => 
                        `<span class="badge bg-primary me-1 mb-1">${keyword}</span>`
                    ).join('');
                    container.innerHTML = keywordsHtml;

                    console.log(`Successfully updated keywords display for screening ${screeningTypeId} with ${data.keywords.length} keywords`);
                } else {
                    // Show no keywords message
                    container.innerHTML = '<small class="text-muted">No keywords defined</small>';
                    console.log(`No keywords found for screening ${screeningTypeId}`);
                }
            })
            .catch(error => {
                console.error(`Error loading keywords for screening ${screeningTypeId}:`, error);
                container.innerHTML = '<small class="text-danger">Error loading keywords</small>';
            });
    });
}

// Initialize keyword display when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Content Loaded - checking for keyword containers...');

    // Check if keyword containers exist
    const hasKeywordContainers = document.querySelectorAll('.keywords-badges-container').length > 0;

    if (hasKeywordContainers) {
        console.log('Loading keywords for display...');
        // Load keywords immediately
        loadKeywordsAsBadges();

        // Also load after a delay to ensure DOM is fully ready
        setTimeout(() => {
            loadKeywordsAsBadges();
        }, 1000);
    } else {
        console.log('No keyword containers found - skipping keyword loading');
    }
});
</script>
{% endblock %}

{% block extra_css %}
<style>
/* Override for buttons - added May 18, 2025 */
.btn .fas, .btn .fa {
    display: none !important;
}
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h1>Screening List</h1>
        <p class="lead">View and manage patient screening recommendations</p>
    </div>
</div>

<!-- Nav Tabs -->
<ul class="nav nav-tabs mb-3">
    <li class="nav-item">
        <a class="nav-link {% if active_tab == 'screenings' %}active{% endif %}" href="{{ url_for('screening_list', tab='screenings', search=search_query) }}">
            Screening List
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if active_tab == 'types' %}active{% endif %}" href="{{ url_for('screening_list', tab='types', search=search_query) }}">
            Manage Screening Types
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if active_tab == 'checklist' %}active{% endif %}" href="{{ url_for('screening_list', tab='checklist', search=search_query) }}">
            Prep Sheet Settings
        </a>
    </li>
</ul>

<!-- Tab Content -->
{% if active_tab == 'screenings' %}
<!-- Due Screenings Tab Content -->
<div class="card border-0">
    <div class="card-header bg-secondary bg-opacity-25">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="mb-0">
                    <i class="fas fa-clipboard-check me-1"></i><i class="fas fa-cog me-2"></i>Screening List
                </h5>
            </div>
            <div class="col-auto d-flex">
                <form class="d-flex me-2" method="get">
                    <input type="hidden" name="tab" value="screenings">
                    <input class="form-control me-2" type="search" placeholder="Search patient or screening" name="search" value="{{ search_query }}">
                    <button class="btn btn-outline-secondary" type="submit">Search</button>
                </form>
                <a href="{{ url_for('add_screening_form') }}" class="btn btn-primary">
                    Add Screening
                </a>
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        {% if screenings %}
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0">
                <thead>
                    <tr>
                        <th>Patient</th>
                        <th>Screening</th>
                        <th>Due Date</th>
                        <th>Last Completed</th>
                        <th>Priority</th>
                        <th width="150">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for screening in screenings %}
                    <tr>
                        <td>
                            <a href="{{ url_for('patient_detail', patient_id=screening.patient.id) }}">
                                {{ screening.patient.full_name }}
                            </a>
                        </td>
                        <td>{{ screening.screening_type }}</td>
                        <td>
                            {% if screening.due_date %}
                                {{ screening.due_date.strftime('%m/%d/%Y') }}
                                {% if screening.due_date < today %}
                                    <span class="badge bg-danger">Overdue</span>
                                {% elif (screening.due_date - today).days <= 30 %}
                                    <span class="badge bg-warning">Due Soon</span>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">Not set</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if screening.last_completed %}
                                {{ screening.last_completed.strftime('%m/%d/%Y') }}
                            {% else %}
                                <span class="text-muted">Unknown</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if screening.priority == 'High' %}
                                <span class="badge bg-danger">High</span>
                            {% elif screening.priority == 'Medium' %}
                                <span class="badge bg-warning">Medium</span>
                            {% elif screening.priority == 'Low' %}
                                <span class="badge bg-info">Low</span>
                            {% else %}
                                <span class="badge bg-secondary">None</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-outline-primary edit-screening-btn" 
                                   data-bs-toggle="modal" data-bs-target="#editScreeningModal"
                                   data-id="{{ screening.id }}"
                                   data-patient-id="{{ screening.patient.id }}"
                                   data-patient-name="{{ screening.patient.full_name }}"
                                   data-screening-type="{{ screening.screening_type }}"
                                   data-due-date="{{ screening.due_date.strftime('%Y-%m-%d') if screening.due_date else '' }}"
                                   data-last-completed="{{ screening.last_completed.strftime('%Y-%m-%d') if screening.last_completed else '' }}"
                                   data-frequency="{{ screening.frequency or '' }}"
                                   data-priority="{{ screening.priority or '' }}"
                                   data-notes="{{ screening.notes or '' }}">
                                    <i class="fas fa-edit me-1"></i>Edit
                                </button>
                                <a href="{{ url_for('delete_screening', patient_id=screening.patient.id, screening_id=screening.id, ts=cache_timestamp) }}" class="btn btn-sm btn-outline-danger" 
                                   onclick="return confirm('Are you sure you want to delete this screening record?');">
                                    <i class="fas fa-trash-alt me-1"></i>Delete
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <p class="text-muted mb-0">No screenings found {% if search_query %}matching "{{ search_query }}"{% endif %}</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add Screening Recommendation Modal -->
<div class="modal fade" id="addScreeningRecommendationModal" tabindex="-1" aria-labelledby="addScreeningRecommendationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addScreeningRecommendationModalLabel">Add Screening Recommendation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('add_screening_recommendation', ts=cache_timestamp) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Patient <span class="text-danger">*</span></label>
                        <select class="form-select" name="patient_id" id="patient" required>
                            <option value="">Select a patient</option>
                            {% for patient in patients %}
                                <option value="{{ patient.id }}">{{ patient.full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Screening Type <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="screening_type" id="screening_type" required list="screening-types-list">
                        <datalist id="screening-types-list">
                            {% for type in all_screening_types %}
                                <option value="{{ type.name }}">
                            {% endfor %}
                        </datalist>
                        <small class="text-muted">Type or select from available screening types</small>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Due Date</label>
                                <input type="date" class="form-control" name="due_date">
                                <small class="text-muted">When should this screening be completed</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Last Completed</label>
                                <input type="date" class="form-control" name="last_completed">
                                <small class="text-muted">When was this screening last done</small>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Frequency</label>
                                <input type="text" class="form-control" name="frequency" placeholder="e.g. Annual, Every 5 years">
                                <small class="text-muted">How often this screening should be done</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Priority</label>
                                <select class="form-select" name="priority">
                                    <option value="">Select priority</option>
                                    <option value="High">High</option>
                                    <option value="Medium">Medium</option>
                                    <option value="Low">Low</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" name="notes" rows="3"></textarea>
                        <small class="text-muted">Any additional information about this screening recommendation</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Screening Modal -->
<div class="modal fade" id="editScreeningModal" tabindex="-1" aria-labelledby="editScreeningModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editScreeningModalLabel">Edit Screening Recommendation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" id="editScreeningForm" action="">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="patient_id" id="edit-patient-id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Patient</label>
                        <p class="form-control-plaintext" id="edit-patient-name"></p>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Screening Type <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="screening_type" id="edit-screening-type" required list="screening-types-list">
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Due Date</label>
                                <input type="date" class="form-control" name="due_date" id="edit-due-date">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Last Completed</label>
                                <input type="date" class="form-control" name="last_completed" id="edit-last-completed">
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Frequency</label>
                                <input type="text" class="form-control" name="frequency" id="edit-frequency">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Priority</label>
                                <select class="form-select" name="priority" id="edit-priority">
                                    <option value="">Select priority</option>
                                    <option value="High">High</option>
                                    <option value="Medium">Medium</option>
                                    <option value="Low">Low</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" name="notes" id="edit-notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% elif active_tab == 'types' %}
<!-- Screening Types Tab Content -->
<div class="card border-0">
    <div class="card-header bg-secondary bg-opacity-25">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="mb-0">
                    <i class="fas fa-cog me-2"></i>Screening Types
                </h5>
            </div>
            <div class="col-auto d-flex">
                <form class="d-flex me-2" method="get">
                    <input type="hidden" name="tab" value="types">
                    <input class="form-control me-2" type="search" placeholder="Search screening types" name="search" value="{{ search_query }}">
                    <button class="btn btn-outline-secondary" type="submit">Search</button>
                </form>


                <a href="{{ url_for('add_screening_type_form') }}" class="btn btn-primary">
                    Add Type
                </a>
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        {% if screening_types %}
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0">
                <thead>
                    <tr>
                        <th>Name & Keywords</th>
                        <th>Frequency</th>
                        <th>Gender Specific</th>
                        <th>Age Range</th>
                        <th>Trigger Conditions</th>
                        <th>Status</th>
                        <th width="200">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for screening_type in screening_types %}
                    <tr>
                        <td>
                            <div>
                                <div>
                                    <strong>{{ screening_type.name }}</strong>
                                </div>
                                <div class="mt-1">
                                    <div id="keywords-display-{{ screening_type.id }}" class="keywords-badges-container">
                                        <small class="text-muted">Loading keywords...</small>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td>{{ screening_type.formatted_frequency }}</td>
                        <td>
                            {% if screening_type.gender_specific %}
                                {{ screening_type.gender_specific }}
                            {% else %}
                                All Genders
                            {% endif %}
                        </td>
                        <td>
                            {% if screening_type.min_age and screening_type.max_age %}
                                Ages {{ screening_type.min_age }} to {{ screening_type.max_age }}
                            {% elif screening_type.min_age %}
                                Age {{ screening_type.min_age }}+
                            {% elif screening_type.max_age %}
                                Up to age {{ screening_type.max_age }}
                            {% else %}
                                All Ages
                            {% endif %}
                        </td>
                        <td>
                            {% set trigger_conditions = screening_type.get_trigger_conditions() %}
                            {% if trigger_conditions %}
                                <div class="d-flex flex-wrap gap-1">
                                    {% for condition in trigger_conditions[:3] %}
                                        <span class="badge bg-info text-dark small" title="{{ condition.display }} ({{ condition.code }})">
                                            {{ condition.display|truncate(20) }}
                                        </span>
                                    {% endfor %}
                                    {% if trigger_conditions|length > 3 %}
                                        <span class="badge bg-light text-dark small">+{{ trigger_conditions|length - 3 }} more</span>
                                    {% endif %}
                                </div>
                            {% else %}
                                <small class="text-muted">None</small>
                            {% endif %}
                        </td>
                        <td>
                            {% if screening_type.is_active %}
                                <span class="badge bg-success">Active</span>
                            {% else %}
                                <span class="badge bg-secondary">Inactive</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <a href="{{ url_for('edit_screening_type', screening_type_id=screening_type.id) }}" 
                                   class="btn btn-sm btn-outline-primary">
                                    Edit
                                </a>
                                <a href="{{ url_for('delete_screening_type', screening_type_id=screening_type.id, ts=cache_timestamp) }}" class="btn btn-sm btn-outline-danger" 
                                   onclick="return confirm('Are you sure you want to delete this screening type?');">
                                    Delete
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <p class="text-muted mb-0">No screening types found {% if search_query %}matching "{{ search_query }}"{% endif %}</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add Screening Type Modal -->
<div class="modal fade" id="addScreeningTypeModal" tabindex="-1" aria-labelledby="addScreeningTypeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addScreeningTypeModalLabel">Add Screening Type</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('add_screening_type', ts=cache_timestamp) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="name" required>
                        <small class="text-muted">Name of the screening (e.g., 'Mammogram', 'Colonoscopy')</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Keywords for Document Matching</label>
                        <div class="border rounded p-3 bg-light">
                            <div id="add-form-keywords-container">
                                <div class="d-flex mb-2">
                                    <input type="text" class="form-control me-2" id="add-form-keyword-input" placeholder="Enter keyword">
                                    <button type="button" class="btn btn-outline-primary" onclick="addKeywordToForm('add-form')">Add</button>
                                </div>
                                <div id="add-form-keywords-list" class="keywords-list"></div>
                            </div>
                        </div>
                        <small class="text-muted">Keywords help identify relevant documents for this screening type</small>
                        <input type="hidden" name="keywords" id="add-form-keywords-data">
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Default Frequency</label>
                                <input type="text" class="form-control" name="default_frequency">
                                <small class="text-muted">How often this screening should be done (e.g., 'Annual', 'Every 5 years')</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Gender Specific</label>
                                <select class="form-select" name="gender_specific">
                                    <option value="">All Genders</option>
                                    <option value="Male">Male Only</option>
                                    <option value="Female">Female Only</option>
                                </select>
                                <small class="text-muted">Is this screening specific to a particular gender?</small>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Minimum Age</label>
                                <input type="number" class="form-control" name="min_age" min="0" max="120">
                                <small class="text-muted">Minimum age to start this screening</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Maximum Age</label>
                                <input type="number" class="form-control" name="max_age" min="0" max="120">
                                <small class="text-muted">Maximum age for this screening (leave blank if no upper limit)</small>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Trigger Conditions (FHIR)</label>
                        <div class="border rounded p-3 bg-light">
                            <div id="add-form-trigger-conditions-container">
                                <div class="d-flex mb-2">
                                    <select class="form-select me-2" id="add-form-condition-system" style="max-width: 200px;">
                                        <option value="http://snomed.info/sct">SNOMED CT</option>
                                        <option value="http://hl7.org/fhir/sid/icd-10-cm">ICD-10-CM</option>
                                        <option value="http://hl7.org/fhir/sid/icd-9-cm">ICD-9-CM</option>
                                        <option value="custom">Custom</option>
                                    </select>
                                    <input type="text" class="form-control me-2" id="add-form-condition-code" placeholder="Condition code">
                                    <input type="text" class="form-control me-2" id="add-form-condition-display" placeholder="Display name">
                                    <button type="button" class="btn btn-outline-primary" onclick="addTriggerCondition('add-form')">Add</button>
                                </div>
                                <div id="add-form-trigger-conditions-list" class="trigger-conditions-list"></div>
                            </div>
                        </div>
                        <small class="text-muted">Medical conditions that should trigger this screening recommendation</small>
                        <input type="hidden" name="trigger_conditions" id="add-form-trigger-conditions-data">
                    </div>

                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="is_active" id="isActive" checked>
                        <label class="form-check-label" for="isActive">
                            Active
                        </label>
                        <div class="form-text">Whether this screening should appear in checklists</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>


{% elif active_tab == 'checklist' %}
<!-- Checklist Settings Tab Content -->
<div class="card">
    <div class="card-body">
        <p class="text-muted mb-4">These settings control the layout and content generation of the screening checklist section in patient prep sheets.</p>

        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">Display Options</h6>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('update_checklist_settings') }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                            <div class="mb-3">
                                <label class="form-label">Status Options</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="status_due" name="status_options" value="due" 
                                        {% if settings and 'due' in settings.status_options_list %}checked{% endif %}>
                                    <label class="form-check-label" for="status_due">Due</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="status_due_soon" name="status_options" value="due_soon"
                                        {% if settings and 'due_soon' in settings.status_options_list %}checked{% endif %}>
                                    <label class="form-check-label" for="status_due_soon">Due Soon</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="status_sent" name="status_options" value="sent_incomplete"
                                        {% if settings and 'sent_incomplete' in settings.status_options_list %}checked{% endif %}>
                                    <label class="form-check-label" for="status_sent">Sent & Incomplete</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="status_completed" name="status_options" value="completed"
                                        {% if settings and 'completed' in settings.status_options_list %}checked{% endif %}>
                                    <label class="form-check-label" for="status_completed">Completed</label>
                                </div>
                                <div class="mt-3">
                                    <label class="form-label">Custom Status Options</label>
                                    <div class="input-group mb-2">
                                        <input type="text" class="form-control" id="custom_status_input" placeholder="Add custom status option...">
                                        <button class="btn btn-outline-primary" type="button" id="add_custom_status">Add</button>
                                    </div>
                                    <div class="form-text mb-2">Add your own status options to appear in autocomplete</div>
                                    <div id="custom_status_list" class="d-flex flex-wrap gap-2 mb-2">
                                        {% if settings and settings.custom_status_list %}
                                            {% for status in settings.custom_status_list %}
                                                <div class="custom-status-item badge bg-light text-dark p-2 d-flex align-items-center">
                                                    {{ status }}
                                                    <button type="button" class="btn-close btn-close-dark ms-2 shadow-sm" style="background-color: #f8d7da; padding: 4px; border-radius: 50%;" aria-label="Remove" data-status="{{ status }}"></button>
                                                    <input type="hidden" name="custom_status_options" value="{{ status }}">
                                                </div>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary">Save Display Settings</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">Checklist Content Generation</h6>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('update_checklist_generation') }}" id="checklistForm">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                            <div class="mb-3">
                                <label class="form-label">Content Sources</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="source_db" name="content_sources" value="database"
                                        {% if settings and 'database' in settings.content_sources_list %}checked{% endif %}>
                                    <label class="form-check-label" for="source_db">Default Items</label>
                                    <div class="form-text">Include default items specified below</div>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="source_existing" name="content_sources" value="existing_screenings"
                                        {% if settings and 'existing_screenings' in settings.content_sources_list %}checked{% endif %}>
                                    <label class="form-check-label" for="source_existing">Patient Screenings</label>
                                    <div class="form-text">Include screenings already assigned to the patient</div>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="source_age" name="content_sources" value="age_based"
                                        {% if settings and 'age_based' in settings.content_sources_list %}checked{% endif %}>
                                    <label class="form-check-label" for="source_age">Age-Based Recommendations</label>
                                    <div class="form-text">Include screenings based on patient age</div>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="source_gender" name="content_sources" value="gender_based"
                                        {% if settings and 'gender_based' in settings.content_sources_list %}checked{% endif %}>
                                    <label class="form-check-label" for="source_gender">Gender-Specific Screenings</label>
                                    <div class="form-text">Include screenings based on patient gender</div>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox"id="source_condition" name="content_sources" value="condition_based"
                                        {% if settings```text
 and 'condition_based' in settings.content_sources_list %}checked{% endif %}>
                                    <label class="form-check-label" for="source_condition">Condition-Specific Screenings</label>
                                    <div class="form-text">Include screenings based on patient conditions</div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Default Items</label>
                                <div class="screening-types-checklist">
                                    {% if active_screening_types %}
                                        {% set default_items_list = settings.default_items_list if settings else [] %}
                                        {% for screening_type in active_screening_types %}
                                        <div class="form-check mb-2">
                                            <input 
                                                class="form-check-input screening-type-checkbox" 
                                                type="checkbox" 
                                                value="{{ screening_type.name }}" 
                                                id="screening_{{ screening_type.id }}" 
                                                name="selected_screening_types[]"
                                                {% if screening_type.name in default_items_list %}checked{% endif %}>
                                            <label class="form-check-label" for="screening_{{ screening_type.id }}">
                                                <strong>{{ screening_type.name }}</strong>
                                                {% if screening_type.description %}
                                                <small class="text-muted d-block">{{ screening_type.description }}</small>
                                                {% endif %}
                                                <small class="text-info">
                                                    {% if screening_type.formatted_frequency %}{{ screening_type.formatted_frequency }}{% endif %}
                                                    {% if screening_type.gender_specific %} • {{ screening_type.gender_specific }} only{% endif %}
                                                    {% if screening_type.min_age or screening_type.max_age %} • Ages {{ screening_type.min_age or 0 }}-{{ screening_type.max_age or '∞' }}{% endif %}
                                                </small>
                                            </label>
                                        </div>
                                        {% endfor %}
                                    {% else %}
                                        <p class="text-muted">No active screening types found. <a href="{{ url_for('screening_list', tab='types') }}">Add screening types</a> to configure quality checklist items.</p>
                                    {% endif %}
                                </div>
                                <div class="form-text">Default items to include in every patient's checklist</div>
                            </div>

                            <button type="submit" class="btn btn-primary">Save Generation Settings</button>