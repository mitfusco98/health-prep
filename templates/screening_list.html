{% extends "base_demo.html" %}

{% block content %}
<div class="container-fluid">
    <!-- Tab Navigation -->
    <ul class="nav nav-tabs mb-4" id="screeningTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link {{ 'active' if active_tab == 'patients' else '' }}" 
                    id="patients-tab" data-bs-toggle="tab" data-bs-target="#patients" 
                    type="button" role="tab" aria-controls="patients" aria-selected="{{ 'true' if active_tab == 'patients' else 'false' }}">
                Patient Screenings
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link {{ 'active' if active_tab == 'types' else '' }}" 
                    id="types-tab" data-bs-toggle="tab" data-bs-target="#types" 
                    type="button" role="tab" aria-controls="types" aria-selected="{{ 'true' if active_tab == 'types' else 'false' }}">
                Manage Screening Types
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="screeningTabContent">
        <!-- Patient Screenings Tab -->
        <div class="tab-pane fade {{ 'show active' if active_tab == 'patients' else '' }}" 
             id="patients" role="tabpanel" aria-labelledby="patients-tab">

            {% if active_tab == 'patients' %}
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>Patient Screenings</h1>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addScreeningModal">
                    <i class="fas fa-plus me-1"></i> Add Screening
                </button>
            </div>

            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Due Screenings</h5>
                </div>
                <div class="card-body">
                    {% if screenings %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Patient</th>
                                        <th>Screening Type</th>
                                        <th>Due Date</th>
                                        <th>Last Completed</th>
                                        <th>Priority</th>
                                        <th>Notes</th>
                                        <th width="150">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for screening in screenings %}
                                        <tr class="{{ 'table-danger' if screening.is_overdue() else 'table-warning' if screening.is_due_soon() else '' }}">
                                            <td>
                                                <a href="{{ url_for('patient_detail', patient_id=screening.patient.id) }}">
                                                    {{ screening.patient.first_name }} {{ screening.patient.last_name }}
                                                </a>
                                            </td>
                                            <td>{{ screening.screening_type }}</td>
                                            <td>
                                                {% if screening.due_date %}
                                                    {{ screening.due_date.strftime('%Y-%m-%d') }}
                                                    {% if screening.is_overdue() %}
                                                        <span class="badge bg-danger ms-1">Overdue</span>
                                                    {% elif screening.is_due_soon() %}
                                                        <span class="badge bg-warning text-dark ms-1">Due Soon</span>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="text-muted">Not set</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if screening.last_completed %}
                                                    {{ screening.last_completed.strftime('%Y-%m-%d') }}
                                                {% else %}
                                                    <span class="text-muted">Never</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <span class="badge bg-{{ 'danger' if screening.priority == 'High' else 'warning' if screening.priority == 'Medium' else 'secondary' }}">
                                                    {{ screening.priority }}
                                                </span>
                                            </td>
                                            <td>
                                                {% if screening.notes %}
                                                    {{ screening.notes[:50] }}{% if screening.notes|length > 50 %}...{% endif %}
                                                {% else %}
                                                    <span class="text-muted">No notes</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-sm btn-outline-primary edit-screening-btn" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#editScreeningModal"
                                                        data-patient-id="{{ screening.patient_id }}"
                                                        data-screening-id="{{ screening.id }}"
                                                        data-screening-type="{{ screening.screening_type }}"
                                                        data-due-date="{{ screening.due_date.strftime('%Y-%m-%d') if screening.due_date else '' }}"
                                                        data-last-completed="{{ screening.last_completed.strftime('%Y-%m-%d') if screening.last_completed else '' }}"
                                                        data-priority="{{ screening.priority }}"
                                                        data-notes="{{ screening.notes or '' }}">
                                                    Edit
                                                </button>
                                                <a href="{{ url_for('screening.delete_screening', patient_id=screening.patient_id, screening_id=screening.id) }}" 
                                                   class="btn btn-sm btn-outline-danger"
                                                   onclick="return confirm('Are you sure you want to delete this screening?')">
                                                    Delete
                                                </a>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i> No screenings are currently due.
                        </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Screening Types Management Tab -->
        <div class="tab-pane fade {{ 'show active' if active_tab == 'types' else '' }}" 
             id="types" role="tabpanel" aria-labelledby="types-tab">

            {% if active_tab == 'types' %}
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>Screening Types Management</h1>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addScreeningTypeModal">
                    <i class="fas fa-plus me-1"></i> Add New Screening Type
                </button>
            </div>

            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Available Screening Types</h5>
                </div>
                <div class="card-body">
                    {% if screening_types %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Name & Keywords</th>
                                        <th>Frequency</th>
                                        <th>Gender Specific</th>
                                        <th>Age Range</th>
                                        <th>Status</th>
                                        <th width="150">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for screening_type in screening_types %}
                                        <tr>
                                            <td>
                                                <div class="d-flex justify-content-between align-items-start">
                                                    <div class="flex-grow-1">
                                                        <strong>{{ screening_type.name }}</strong>
                                                        <div class="keyword-management-section mt-2">
                                                            <div class="keyword-tags" id="keywords-{{ screening_type.id }}">
                                                                <small class="text-muted">Loading keywords...</small>
                                                            </div>
                                                            <div class="keyword-controls mt-1">
                                                                <div class="input-group input-group-sm" style="max-width: 400px;">
                                                                    <input type="text" class="form-control form-control-sm keyword-input" 
                                                                           placeholder="Add keyword..." 
                                                                           data-screening-id="{{ screening_type.id }}">
                                                                    <select class="form-select form-select-sm section-select" style="max-width: 120px;" 
                                                                            data-screening-id="{{ screening_type.id }}">
                                                                        <option value="labs">Labs</option>
                                                                        <option value="imaging">Imaging</option>
                                                                        <option value="procedures">Procedures</option>
                                                                        <option value="vitals">Vitals</option>
                                                                        <option value="consults">Consults</option>
                                                                        <option value="medications">Medications</option>
                                                                        <option value="general" selected>General</option>
                                                                    </select>
                                                                    <button type="button" class="btn btn-outline-primary btn-sm add-keyword-btn" 
                                                                            data-screening-id="{{ screening_type.id }}">
                                                                        <i class="fas fa-plus"></i>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>
                                            <td>{{ screening_type.default_frequency }}</td>
                                            <td>
                                                {% if screening_type.gender_specific %}
                                                    {{ screening_type.gender_specific }}
                                                {% else %}
                                                    All Genders
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if screening_type.min_age and screening_type.max_age %}
                                                    Ages {{ screening_type.min_age }} to {{ screening_type.max_age }}
                                                {% elif screening_type.min_age %}
                                                    Age {{ screening_type.min_age }}+
                                                {% elif screening_type.max_age %}
                                                    Up to age {{ screening_type.max_age }}
                                                {% else %}
                                                    All Ages
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if screening_type.is_active %}
                                                    <span class="badge bg-success">Active</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">Inactive</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <button type="button" class="btn btn-sm btn-outline-primary edit-screening-type-btn" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#editScreeningTypeModal"
                                                        data-id="{{ screening_type.id }}"
                                                        data-name="{{ screening_type.name }}"
                                                        data-frequency="{{ screening_type.default_frequency or '' }}"
                                                        data-gender="{{ screening_type.gender_specific or '' }}"
                                                        data-min-age="{{ screening_type.min_age or '' }}"
                                                        data-max-age="{{ screening_type.max_age or '' }}"
                                                        data-active="{{ 'checked' if screening_type.is_active else '' }}">
                                                    Edit
                                                </button>
                                                <button type="button" class="btn btn-sm btn-outline-danger delete-screening-type-btn"
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#deleteScreeningTypeModal"
                                                        data-id="{{ screening_type.id }}"
                                                        data-name="{{ screening_type.name }}">
                                                    Delete
                                                </button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i> No screening types have been defined yet. Use the "Add New Screening Type" button to create one.
                        </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modals would go here - keeping existing modal structure -->
{% endblock %}

{% block scripts %}
<style>
.keyword-management-section {
    border-left: 3px solid #e9ecef;
    padding-left: 10px;
}

.keyword-tags {
    min-height: 30px;
    margin-bottom: 8px;
}

.keyword-tag {
    display: inline-block;
    background-color: #e9ecef;
    border: 1px solid #ced4da;
    border-radius: 15px;
    padding: 3px 10px;
    margin: 2px;
    font-size: 0.75rem;
    position: relative;
}

.keyword-tag .section-label {
    background-color: #007bff;
    color: white;
    padding: 1px 5px;
    border-radius: 8px;
    font-size: 0.65rem;
    margin-right: 4px;
}

.keyword-tag .remove-btn {
    margin-left: 5px;
    color: #dc3545;
    cursor: pointer;
    font-weight: bold;
    font-size: 0.8rem;
}

.keyword-tag .remove-btn:hover {
    color: #c82333;
}

.keyword-controls {
    opacity: 0.7;
    transition: opacity 0.2s;
}

.keyword-management-section:hover .keyword-controls {
    opacity: 1;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let keywordData = {}; // Store keywords for each screening type

    // Load keywords for all screening types
    function loadAllKeywords() {
        document.querySelectorAll('.keyword-tags').forEach(container => {
            const screeningId = container.id.split('-')[1];
            loadKeywords(screeningId);
        });
    }

    // Load keywords for a specific screening type
    function loadKeywords(screeningId) {
        fetch(`/api/screening-keywords/${screeningId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    keywordData[screeningId] = data.keywords;
                    updateKeywordsDisplay(screeningId, data.keywords);
                } else {
                    keywordData[screeningId] = [];
                    updateKeywordsDisplay(screeningId, []);
                }
            })
            .catch(error => {
                console.error('Error loading keywords for screening', screeningId, ':', error);
                keywordData[screeningId] = [];
                updateKeywordsDisplay(screeningId, []);
            });
    }

    // Update keywords display
    function updateKeywordsDisplay(screeningId, keywords) {
        const container = document.getElementById(`keywords-${screeningId}`);
        if (!container) return;

        container.innerHTML = '';

        if (keywords.length === 0) {
            container.innerHTML = '<small class="text-muted">No keywords defined</small>';
            return;
        }

        keywords.forEach((keyword, index) => {
            const tag = document.createElement('span');
            tag.className = 'keyword-tag';
            tag.innerHTML = `
                <span class="section-label">${keyword.section}</span>
                ${keyword.keyword}
                <span class="remove-btn" data-screening-id="${screeningId}" data-index="${index}">&times;</span>
            `;
            container.appendChild(tag);
        });
    }

    // Add keyword functionality
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('add-keyword-btn')) {
            const screeningId = e.target.getAttribute('data-screening-id');
            addKeyword(screeningId);
        }

        if (e.target.classList.contains('remove-btn')) {
            const screeningId = e.target.getAttribute('data-screening-id');
            const index = parseInt(e.target.getAttribute('data-index'));
            removeKeyword(screeningId, index);
        }
    });

    // Handle Enter key in keyword input
    document.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && e.target.classList.contains('keyword-input')) {
            const screeningId = e.target.getAttribute('data-screening-id');
            addKeyword(screeningId);
        }
    });

    function addKeyword(screeningId) {
        const input = document.querySelector(`.keyword-input[data-screening-id="${screeningId}"]`);
        const sectionSelect = document.querySelector(`.section-select[data-screening-id="${screeningId}"]`);

        const keyword = input.value.trim();
        const section = sectionSelect.value;

        if (!keyword) return;

        // Check for duplicates
        const keywords = keywordData[screeningId] || [];
        const exists = keywords.some(k => 
            k.keyword.toLowerCase() === keyword.toLowerCase() && k.section === section
        );

        if (exists) {
            showAlert('This keyword already exists for this section', 'warning');
            return;
        }

        // Add keyword
        const newKeyword = {
            keyword: keyword,
            section: section,
            weight: 1.0,
            case_sensitive: false,
            exact_match: false,
            description: ''
        };

        keywords.push(newKeyword);
        keywordData[screeningId] = keywords;

        // Save to server
        saveKeywords(screeningId, keywords)
            .then(() => {
                updateKeywordsDisplay(screeningId, keywords);
                input.value = '';
                showAlert('Keyword added successfully', 'success');
            })
            .catch(error => {
                // Remove from local data if save failed
                keywordData[screeningId] = keywords.slice(0, -1);
                showAlert('Error saving keyword', 'danger');
            });
    }

    function removeKeyword(screeningId, index) {
        const keywords = keywordData[screeningId] || [];
        const removedKeyword = keywords[index];

        keywords.splice(index, 1);
        keywordData[screeningId] = keywords;

        // Save to server
        saveKeywords(screeningId, keywords)
            .then(() => {
                updateKeywordsDisplay(screeningId, keywords);
                showAlert('Keyword removed successfully', 'success');
            })
            .catch(error => {
                // Restore keyword if save failed
                keywords.splice(index, 0, removedKeyword);
                keywordData[screeningId] = keywords;
                showAlert('Error removing keyword', 'danger');
            });
    }

    function saveKeywords(screeningId, keywords) {
        return fetch(`/api/screening-keywords/${screeningId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ keywords: keywords })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to save keywords');
            }
            return response.json();
        })
        .then(data => {
            if (!data.success) {
                throw new Error(data.message || 'Failed to save keywords');
            }
            return data;
        });
    }

    function showAlert(message, type) {
        const alertContainer = document.querySelector('.container-fluid');
        const alert = document.createElement('div');
        alert.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alert.style.cssText = 'top: 20px; right: 20px; z-index: 1050; max-width: 400px;';
        alert.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(alert);

        // Auto-dismiss after 3 seconds
        setTimeout(() => {
            if (alert.parentNode) {
                alert.remove();
            }
        }, 3000);
    }

    // Initialize
    loadAllKeywords();
});
</script>
{% endblock %}

{% block extra_styles %}
<style>
    /* Override any colored backgrounds for the screening table */
    .table-danger, 
    .table-warning,
    .table-info,
    .table-success,
    .table tbody tr.table-danger,
    .table tbody tr.table-warning {
        background-color: transparent !important;
    }
    
    /* Add some extra styling to make badges stand out better */
    .badge {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }
    
    /* Modal styling */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1050;
        width: 100%;
        height: 100%;
        overflow: hidden;
        outline: 0;
    }
    
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1040;
        width: 100vw;
        height: 100vh;
        background-color: #000;
    }
    
    .modal-backdrop.fade {
        opacity: 0;
    }
    
    .modal-backdrop.show {
        opacity: 0.5;
    }
</style>

<!-- Inline script to force modal functionality -->
<script>
    // This script will execute immediately to force modals on this page
    console.log('Forcing modal setup');
    
    // Force a refresh of the page elements
    setTimeout(function() {
        const addBtn = document.getElementById('openAddScreeningModal');
        const addTypeBtn = document.getElementById('openAddTypeModal');
        
        if (addBtn) {
            console.log('Add button found, adding click handler');
            addBtn.onclick = function() {
                const modal = document.getElementById('addScreeningRecommendationModal');
                if (modal) {
                    modal.style.display = 'block';
                    modal.classList.add('show');
                    document.body.classList.add('modal-open');
                    document.body.style.overflow = 'hidden';
                    
                    // Create backdrop
                    const backdrop = document.createElement('div');
                    backdrop.className = 'modal-backdrop fade show';
                    document.body.appendChild(backdrop);
                }
            };
        }
        
        if (addTypeBtn) {
            console.log('Add Type button found, adding click handler');
            addTypeBtn.onclick = function() {
                const modal = document.getElementById('addScreeningTypeModal');
                if (modal) {
                    modal.style.display = 'block';
                    modal.classList.add('show');
                    document.body.classList.add('modal-open');
                    document.body.style.overflow = 'hidden';
                    
                    // Create backdrop
                    const backdrop = document.createElement('div');
                    backdrop.className = 'modal-backdrop fade show';
                    document.body.appendChild(backdrop);
                }
            };
        }
    }, 500);
</script>
{% endblock %}