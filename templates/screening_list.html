{% extends 'base_demo.html' %}

{% block title %}HealthPrep - Screening List{% endblock %}

{% block extra_css %}
<style>
/* Override for buttons - added May 18, 2025 */
.btn .fas, .btn .fa {
    display: none !important;
}
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h1>Screening List</h1>
        <p class="lead">View and manage patient screening recommendations</p>
    </div>
</div>

<!-- Nav Tabs -->
<ul class="nav nav-tabs mb-3">
    <li class="nav-item">
        <a class="nav-link {% if active_tab == 'screenings' %}active{% endif %}" href="{{ url_for('screening_list', tab='screenings', search=search_query) }}">
            Screening List
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if active_tab == 'types' %}active{% endif %}" href="{{ url_for('screening_list', tab='types', search=search_query) }}">
            Manage Screening Types
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if active_tab == 'checklist' %}active{% endif %}" href="{{ url_for('screening_list', tab='checklist', search=search_query) }}">
            Prep Sheet Settings
        </a>
    </li>
</ul>

<!-- Tab Content -->
{% if active_tab == 'screenings' %}
<!-- Due Screenings Tab Content -->
<div class="card border-0">
    <div class="card-header bg-secondary bg-opacity-25">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="mb-0">
                    <i class="fas fa-clipboard-check me-1"></i><i class="fas fa-cog me-2"></i>Screening List
                </h5>
            </div>
            <div class="col-auto d-flex">
                <form class="d-flex me-2" method="get">
                    <input type="hidden" name="tab" value="screenings">
                    <input class="form-control me-2" type="search" placeholder="Search patient or screening" name="search" value="{{ search_query }}">
                    <button class="btn btn-outline-secondary" type="submit">Search</button>
                </form>
                <a href="{{ url_for('add_screening_form') }}" class="btn btn-primary">
                    Add Screening
                </a>
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        {% if screenings %}
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0">
                <thead>
                    <tr>
                        <th>Patient</th>
                        <th>Screening</th>
                        <th>Due Date</th>
                        <th>Last Completed</th>
                        <th>Priority</th>
                        <th width="150">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for screening in screenings %}
                    <tr>
                        <td>
                            <a href="{{ url_for('patient_detail', patient_id=screening.patient.id) }}">
                                {{ screening.patient.full_name }}
                            </a>
                        </td>
                        <td>{{ screening.screening_type }}</td>
                        <td>
                            {% if screening.due_date %}
                                {{ screening.due_date.strftime('%m/%d/%Y') }}
                                {% if screening.due_date < today %}
                                    <span class="badge bg-danger">Overdue</span>
                                {% elif (screening.due_date - today).days <= 30 %}
                                    <span class="badge bg-warning">Due Soon</span>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">Not set</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if screening.last_completed %}
                                {{ screening.last_completed.strftime('%m/%d/%Y') }}
                            {% else %}
                                <span class="text-muted">Unknown</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if screening.priority == 'High' %}
                                <span class="badge bg-danger">High</span>
                            {% elif screening.priority == 'Medium' %}
                                <span class="badge bg-warning">Medium</span>
                            {% elif screening.priority == 'Low' %}
                                <span class="badge bg-info">Low</span>
                            {% else %}
                                <span class="badge bg-secondary">None</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-sm btn-outline-primary edit-screening-btn" 
                                   data-bs-toggle="modal" data-bs-target="#editScreeningModal"
                                   data-id="{{ screening.id }}"
                                   data-patient-id="{{ screening.patient.id }}"
                                   data-patient-name="{{ screening.patient.full_name }}"
                                   data-screening-type="{{ screening.screening_type }}"
                                   data-due-date="{{ screening.due_date.strftime('%Y-%m-%d') if screening.due_date else '' }}"
                                   data-last-completed="{{ screening.last_completed.strftime('%Y-%m-%d') if screening.last_completed else '' }}"
                                   data-frequency="{{ screening.frequency or '' }}"
                                   data-priority="{{ screening.priority or '' }}"
                                   data-notes="{{ screening.notes or '' }}">
                                    <i class="fas fa-edit me-1"></i>Edit
                                </button>
                                <a href="{{ url_for('delete_screening', patient_id=screening.patient.id, screening_id=screening.id, ts=cache_timestamp) }}" class="btn btn-sm btn-outline-danger" 
                                   onclick="return confirm('Are you sure you want to delete this screening record?');">
                                    <i class="fas fa-trash-alt me-1"></i>Delete
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <p class="text-muted mb-0">No screenings found {% if search_query %}matching "{{ search_query }}"{% endif %}</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add Screening Recommendation Modal -->
<div class="modal fade" id="addScreeningRecommendationModal" tabindex="-1" aria-labelledby="addScreeningRecommendationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addScreeningRecommendationModalLabel">Add Screening Recommendation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('add_screening_recommendation', ts=cache_timestamp) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Patient <span class="text-danger">*</span></label>
                        <select class="form-select" name="patient_id" id="patient" required>
                            <option value="">Select a patient</option>
                            {% for patient in patients %}
                                <option value="{{ patient.id }}">{{ patient.full_name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Screening Type <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="screening_type" id="screening_type" required list="screening-types-list">
                        <datalist id="screening-types-list">
                            {% for type in all_screening_types %}
                                <option value="{{ type.name }}">
                            {% endfor %}
                        </datalist>
                        <small class="text-muted">Type or select from available screening types</small>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Due Date</label>
                                <input type="date" class="form-control" name="due_date">
                                <small class="text-muted">When should this screening be completed</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Last Completed</label>
                                <input type="date" class="form-control" name="last_completed">
                                <small class="text-muted">When was this screening last done</small>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Frequency</label>
                                <input type="text" class="form-control" name="frequency" placeholder="e.g. Annual, Every 5 years">
                                <small class="text-muted">How often this screening should be done</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Priority</label>
                                <select class="form-select" name="priority">
                                    <option value="">Select priority</option>
                                    <option value="High">High</option>
                                    <option value="Medium">Medium</option>
                                    <option value="Low">Low</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" name="notes" rows="3"></textarea>
                        <small class="text-muted">Any additional information about this screening recommendation</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Screening Modal -->
<div class="modal fade" id="editScreeningModal" tabindex="-1" aria-labelledby="editScreeningModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editScreeningModalLabel">Edit Screening Recommendation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" id="editScreeningForm" action="">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="patient_id" id="edit-patient-id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Patient</label>
                        <p class="form-control-plaintext" id="edit-patient-name"></p>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Screening Type <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="screening_type" id="edit-screening-type" required list="screening-types-list">
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Due Date</label>
                                <input type="date" class="form-control" name="due_date" id="edit-due-date">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Last Completed</label>
                                <input type="date" class="form-control" name="last_completed" id="edit-last-completed">
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Frequency</label>
                                <input type="text" class="form-control" name="frequency" id="edit-frequency">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Priority</label>
                                <select class="form-select" name="priority" id="edit-priority">
                                    <option value="">Select priority</option>
                                    <option value="High">High</option>
                                    <option value="Medium">Medium</option>
                                    <option value="Low">Low</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" name="notes" id="edit-notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% elif active_tab == 'types' %}
<!-- Screening Types Tab Content -->
<div class="card border-0">
    <div class="card-header bg-secondary bg-opacity-25">
        <div class="row align-items-center">
            <div class="col">
                <h5 class="mb-0">
                    <i class="fas fa-cog me-2"></i>Screening Types
                </h5>
            </div>
            <div class="col-auto d-flex">
                <form class="d-flex me-2" method="get">
                    <input type="hidden" name="tab" value="types">
                    <input class="form-control me-2" type="search" placeholder="Search screening types" name="search" value="{{ search_query }}">
                    <button class="btn btn-outline-secondary" type="submit">Search</button>
                </form>

                <a href="{{ url_for('add_screening_type_form') }}" class="btn btn-primary">
                    Add Type
                </a>
            </div>
        </div>
    </div>
    <div class="card-body p-0">
        {% if screening_types %}
        <div class="table-responsive">
            <table class="table table-hover table-striped mb-0">
                <thead>
                    <tr>
                        <th>Name & Keywords</th>
                        <th>Frequency</th>
                        <th>Gender Specific</th>
                        <th>Age Range</th>
                        <th>Status</th>
                        <th width="200">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for screening_type in screening_types %}
                    <tr>
                        <td>
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong>{{ screening_type.name }}</strong>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-info keywords-btn" 
                                        id="keywords-btn-{{ screening_type.id }}"
                                        onclick="toggleKeywordDisplay({{ screening_type.id }}, '{{ screening_type.name }}')"
                                        title="View Keywords">
                                    <i class="fas fa-tags"></i> <span id="keywords-text-{{ screening_type.id }}">Keywords</span>
                                </button>
                                <div id="keywords-dropdown-{{ screening_type.id }}" class="keywords-dropdown" style="display: none;">
                                    <div class="keywords-dropdown-content">
                                        <div class="keywords-dropdown-header">
                                            <strong>{{ screening_type.name }} Keywords</strong>
                                            <button type="button" class="btn btn-sm btn-link" onclick="openKeywordManager({{ screening_type.id }}, '{{ screening_type.name }}')">
                                                <i class="fas fa-edit"></i> Edit
                                            </button>
                                        </div>
                                        <div id="keywords-list-{{ screening_type.id }}" class="keywords-list-content">
                                            Loading keywords...
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td>{{ screening_type.default_frequency or 'Not specified' }}</td>
                        <td>
                            {% if screening_type.gender_specific %}
                                {{ screening_type.gender_specific }}
                            {% else %}
                                All Genders
                            {% endif %}
                        </td>
                        <td>
                            {% if screening_type.min_age and screening_type.max_age %}
                                Ages {{ screening_type.min_age }} to {{ screening_type.max_age }}
                            {% elif screening_type.min_age %}
                                Age {{ screening_type.min_age }}+
                            {% elif screening_type.max_age %}
                                Up to age {{ screening_type.max_age }}
                            {% else %}
                                All Ages
                            {% endif %}
                        </td>
                        <td>
                            {% if screening_type.is_active %}
                                <span class="badge bg-success">Active</span>
                            {% else %}
                                <span class="badge bg-secondary">Inactive</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <a href="{{ url_for('edit_screening_type', screening_type_id=screening_type.id, t=cache_timestamp) }}" class="btn btn-sm btn-outline-primary">
                                    Edit
                                </a>
                                <a href="{{ url_for('delete_screening_type', screening_type_id=screening_type.id, ts=cache_timestamp) }}" class="btn btn-sm btn-outline-danger" 
                                   onclick="return confirm('Are you sure you want to delete this screening type?');">
                                    Delete
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <p class="text-muted mb-0">No screening types found {% if search_query %}matching "{{ search_query }}"{% endif %}</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add Screening Type Modal -->
<div class="modal fade" id="addScreeningTypeModal" tabindex="-1" aria-labelledby="addScreeningTypeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addScreeningTypeModalLabel">Add Screening Type</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('add_screening_type', ts=cache_timestamp) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="name" required>
                        <small class="text-muted">Name of the screening (e.g., 'Mammogram', 'Colonoscopy')</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Keywords for Document Matching</label>
                        <div class="border rounded p-3 bg-light">
                            <div id="add-form-keywords-container">
                                <div class="d-flex mb-2">
                                    <input type="text" class="form-control me-2" id="add-form-keyword-input" placeholder="Enter keyword">
                                    <button type="button" class="btn btn-outline-primary" onclick="addKeywordToForm('add-form')">Add</button>
                                </div>
                                <div id="add-form-keywords-list" class="keywords-list"></div>
                            </div>
                        </div>
                        <small class="text-muted">Keywords help identify relevant documents for this screening type</small>
                        <input type="hidden" name="keywords" id="add-form-keywords-data">
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Default Frequency</label>
                                <input type="text" class="form-control" name="default_frequency">
                                <small class="text-muted">How often this screening should be done (e.g., 'Annual', 'Every 5 years')</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Gender Specific</label>
                                <select class="form-select" name="gender_specific">
                                    <option value="">All Genders</option>
                                    <option value="Male">Male Only</option>
                                    <option value="Female">Female Only</option>
                                </select>
                                <small class="text-muted">Is this screening specific to a particular gender?</small>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Minimum Age</label>
                                <input type="number" class="form-control" name="min_age" min="0" max="120">
                                <small class="text-muted">Minimum age to start this screening</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Maximum Age</label>
                                <input type="number" class="form-control" name="max_age" min="0" max="120">
                                <small class="text-muted">Maximum age for this screening (leave blank if no upper limit)</small>
                            </div>
                        </div>
                    </div>

                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="is_active" id="isActive" checked>
                        <label class="form-check-label" for="isActive">
                            Active
                        </label>
                        <div class="form-text">Whether this screening should appear in checklists</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Screening Type Modal -->
<div class="modal fade" id="editScreeningTypeModal" tabindex="-1" aria-labelledby="editScreeningTypeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editScreeningTypeModalLabel">Edit Screening Type</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" id="editScreeningTypeForm" action="">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" name="name" id="edit-name" required>
                        <small class="text-muted">Name of the screening (e.g., 'Mammogram', 'Colonoscopy')</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Keywords for Document Matching</label>
                        <div class="keywords-container">
                            <div id="edit-form-keywords-container" class="keywords-form-group">
                                <div class="d-flex mb-2">
                                    <input type="text" class="keywords-input me-2" id="edit-form-keyword-input" placeholder="Enter keyword">
                                    <button type="button" class="keywords-btn" onclick="addKeywordToForm('edit-form')">Add</button>
                                </div>
                                <div id="edit-form-keywords-list" class="keywords-display"></div>
                            </div>
                        </div>
                        <small class="keywords-help-text">Keywords help identify relevant documents for this screening type</small>
                        <input type="hidden" name="keywords" id="edit-form-keywords-data">
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Default Frequency</label>
                                <input type="text" class="form-control" name="default_frequency" id="edit-frequency">
                                <small class="text-muted">How often this screening should be done (e.g., 'Annual', 'Every 5 years')</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Gender Specific</label>
                                <select class="form-select" name="gender_specific" id="edit-gender">
                                    <option value="">All Genders</option>
                                    <option value="Male">Male Only</option>
                                    <option value="Female">Female Only</option>
                                </select>
                                <small class="text-muted">Is this screening specific to a particular gender?</small>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Minimum Age</label>
                                <input type="number" class="form-control" name="min_age" id="edit-min-age" min="0" max="120">
                                <small class="text-muted">Minimum age to start this screening</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label class="form-label">Maximum Age</label>
                                <input type="number" class="form-control" name="max_age" id="edit-max-age" min="0" max="120">
                                <small class="text-muted">Maximum age for this screening (leave blank if no upper limit)</small>
                            </div>
                        </div>
                    </div>

                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="is_active" id="edit-active">
                        <label class="form-check-label" for="edit-active">
                            Active
                        </label>
                        <div class="form-text">Whether this screening should appear in checklists</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% elif active_tab == 'checklist' %}
<!-- Checklist Settings Tab Content -->
<div class="card">
    <div class="card-body">
        <p class="text-muted mb-4">These settings control the layout and content generation of the screening checklist section in patient prep sheets.</p>

        <div class="row">
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">Display Options</h6>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('update_checklist_settings') }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                            <div class="mb-3">
                                <label class="form-label">Checklist Layout Style</label>
                                <select class="form-select" name="layout_style">
                                    <option value="table" {% if settings and settings.layout_style == 'table' %}selected{% endif %}>Table Format (Compact)</option>
                                    <option value="list" {% if settings and settings.layout_style == 'list' %}selected{% endif %}>List Format (Spacious)</option>
                                </select>
                                <div class="form-text">Determines how screening items are displayed in the checklist.</div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Status Options</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="status_due" name="status_options" value="due" 
                                        {% if settings and 'due' in settings.status_options_list %}checked{% endif %}>
                                    <label class="form-check-label" for="status_due">Due</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="status_due_soon" name="status_options" value="due_soon"
                                        {% if settings and 'due_soon' in settings.status_options_list %}checked{% endif %}>
                                    <label class="form-check-label" for="status_due_soon">Due Soon</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="status_sent" name="status_options" value="sent_incomplete"
                                        {% if settings and 'sent_incomplete' in settings.status_options_list %}checked{% endif %}>
                                    <label class="form-check-label" for="status_sent">Sent & Incomplete</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="status_completed" name="status_options" value="completed"
                                        {% if settings and 'completed' in settings.status_options_list %}checked{% endif %}>
                                    <label class="form-check-label" for="status_completed">Completed</label>
                                </div>
                                <div class="mt-3">
                                    <label class="form-label">Custom Status Options</label>
                                    <div class="input-group mb-2">
                                        <input type="text" class="form-control" id="custom_status_input" placeholder="Add custom status option...">
                                        <button class="btn btn-outline-primary" type="button" id="add_custom_status">Add</button>
                                    </div>
                                    <div class="form-text mb-2">Add your own status options to appear in autocomplete</div>
                                    <div id="custom_status_list" class="d-flex flex-wrap gap-2 mb-2">
                                        {% if settings and settings.custom_status_list %}
                                            {% for status in settings.custom_status_list %}
                                                <div class="custom-status-item badge bg-light text-dark p-2 d-flex align-items-center">
                                                    {{ status }}
                                                    <button type="button" class="btn-close btn-close-dark ms-2 shadow-sm" style="background-color: #f8d7da; padding: 4px; border-radius: 50%;" aria-label="Remove" data-status="{{ status }}"></button>
                                                    <input type="hidden" name="custom_status_options" value="{{ status }}">
                                                </div>
                                            {% endfor %}
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Note Field</label>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="show_notes" name="show_notes"
                                        {% if settings and settings.show_notes %}checked{% endif %}>
                                    <label class="form-check-label" for="show_notes">Show Notes Field</label>
                                </div>
                                <div class="form-text">Display a notes field for each screening item.</div>
                            </div>

                            <button type="submit" class="btn btn-primary">Save Display Settings</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">Checklist Content Generation</h6>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('update_checklist_generation') }}">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                            <div class="mb-3">
                                <label class="form-label">Content Sources</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="source_db" name="content_sources" value="database"
                                        {% if settings and 'database' in settings.content_sources_list %}checked{% endif %}>
                                    <label class="form-check-label" for="source_db">Default Items</label>
                                    <div class="form-text">Include default items specified below</div>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="source_existing" name="content_sources" value="existing_screenings"
                                        {% if settings and 'existing_screenings' in settings.content_sources_list %}checked{% endif %}>
                                    <label class="form-check-label" for="source_existing">Patient Screenings</label>
                                    <div class="form-text">Include screenings already assigned to the patient</div>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input type="checkbox"```text
 id="source_age" name="content_sources" value="age_based"
                                        {% if settings and 'age_based' in settings.content_sources_list %}checked{% endif %}>
                                    <label class="form-check-label" for="source_age">Age-Based Recommendations</label>
                                    <div class="form-text">Include screenings based on patient age</div>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="source_gender" name="content_sources" value="gender_based"
                                        {% if settings and 'gender_based' in settings.content_sources_list %}checked{% endif %}>
                                    <label class="form-check-label" for="source_gender">Gender-Specific Screenings</label>
                                    <div class="form-text">Include screenings based on patient gender</div>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="source_condition" name="content_sources" value="condition_based"
                                        {% if settings and 'condition_based' in settings.content_sources_list %}checked{% endif %}>
                                    <label class="form-check-label" for="source_condition">Condition-Specific Screenings</label>
                                    <div class="form-text">Include screenings based on patient conditions</div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Default Items</label>
                                <textarea class="form-control" name="default_items" rows="4" placeholder="One item per line">{{ default_items_text }}</textarea>
                                <div class="form-text">Default items to include in every patient's checklist</div>
                            </div>

                            <button type="submit" class="btn btn-primary">Save Generation Settings</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<!-- Loading our custom modal handler script with a unique timestamp to prevent caching -->
<script src="{{ url_for('static', filename='js/screening_modals.js') }}?v={{ cache_timestamp|default(999999999) }}"></script>

<!-- Conditional JavaScript based on active tab -->
{% if active_tab == 'checklist' %}
<script>
    // Custom status options handler
    document.addEventListener('DOMContentLoaded', function() {
        const addCustomStatusBtn = document.getElementById('add_custom_status');
        const customStatusInput = document.getElementById('custom_status_input');
        const customStatusList = document.getElementById('custom_status_list');

        if (addCustomStatusBtn) {
            addCustomStatusBtn.addEventListener('click', function() {
                addCustomStatus();
            });
        }

        if (customStatusInput) {
            customStatusInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addCustomStatus();
                }
            });
        }

        // Add close button functionality to existing status items
        document.querySelectorAll('.btn-close').forEach(button => {
            button.addEventListener('click', function() {
                const status = this.getAttribute('data-status');
                if (status) {
                    removeCustomStatus(status, this.closest('.custom-status-item'));
                }
            });
        });

        // Function to add a new custom status
        function addCustomStatus() {
            const status = customStatusInput.value.trim();
            if (!status) return;

            // Create a new status item
            const statusItem = document.createElement('div');
            statusItem.className = 'custom-status-item badge bg-light text-dark p-2 d-flex align-items-center';

            // Status text
            const statusText = document.createTextNode(status);
            statusItem.appendChild(statusText);

            // Remove button
            const removeBtn = document.createElement('button');
            removeBtn.className = 'btn-close btn-close-dark ms-2 shadow-sm';
            removeBtn.style.backgroundColor = '#f8d7da';
            removeBtn.style.padding = '4px';
            removeBtn.style.borderRadius = '50%';
            removeBtn.setAttribute('aria-label', 'Remove');
            removeBtn.setAttribute('data-status', status);
            removeBtn.addEventListener('click', function() {
                removeCustomStatus(status, statusItem);
            });
            statusItem.appendChild(removeBtn);

            // Hidden input to submit the value
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'custom_status_options';
            hiddenInput.value = status;
            statusItem.appendChild(hiddenInput);

            // Add to the list
            customStatusList.appendChild(statusItem);

            // Clear the input
            customStatusInput.value = '';
        }

        // Function to remove a custom status
        function removeCustomStatus(status, element) {
            if (element) {
                element.remove();
            }
        }
    });
</script>
{% endif %}
{% endblock %}

{% block extra_styles %}
<style>
    /* Override any colored backgrounds for the screening table */
    .table-danger, 
    .table-warning,
    .table-info,
    .table-success,
    .table tbody tr.table-danger,
    .table tbody tr.table-warning {
        background-color: transparent !important;
    }

    /* Add some extra styling to make badges stand out better */
    .badge {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }

    /* Modal styling */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1050;
        width: 100%;
        height: 100%;
        overflow: hidden;
        outline: 0;
    }

    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1040;
        width: 100vw;
        height: 100vh;
        background-color: #000;
    }

    .modal-backdrop.fade {
        opacity: 0;
    }

    .modal-backdrop.show {
        opacity: 0.5;
    }
</style>

<!-- Keyword Management Modal -->
<div class="modal fade" id="keywordManagerModal" tabindex="-1" aria-labelledby="keywordManagerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="keywordManagerModalLabel">Manage Keywords</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <strong>Document Matching Strategy:</strong> Keywords help identify relevant documents for screening types. 
                    The system uses FHIR codes first, then filename/section detection, and finally these user-defined keywords as fallback.
                </div>

                <div class="mb-3">
                    <label class="form-label">Add New Keyword</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="newKeywordInput" placeholder="Enter keyword">
                        <button class="btn btn-primary" type="button" onclick="addKeyword()">
                            <i class="fas fa-plus"></i> Add
                        </button>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Current Keywords</label>
                    <div id="keywordsList" class="border rounded p-3 min-height-100 bg-light">
                        <div class="text-muted text-center">Loading keywords...</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveKeywords()">Save Keywords</button>
            </div>
        </div>
    </div>
</div>

<!-- Keyword Management JavaScript -->
<script>
let currentScreeningTypeId = null;
let currentKeywords = [];



// Toggle keyword display dropdown
function toggleKeywordDisplay(screeningTypeId, screeningName) {
    const dropdown = document.getElementById(`keywords-dropdown-${screeningTypeId}`);
    const isVisible = dropdown.style.display !== 'none';
    
    // Hide all other dropdowns first
    document.querySelectorAll('.keywords-dropdown').forEach(d => d.style.display = 'none');
    
    if (!isVisible) {
        // Show this dropdown and load keywords
        dropdown.style.display = 'block';
        loadKeywordsForDisplay(screeningTypeId);
    }
}

// Load keywords for display in dropdown
function loadKeywordsForDisplay(screeningTypeId) {
    const listContainer = document.getElementById(`keywords-list-${screeningTypeId}`);
    listContainer.innerHTML = 'Loading keywords...';
    
    fetch(`/api/screening-keywords/${screeningTypeId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.keywords && data.keywords.length > 0) {
                const keywordsHtml = data.keywords.map(keyword => 
                    `<span class="badge bg-primary me-1 mb-1">${keyword}</span>`
                ).join('');
                listContainer.innerHTML = keywordsHtml;
            } else {
                listContainer.innerHTML = '<em class="text-muted">No keywords defined</em>';
            }
        })
        .catch(error => {
            console.error('Error loading keywords:', error);
            listContainer.innerHTML = '<em class="text-danger">Error loading keywords</em>';
        });
}

// Open keyword manager modal
function openKeywordManager(screeningTypeId, screeningName) {
    currentScreeningTypeId = screeningTypeId;
    document.getElementById('keywordManagerModalLabel').textContent = `Manage Keywords - ${screeningName}`;

    // Load existing keywords
    fetch(`/api/screening-keywords/${screeningTypeId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentKeywords = data.keywords || [];
                displayKeywords();
            } else {
                console.error('Error loading keywords:', data.error);
                currentKeywords = [];
                displayKeywords();
            }
        })
        .catch(error => {
            console.error('Error loading keywords:', error);
            currentKeywords = [];
            displayKeywords();
        });

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('keywordManagerModal'));
    modal.show();
}

// Display keywords in the modal
function displayKeywords() {
    const container = document.getElementById('keywordsList');
    if (currentKeywords.length === 0) {
        container.innerHTML = '<div class="text-muted text-center">No keywords defined yet</div>';
        return;
    }

    const keywordsHtml = currentKeywords.map((keyword, index) => 
        `<span class="badge bg-primary me-2 mb-2">
            ${keyword}
            <button type="button" class="btn-close btn-close-white ms-1" 
                    onclick="removeKeyword(${index})" aria-label="Remove"></button>
        </span>`
    ).join('');

    container.innerHTML = keywordsHtml;
}

// Add keyword
function addKeyword() {
    const input = document.getElementById('newKeywordInput');
    const keyword = input.value.trim();

    if (keyword && !currentKeywords.includes(keyword)) {
        currentKeywords.push(keyword);
        displayKeywords();
        input.value = '';
    }
}

// Remove keyword
function removeKeyword(index) {
    currentKeywords.splice(index, 1);
    displayKeywords();
}

// Save keywords
function saveKeywords() {
    // Convert simple keyword list to proper format for the API
    const keywordObjects = currentKeywords.map(keyword => ({
        keyword: keyword,
        section: 'general',
        weight: 1.0,
        case_sensitive: false,
        exact_match: false,
        description: `Keyword for screening type`
    }));

    fetch(`/api/screening-keywords/${currentScreeningTypeId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrf_token]').value
        },
        body: JSON.stringify({ keywords: keywordObjects })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('keywordManagerModal'));
            modal.hide();

            // Show success message and refresh the page to ensure all displays update
            setTimeout(() => {
                window.location.reload();
            }, 500);

            // Show success message
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show';
            alert.innerHTML = `
                Keywords updated successfully! Refreshing...
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.container').insertBefore(alert, document.querySelector('.container').firstChild);
        } else {
            alert('Error saving keywords: ' + (data.message || data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error saving keywords:', error);
        alert('Error saving keywords. Please try again.');
    });
}

// Add keyword to form (for add/edit modals)
function addKeywordToForm(formPrefix) {
    const input = document.getElementById(`${formPrefix}-keyword-input`);
    const keyword = input.value.trim();

    if (keyword) {
        const container = document.getElementById(`${formPrefix}-keywords-list`);
        const keywordElement = document.createElement('span');
        keywordElement.className = 'badge bg-primary me-2 mb-2';
        keywordElement.innerHTML = `
            ${keyword}
            <button type="button" class="btn-close btn-close-white ms-1" 
                    onclick="removeFormKeyword(this)" aria-label="Remove"></button>
        `;
        container.appendChild(keywordElement);
        input.value = '';
        updateFormKeywordsData(formPrefix);
    }
}

// Remove keyword from form
function removeFormKeyword(button) {
    const keywordElement = button.closest('.badge');
    const formPrefix = keywordElement.closest('[id$="-keywords-container"]').id.replace('-keywords-container', '');
    keywordElement.remove();
    updateFormKeywordsData(formPrefix);
}

// Update hidden form data
function updateFormKeywordsData(formPrefix) {
    const container = document.getElementById(`${formPrefix}-keywords-list`);
    const keywords = Array.from(container.querySelectorAll('.badge')).map(badge => {
        // Get only the text content, excluding the close button
        const clone = badge.cloneNode(true);
        const closeButton = clone.querySelector('.btn-close');
        if (closeButton) {
            closeButton.remove();
        }
        return clone.textContent.trim();
    }).filter(keyword => keyword !== '');
    const hiddenInput = document.getElementById(`${formPrefix}-keywords-data`);
    if (hiddenInput) {
        hiddenInput.value = JSON.stringify(keywords);
    }
}

// Handle Enter key in keyword inputs
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM Content Loaded - checking for keyword displays...');

    // Load keywords for buttons on the types tab
    if (window.location.href.includes('tab=types') || document.querySelector('.keywords-btn')) {
        console.log('Loading keywords for buttons...');
        loadKeywordsForButtons();

        // Add a delay as fallback to ensure elements are fully rendered
        setTimeout(() => {
            console.log('Fallback keyword loading for buttons...');
            loadKeywordsForButtons();
        }, 1000);
    }

    // Handle Enter key in main keyword input
    document.getElementById('newKeywordInput')?.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            addKeyword();
        }
    });

    // Handle Enter key in form keyword inputs
    document.querySelectorAll('[id$="-keyword-input"]').forEach(input => {
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const formPrefix = this.id.replace('-keyword-input', '');
                addKeywordToForm(formPrefix);
            }
        });
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', function(event) {
        if (!event.target.closest('.keywords-btn') && !event.target.closest('.keywords-dropdown')) {
            document.querySelectorAll('.keywords-dropdown').forEach(dropdown => {
                dropdown.style.display = 'none';
            });
        }
    });
});

// Load keywords and update button text
function loadKeywordsForButtons() {
    const buttons = document.querySelectorAll('.keywords-btn');
    console.log(`loadKeywordsForButtons: Found ${buttons.length} keyword buttons to load`);

    buttons.forEach(button => {
        const screeningTypeId = button.id.replace('keywords-btn-', '');
        const textSpan = document.getElementById(`keywords-text-${screeningTypeId}`);

        if (!textSpan) {
            console.log(`No text span found for screening ${screeningTypeId}`);
            return;
        }

        console.log(`loadKeywordsForButtons: Loading keywords for screening ${screeningTypeId}`);

        fetch(`/api/screening-keywords/${screeningTypeId}`)
            .then(response => {
                console.log(`loadKeywordsForButtons: API response status for screening ${screeningTypeId}: ${response.status}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(`Received keywords data for screening ${screeningTypeId}:`, data);
                if (data.success && data.keywords && Array.isArray(data.keywords) && data.keywords.length > 0) {
                    // Show first few keywords in button text
                    const keywordCount = data.keywords.length;
                    if (keywordCount === 1) {
                        textSpan.textContent = `"${data.keywords[0]}"`;
                    } else if (keywordCount <= 3) {
                        textSpan.textContent = data.keywords.join(', ');
                    } else {
                        textSpan.textContent = `${data.keywords.slice(0, 2).join(', ')} +${keywordCount - 2} more`;
                    }

                    // Update button style to show it has keywords
                    button.className = 'btn btn-sm btn-info keywords-btn';
                    button.title = `Keywords: ${data.keywords.join(', ')}`;

                    console.log(`Successfully updated keywords button for screening ${screeningTypeId} with ${keywordCount} keywords`);
                } else {
                    textSpan.textContent = 'No Keywords';
                    button.className = 'btn btn-sm btn-outline-secondary keywords-btn';
                    button.title = 'No keywords defined - click to add';
                    console.log(`No keywords found for screening ${screeningTypeId}`);
                }
            })
            .catch(error => {
                console.error(`Error loading keywords for screening ${screeningTypeId}:`, error);
                textSpan.textContent = 'Keywords';
                button.title = 'Error loading keywords';
            });
    });
}
</script>

<style>
.keywords-list {
    min-height: 60px;
}
.min-height-100 {
    min-height: 100px;
}
.btn-close-white {
    filter: invert(1) grayscale(100%) brightness(200%);
}
.keywords-dropdown {
    position: absolute;
    z-index: 1000;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    min-width: 300px;
    max-width: 400px;
    margin-top: 5px;
}
.keywords-dropdown-content {
    padding: 1rem;
}
.keywords-dropdown-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 0.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #dee2e6;
}
.keywords-list-content {
    max-height: 200px;
    overflow-y: auto;
}
.keywords-dropdown .badge {
    font-size: 0.75rem;
}
</style>
{% endblock %}