{% extends 'base_demo.html' %}

{% block content %}
<div class="container-fluid mt-3">
    <div class="row">
        <div class="col-12">
            <h2>
                <i class="fas fa-tasks"></i> Background Tasks Monitor
            </h2>
            <p class="text-muted">Monitor OCR processing and other background tasks</p>
        </div>
    </div>

    <!-- Task Statistics -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ active_count }}</h4>
                            <span>Active Tasks</span>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-cog fa-spin fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ completed_count }}</h4>
                            <span>Completed</span>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-check fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ queue_size }}</h4>
                            <span>Queued</span>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h4>{{ user_tasks|length }}</h4>
                            <span>Your Tasks</span>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-user fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Your Recent Tasks -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list"></i> Your Recent Tasks
                        <button class="btn btn-sm btn-outline-primary float-end" onclick="refreshTaskStatus()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </h5>
                </div>
                <div class="card-body">
                    <div id="user-tasks-container">
                        <!-- Dynamic content will be loaded here -->
                        {% if user_tasks %}
                            <div class="list-group">
                                {% for task in user_tasks %}
                                <div class="list-group-item">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">{{ task.document_name or "Document" }}</h6>
                                        <small>{{ task.started_at }}</small>
                                    </div>
                                    <p class="mb-1">Task ID: {{ task.task_id }}</p>
                                    <small>Document ID: {{ task.document_id }}</small>
                                    <div class="mt-2">
                                        <button class="btn btn-sm btn-outline-info" onclick="checkOCRStatus('{{ task.task_id }}')">
                                            <i class="fas fa-info-circle"></i> Check Status
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-muted">No recent tasks found.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- All Tasks (Admin View) -->
    {% if all_tasks.active or all_tasks.completed %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-server"></i> System Tasks
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="nav nav-tabs" id="taskTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="active-tab" data-bs-toggle="tab" data-bs-target="#active-tasks" type="button" role="tab">
                                Active Tasks ({{ all_tasks.active|length }})
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="completed-tab" data-bs-toggle="tab" data-bs-target="#completed-tasks" type="button" role="tab">
                                Recent Completed ({{ all_tasks.completed[-10:]|length }})
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content mt-3" id="taskTabsContent">
                        <!-- Active Tasks -->
                        <div class="tab-pane fade show active" id="active-tasks" role="tabpanel">
                            {% if all_tasks.active %}
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Task ID</th>
                                                <th>Type</th>
                                                <th>Progress</th>
                                                <th>Started</th>
                                                <th>Patient Count</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for task in all_tasks.active %}
                                            <tr>
                                                <td><code>{{ task.task_id[:8] }}...</code></td>
                                                <td>{{ task.task_type }}</td>
                                                <td>
                                                    <div class="progress" style="height: 20px;">
                                                        <div class="progress-bar" role="progressbar" 
                                                             style="width: {{ (task.progress * 100)|round }}%">
                                                            {{ (task.progress * 100)|round }}%
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>{{ task.started_at or "Not started" }}</td>
                                                <td>{{ task.patient_count }}</td>
                                                <td>
                                                    <span class="badge bg-info">{{ task.status }}</span>
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <p class="text-muted">No active tasks.</p>
                            {% endif %}
                        </div>
                        
                        <!-- Completed Tasks -->
                        <div class="tab-pane fade" id="completed-tasks" role="tabpanel">
                            {% if all_tasks.completed %}
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Task ID</th>
                                                <th>Type</th>
                                                <th>Result</th>
                                                <th>Completed</th>
                                                <th>Duration</th>
                                                <th>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for task in all_tasks.completed[-10:] %}
                                            <tr>
                                                <td><code>{{ task.task_id[:8] }}...</code></td>
                                                <td>{{ task.task_type }}</td>
                                                <td>
                                                    {% if task.result %}
                                                        {% if task.result.success %}
                                                            <i class="fas fa-check text-success"></i> Success
                                                        {% else %}
                                                            <i class="fas fa-times text-danger"></i> Failed
                                                        {% endif %}
                                                    {% else %}
                                                        <span class="text-muted">N/A</span>
                                                    {% endif %}
                                                </td>
                                                <td>{{ task.completed_at or "Unknown" }}</td>
                                                <td>
                                                    {% if task.started_at and task.completed_at %}
                                                        <!-- Duration calculation would go here -->
                                                        <span class="text-muted">~</span>
                                                    {% else %}
                                                        <span class="text-muted">N/A</span>
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    {% if task.status == 'completed' %}
                                                        <span class="badge bg-success">{{ task.status }}</span>
                                                    {% elif task.status == 'failed' %}
                                                        <span class="badge bg-danger">{{ task.status }}</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">{{ task.status }}</span>
                                                    {% endif %}
                                                </td>
                                            </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            {% else %}
                                <p class="text-muted">No completed tasks.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Background Tasks JavaScript -->
<script>
// Background Task Monitoring JavaScript
function checkOCRStatus(taskId) {
    fetch(`/api/ocr/status/${taskId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const task = data.task;
                const progress = Math.round(task.progress * 100);
                
                let statusMessage = `OCR Task Status: ${task.status} (${progress}%)`;
                
                if (task.status === 'completed') {
                    if (task.result && task.result.success) {
                        statusMessage = `✅ OCR completed successfully! Extracted ${task.result.text_length || 0} characters.`;
                    } else {
                        statusMessage = `❌ OCR failed: ${task.error_message || 'Unknown error'}`;
                    }
                } else if (task.status === 'running') {
                    statusMessage = `🔄 OCR in progress... (${progress}%)`;
                } else if (task.status === 'pending') {
                    statusMessage = `⏳ OCR queued and waiting to start...`;
                }
                
                alert(statusMessage);
            } else {
                alert(`❌ Could not get task status: ${data.error}`);
            }
        })
        .catch(error => {
            console.error('Error checking OCR status:', error);
            alert('❌ Error checking OCR status. Please try again.');
        });
}

function refreshTaskStatus() {
    fetch('/api/ocr/user-tasks')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateTaskDisplay(data.tasks);
            }
        })
        .catch(error => console.error('Error refreshing task status:', error));
}

function updateTaskDisplay(tasks) {
    const container = document.getElementById('user-tasks-container');
    if (!container) return;
    
    if (tasks.length === 0) {
        container.innerHTML = '<p>No background tasks found.</p>';
        return;
    }
    
    let html = '<h4>Your Background Tasks</h4><div class="list-group">';
    
    tasks.forEach(task => {
        const progress = Math.round(task.progress * 100);
        const statusClass = task.status === 'completed' ? 'success' : 
                           task.status === 'failed' ? 'danger' : 'info';
        
        html += `
            <div class="list-group-item">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${task.document_name || 'Document'}</h6>
                    <span class="badge bg-${statusClass}">${task.status}</span>
                </div>
                <div class="progress mb-1">
                    <div class="progress-bar" style="width: ${progress}%">${progress}%</div>
                </div>
                <small>Task ID: ${task.task_id}</small>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// Auto-refresh task status every 5 seconds
setInterval(refreshTaskStatus, 5000);

// Initial load
document.addEventListener('DOMContentLoaded', refreshTaskStatus);
</script>
{% endblock %}