{% extends 'base_demo.html' %}
{# Add cache busting parameter to prevent browser caching #}

{% block title %}HealthPrep - {{ patient.full_name }}{% endblock %}

{% block content %}
<div class="mb-2">
    <div class="d-flex flex-column align-items-start">
        <a href="{{ url_for('patient_list') }}" class="btn btn-outline-secondary mb-2">
            <i class="fas fa-arrow-left me-2"></i>Return to Patient List
        </a>
    </div>
</div>

<div class="d-flex justify-content-between align-items-start mb-4">
    <h1>
        <i class="fas fa-user-circle me-2"></i>{{ patient.full_name }}
    </h1>
    <div class="d-grid" style="width: 200px;">
        <a href="{{ url_for('edit_patient', patient_id=patient.id) }}" class="btn btn-outline-secondary mb-2">
            <i class="fas fa-edit me-2"></i>Edit
        </a>
        <a href="{{ url_for('generate_patient_prep_sheet', patient_id=patient.id, cache_buster=now().strftime('%Y%m%d%H%M%S')|int) }}" class="btn btn-primary">
            Generate Prep Sheet
        </a>
    </div>
</div>

<!-- Patient Overview Card -->
<div class="row mb-4">
    <!-- Patient Alerts -->
    <div class="col-md-12 mb-4">
        <div class="card border-0">
            <div class="card-header bg-secondary bg-opacity-25 d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Patient Alerts</h5>
                <div>
                    <a href="{{ url_for('add_alert', patient_id=patient.id) }}" class="btn btn-sm btn-primary">
                        Add Alert
                    </a>
                </div>
            </div>
            <div class="card-body p-0">
                {% if patient.alerts %}
                    <div class="table-responsive">
                        <table class="table table-hover table-striped mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 15%;">Type</th>
                                    <th style="width: 35%;">Description</th>
                                    <th style="width: 10%;">Severity</th>
                                    <th style="width: 15%;">Start Date</th>
                                    <th style="width: 25%;">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for alert in patient.alerts %}
                                    {% if alert.is_active %}
                                        <tr class="{% if alert.severity == 'High' %}table-danger{% elif alert.severity == 'Medium' %}table-warning{% else %}table-info{% endif %}">
                                            <td>{{ alert.alert_type }}</td>
                                            <td>
                                                {{ alert.description }}
                                                {% if alert.details %}
                                                    <small class="d-block text-muted">{{ alert.details }}</small>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <span class="badge {% if alert.severity == 'High' %}bg-danger{% elif alert.severity == 'Medium' %}bg-warning text-dark{% else %}bg-info text-dark{% endif %}">
                                                    {{ alert.severity }}
                                                </span>
                                            </td>
                                            <td>{{ alert.start_date|dob }}</td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    <a href="{{ url_for('edit_alert', patient_id=patient.id, alert_id=alert.id) }}" class="btn btn-outline-secondary">
                                                        Edit
                                                    </a>
                                                    <a href="{{ url_for('delete_alert', patient_id=patient.id, alert_id=alert.id) }}" class="btn btn-outline-danger" onclick="return confirm('Are you sure you want to delete this alert?')">
                                                        Delete
                                                    </a>
                                                </div>
                                            </td>
                                        </tr>
                                    {% endif %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="alert alert-info m-3">
                        <p class="mb-0">No active alerts for this patient. <a href="{{ url_for('add_alert', patient_id=patient.id) }}" class="alert-link">Add an alert</a></p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-12">
        <div class="card border-0">
            <div class="card-header bg-secondary bg-opacity-25">
                <h5 class="mb-0">Patient Demographics</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-bordered">
                            <tr>
                                <th style="width: 35%">MRN</th>
                                <td>{{ patient.mrn }}</td>
                            </tr>
                            <tr>
                                <th>Date of Birth</th>
                                <td>{{ patient.date_of_birth|dob }} ({{ patient.age }} years)</td>
                            </tr>
                            <tr>
                                <th>Sex</th>
                                <td>{{ patient.sex }}</td>
                            </tr>
                            <tr>
                                <th>Phone</th>
                                <td>{{ patient.phone }}</td>
                            </tr>
                            <tr>
                                <th>Email</th>
                                <td>{{ patient.email }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-bordered">
                            <tr>
                                <th style="width: 35%">Address</th>
                                <td>{{ patient.address }}</td>
                            </tr>
                            <tr>
                                <th>Insurance</th>
                                <td>{{ patient.insurance }}</td>
                            </tr>
                            <tr>
                                <th>Active Conditions</th>
                                <td>
                                    {% if active_conditions %}
                                        {{ active_conditions|length }} condition(s)
                                    {% else %}
                                        None recorded
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Last Visit</th>
                                <td>
                                    {% if past_appointments %}
                                        <div>
                                            {{ past_appointments[0].appointment_date.strftime('%Y-%m-%d') }} 
                                            at {{ past_appointments[0].appointment_time.strftime('%I:%M %p') }}
                                        </div>
                                        {% if past_appointments[0].note %}
                                            <small class="text-muted">{{ past_appointments[0].note }}</small>
                                        {% endif %}
                                    {% elif past_visits %}
                                        <div>{{ past_visits[0].visit_date.strftime('%Y-%m-%d') }}</div>
                                        {% if past_visits[0].reason %}
                                            <small class="text-muted">{{ past_visits[0].reason }}</small>
                                        {% endif %}
                                    {% else %}
                                        None recorded
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>Next Visit</th>
                                <td>
                                    {% if upcoming_appointments %}
                                        <div>
                                            {{ upcoming_appointments[0].appointment_date.strftime('%Y-%m-%d') }} 
                                            at {{ upcoming_appointments[0].appointment_time.strftime('%I:%M %p') }}
                                        </div>
                                        {% if upcoming_appointments[0].note %}
                                            <small class="text-muted">{{ upcoming_appointments[0].note }}</small>
                                        {% endif %}
                                    {% elif upcoming_visit %}
                                        <div>{{ upcoming_visit.visit_date.strftime('%Y-%m-%d') }}</div>
                                        {% if upcoming_visit.reason %}
                                            <small class="text-muted">{{ upcoming_visit.reason }}</small>
                                        {% endif %}
                                    {% else %}
                                        None scheduled
                                    {% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Patient Data Categories -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card border-0">
            <div class="card-header bg-secondary bg-opacity-25" id="medical-data">
                <h5 class="mb-0">Patient Data</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <!-- Vitals -->
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fas fa-heartbeat me-1"></i> Vitals</h5>
                                <p class="card-text small text-muted">Height, weight, BP, temperature, and other vital measurements</p>
                            </div>
                            <div class="card-footer d-flex justify-content-between bg-transparent">
                                <a href="{{ url_for('add_vitals', patient_id=patient.id) }}" class="btn btn-sm btn-primary">
                                    <i class="fas fa-plus me-1"></i> Add
                                </a>
                                <a href="#" class="btn btn-sm btn-outline-secondary section-link" data-section="vitals">
                                    <i class="fas fa-history me-1"></i> History
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Conditions -->
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fas fa-clipboard-list me-1"></i> Conditions</h5>
                                <p class="card-text small text-muted">Medical diagnoses, chronic conditions, and active problems</p>
                            </div>
                            <div class="card-footer d-flex justify-content-between bg-transparent">
                                <a href="{{ url_for('add_condition', patient_id=patient.id) }}" class="btn btn-sm btn-primary">
                                    <i class="fas fa-plus me-1"></i> Add
                                </a>
                                <a href="#" class="btn btn-sm btn-outline-secondary section-link" data-section="conditions">
                                    <i class="fas fa-history me-1"></i> History
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Laboratories -->
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fas fa-flask me-1"></i> Laboratories</h5>
                                <p class="card-text small text-muted">Laboratory test results and reports</p>
                            </div>
                            <div class="card-footer d-flex justify-content-between bg-transparent">
                                <a href="{{ url_for('add_document', patient_id=patient.id) }}?type=lab" class="btn btn-sm btn-primary">
                                    <i class="fas fa-plus me-1"></i> Add
                                </a>
                                <a href="#" class="btn btn-sm btn-outline-secondary section-link" data-section="labs">
                                    <i class="fas fa-history me-1"></i> History
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Imaging -->
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fas fa-x-ray me-1"></i> Imaging</h5>
                                <p class="card-text small text-muted">Radiology studies, X-rays, MRIs, and CT scans</p>
                            </div>
                            <div class="card-footer d-flex justify-content-between bg-transparent">
                                <a href="{{ url_for('add_document', patient_id=patient.id) }}?type=imaging" class="btn btn-sm btn-primary">
                                    <i class="fas fa-plus me-1"></i> Add
                                </a>
                                <a href="#" class="btn btn-sm btn-outline-secondary section-link" data-section="imaging">
                                    <i class="fas fa-history me-1"></i> History
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Consults -->
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fas fa-user-md me-1"></i> Consults</h5>
                                <p class="card-text small text-muted">Specialist consult reports and referrals</p>
                            </div>
                            <div class="card-footer d-flex justify-content-between bg-transparent">
                                <a href="{{ url_for('add_document', patient_id=patient.id) }}?type=consult" class="btn btn-sm btn-primary">
                                    <i class="fas fa-plus me-1"></i> Add
                                </a>
                                <a href="#" class="btn btn-sm btn-outline-secondary section-link" data-section="consults">
                                    <i class="fas fa-history me-1"></i> History
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Appointments -->
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fas fa-calendar-check me-1"></i> Appointments</h5>
                                <p class="card-text small text-muted">Past and upcoming appointments</p>
                            </div>
                            <div class="card-footer d-flex justify-content-between bg-transparent">
                                <a href="{{ url_for('add_appointment') }}?patient_id={{ patient.id }}" class="btn btn-sm btn-primary">
                                    <i class="fas fa-plus me-1"></i> Add
                                </a>
                                <a href="#" class="btn btn-sm btn-outline-secondary section-link" data-section="appointments">
                                    <i class="fas fa-history me-1"></i> History
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Hospital Records -->
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fas fa-hospital me-1"></i> Hospital Records</h5>
                                <p class="card-text small text-muted">Admission/discharge summaries and hospitalizations</p>
                            </div>
                            <div class="card-footer d-flex justify-content-between bg-transparent">
                                <a href="{{ url_for('add_document', patient_id=patient.id) }}?type=hospital" class="btn btn-sm btn-primary">
                                    <i class="fas fa-plus me-1"></i> Add
                                </a>
                                <a href="#" class="btn btn-sm btn-outline-secondary section-link" data-section="hospital">
                                    <i class="fas fa-history me-1"></i> History
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Immunizations -->
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fas fa-syringe me-1"></i> Immunizations</h5>
                                <p class="card-text small text-muted">Vaccination records and immunization history</p>
                            </div>
                            <div class="card-footer d-flex justify-content-between bg-transparent">
                                <a href="/patients/{{patient.id}}/immunization" class="btn btn-sm btn-primary">
                                    <i class="fas fa-plus me-1"></i> Add
                                </a>
                                <a href="#" class="btn btn-sm btn-outline-secondary section-link" data-section="immunizations">
                                    <i class="fas fa-history me-1"></i> History
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Other Documents -->
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h5 class="card-title"><i class="fas fa-file-medical me-1"></i> Other</h5>
                                <p class="card-text small text-muted">Miscellaneous medical documents</p>
                            </div>
                            <div class="card-footer d-flex justify-content-between bg-transparent">
                                <a href="{{ url_for('add_document', patient_id=patient.id) }}" class="btn btn-sm btn-primary">
                                    <i class="fas fa-plus me-1"></i> Add
                                </a>
                                <a href="#" class="btn btn-sm btn-outline-secondary section-link" data-section="other">
                                    <i class="fas fa-history me-1"></i> History
                                </a>
                            </div>
                        </div>
                    </div>


                </div>
            </div>
        </div>
    </div>
</div>

<!-- Dynamic History Sections -->
<div class="mt-4">
    <!-- Vitals History Section -->
    <div id="vitals-history" class="history-section" style="display: none;">
        <div class="card">
            <div class="card-header bg-secondary bg-opacity-25 d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Vitals History</h5>
                <button type="button" class="btn-close" aria-label="Close" onclick="document.getElementById('vitals-history').style.display = 'none';"></button>
            </div>
            <div class="card-body">
                {% if all_vitals %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Height</th>
                                <th>Weight</th>
                                <th>BMI</th>
                                <th>Temperature</th>
                                <th>Blood Pressure</th>
                                <th>Pulse</th>
                                <th>Resp Rate</th>
                                <th>O2 Sat</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for vital in all_vitals %}
                            <tr>
                                <td>{{ vital.date.strftime('%Y-%m-%d') }}</td>
                                <td>{{ (vital.height / 2.54)|round(1) if vital.height else '--' }} in</td>
                                <td>{{ (vital.weight * 2.20462)|round(1) if vital.weight else '--' }} lbs</td>
                                <td>{{ vital.bmi|round(1) if vital.bmi else '--' }}</td>
                                <td>{{ (vital.temperature * 9/5 + 32)|round(1) if vital.temperature else '--' }} °F</td>
                                <td>{{ vital.blood_pressure_systolic }}/{{ vital.blood_pressure_diastolic }} mmHg</td>
                                <td>{{ vital.pulse }} bpm</td>
                                <td>{{ vital.respiratory_rate }}</td>
                                <td>{{ vital.oxygen_saturation }}%</td>
                                <td>
                                    <a href="{{ url_for('delete_vital', patient_id=patient.id, vital_id=vital.id) }}" class="btn btn-sm btn-danger">
                                        <i class="fas fa-trash me-1"></i> Delete
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">No vital signs recorded for this patient.</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Appointments History Section -->
    <div id="appointments-history" class="history-section" style="display: none;">
        <div class="card">
            <div class="card-header bg-secondary bg-opacity-25 d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Appointment History</h5>
                <button type="button" class="btn-close" aria-label="Close" onclick="document.getElementById('appointments-history').style.display = 'none';"></button>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs" id="appointmentHistoryTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="upcoming-appt-tab" data-bs-toggle="tab" data-bs-target="#upcoming-appt" type="button" role="tab" aria-controls="upcoming-appt" aria-selected="true">
                            Upcoming ({{ upcoming_appointments|length if upcoming_appointments else 0 }})
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="past-appt-tab" data-bs-toggle="tab" data-bs-target="#past-appt" type="button" role="tab" aria-controls="past-appt" aria-selected="false">
                            Past ({{ past_appointments|length if past_appointments else 0 }})
                        </button>
                    </li>
                </ul>
                <div class="tab-content" id="appointmentHistoryTabsContent">
                    <!-- Upcoming Appointments Tab -->
                    <div class="tab-pane fade show active" id="upcoming-appt" role="tabpanel" aria-labelledby="upcoming-appt-tab">
                        {% if upcoming_appointments %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Time</th>
                                        <th>Note</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for appointment in upcoming_appointments %}
                                    <tr>
                                        <td>{{ appointment.appointment_date.strftime('%Y-%m-%d') }}</td>
                                        <td>{{ appointment.appointment_time.strftime('%I:%M %p') }}</td>
                                        <td>{{ appointment.note }}</td>
                                        <td>
                                            <div class="btn-group">
                                                <a href="{{ url_for('edit_appointment', appointment_id=appointment.id) }}" class="btn btn-sm btn-outline-secondary">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <a href="{{ url_for('delete_appointment', appointment_id=appointment.id) }}" 
                                                class="btn btn-sm btn-outline-danger"
                                                onclick="return confirm('Are you sure you want to delete this appointment?')">
                                                    <i class="fas fa-trash-alt"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <p class="text-muted">No upcoming appointments scheduled</p>
                            <a href="{{ url_for('add_appointment') }}?patient_id={{ patient.id }}" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>Add Appointment
                            </a>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Past Appointments Tab -->
                    <div class="tab-pane fade" id="past-appt" role="tabpanel" aria-labelledby="past-appt-tab">
                        {% if past_appointments %}
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Time</th>
                                        <th>Note</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for appointment in past_appointments %}
                                    <tr>
                                        <td>{{ appointment.appointment_date.strftime('%Y-%m-%d') }}</td>
                                        <td>{{ appointment.appointment_time.strftime('%I:%M %p') }}</td>
                                        <td>{{ appointment.note }}</td>
                                        <td>
                                            <a href="{{ url_for('delete_appointment', appointment_id=appointment.id) }}" 
                                            class="btn btn-sm btn-outline-danger"
                                            onclick="return confirm('Are you sure you want to delete this appointment?')">
                                                <i class="fas fa-trash-alt"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <p class="text-muted">No past appointments found</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Conditions History Section -->
    <div id="conditions-history" class="history-section" style="display: none;">
        <div class="card">
            <div class="card-header bg-secondary bg-opacity-25 d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Conditions History</h5>
                <button type="button" class="btn-close" aria-label="Close" onclick="document.getElementById('conditions-history').style.display = 'none';"></button>
            </div>
            <div class="card-body">
                {% if active_conditions %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Date Diagnosed</th>
                                <th>Condition Name</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for condition in active_conditions %}
                            <tr>
                                <td>{{ condition.diagnosed_date.strftime('%Y-%m-%d') if condition.diagnosed_date else 'Unknown' }}</td>
                                <td>{{ condition.name }}</td>
                                <td>
                                    {% if condition.is_active %}
                                    <span class="badge bg-success">Active</span>
                                    {% else %}
                                    <span class="badge bg-secondary">Inactive</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ url_for('delete_condition', patient_id=patient.id, condition_id=condition.id) }}" class="btn btn-sm btn-danger">
                                        <i class="fas fa-trash me-1"></i> Delete
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">No conditions recorded for this patient.</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Labs History Section -->
    <div id="labs-history" class="history-section" style="display: none;">
        <div class="card">
            <div class="card-header bg-secondary bg-opacity-25 d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Laboratory Results History</h5>
                <button type="button" class="btn-close" aria-label="Close" onclick="document.getElementById('labs-history').style.display = 'none';"></button>
            </div>
            <div class="card-body">
                {% if lab_documents|length > 0 %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>File Name</th>
                                <th>Date</th>
                                <th>Origin</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for doc in lab_documents %}
                            <tr>
                                <td>{{ doc.document_name if doc.document_name else doc.filename }}</td>
                                <td>{{ doc.document_date.strftime('%Y-%m-%d') if doc.document_date else 'N/A' }}</td>
                                <td>{{ doc.source_system }}</td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="{{ url_for('view_document', document_id=doc.id, return_to='medical_data') }}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye me-1"></i> View
                                        </a>
                                        <a href="{{ url_for('delete_document', patient_id=patient.id, document_id=doc.id) }}" class="btn btn-sm btn-danger">
                                            <i class="fas fa-trash me-1"></i> Delete
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">No laboratory documents available for this patient.</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Imaging History Section -->
    <div id="imaging-history" class="history-section" style="display: none;">
        <div class="card">
            <div class="card-header bg-secondary bg-opacity-25 d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Imaging Studies History</h5>
                <button type="button" class="btn-close" aria-label="Close"></button>
            </div>
            <div class="card-body">
                {% if imaging_documents|length > 0 %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>File Name</th>
                                <th>Date</th>
                                <th>Origin</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for doc in imaging_documents %}
                            <tr>
                                <td>{{ doc.document_name if doc.document_name else doc.filename }}</td>
                                <td>{{ doc.document_date.strftime('%Y-%m-%d') if doc.document_date else 'N/A' }}</td>
                                <td>{{ doc.source_system }}</td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="{{ url_for('view_document', document_id=doc.id, return_to='medical_data') }}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye me-1"></i> View
                                        </a>
                                        <a href="{{ url_for('delete_document', patient_id=patient.id, document_id=doc.id) }}" class="btn btn-sm btn-danger">
                                            <i class="fas fa-trash me-1"></i> Delete
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">No imaging documents available for this patient.</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Consults History Section -->
    <div id="consults-history" class="history-section" style="display: none;">
        <div class="card">
            <div class="card-header bg-secondary bg-opacity-25 d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Consults History</h5>
                <button type="button" class="btn-close" aria-label="Close"></button>
            </div>
            <div class="card-body">
                {% if consult_documents|length > 0 %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>File Name</th>
                                <th>Date</th>
                                <th>Origin</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for doc in consult_documents %}
                            <tr>
                                <td>{{ doc.document_name if doc.document_name else doc.filename }}</td>
                                <td>{{ doc.document_date.strftime('%Y-%m-%d') if doc.document_date else 'N/A' }}</td>
                                <td>{{ doc.source_system }}</td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="{{ url_for('view_document', document_id=doc.id, return_to='medical_data') }}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye me-1"></i> View
                                        </a>
                                        <a href="{{ url_for('delete_document', patient_id=patient.id, document_id=doc.id) }}" class="btn btn-sm btn-danger">
                                            <i class="fas fa-trash me-1"></i> Delete
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">No consult documents available for this patient.</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Hospital History Section -->
    <div id="hospital-history" class="history-section" style="display: none;">
        <div class="card">
            <div class="card-header bg-secondary bg-opacity-25 d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Hospital Summaries History</h5>
                <button type="button" class="btn-close" aria-label="Close"></button>
            </div>
            <div class="card-body">
                {% if hospital_documents|length > 0 %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>File Name</th>
                                <th>Date</th>
                                <th>Origin</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for doc in hospital_documents %}
                            <tr>
                                <td>{{ doc.document_name if doc.document_name else doc.filename }}</td>
                                <td>{{ doc.document_date.strftime('%Y-%m-%d') if doc.document_date else 'N/A' }}</td>
                                <td>{{ doc.source_system }}</td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="{{ url_for('view_document', document_id=doc.id, return_to='medical_data') }}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye me-1"></i> View
                                        </a>
                                        <a href="{{ url_for('delete_document', patient_id=patient.id, document_id=doc.id) }}" class="btn btn-sm btn-danger">
                                            <i class="fas fa-trash me-1"></i> Delete
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">No hospital documents available for this patient.</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Immunizations History Section -->
    <div id="immunizations-history" class="history-section" style="display: none;">
        <div class="card">
            <div class="card-header bg-secondary bg-opacity-25 d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Immunizations History</h5>
                <button type="button" class="btn-close" aria-label="Close"></button>
            </div>
            <div class="card-body">
                {% if immunizations %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Administration Date</th>
                                <th>Vaccine Name</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for immunization in immunizations %}
                            <tr>
                                <td>{{ immunization.administration_date.strftime('%Y-%m-%d') }}</td>
                                <td>{{ immunization.vaccine_name }}</td>
                                <td>
                                    <a href="/patients/{{patient.id}}/immunization/{{immunization.id}}/delete" class="btn btn-sm btn-danger">
                                        <i class="fas fa-trash me-1"></i> Delete
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">No immunization records available for this patient.</div>
                {% endif %}

                <div class="mt-3">
                    <a href="/patients/{{patient.id}}/immunization" class="btn btn-primary">
                        <i class="fas fa-plus-circle me-1"></i> Add Immunization
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Other Documents History Section -->
    <div id="other-history" class="history-section" style="display: none;">
        <div class="card">
            <div class="card-header bg-secondary bg-opacity-25 d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Other Documents History</h5>
                <button type="button" class="btn-close" aria-label="Close"></button>
            </div>
            <div class="card-body">
                {% if other_documents|length > 0 %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>File Name</th>
                                <th>Date</th>
                                <th>Origin</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for doc in other_documents %}
                            <tr>
                                <td>{{ doc.document_name if doc.document_name else doc.filename }}</td>
                                <td>{{ doc.document_date.strftime('%Y-%m-%d') if doc.document_date else 'N/A' }}</td>
                                <td>{{ doc.source_system }}</td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="{{ url_for('view_document', document_id=doc.id, return_to='medical_data') }}" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye me-1"></i> View
                                        </a>
                                        <a href="{{ url_for('delete_document', patient_id=patient.id, document_id=doc.id) }}" class="btn btn-sm btn-danger">
                                            <i class="fas fa-trash me-1"></i> Delete
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-info">No other documents available for this patient.</div>
                {% endif %}
            </div>
        </div>
    </div>


</div>

<!-- JavaScript for handling the section navigation -->
<script src="{{ url_for('static', filename='js/patient_detail.js') }}"></script>
<script>
// Initialize Bootstrap tabs for the appointments history section
document.addEventListener('DOMContentLoaded', function() {
    // Add a listener for when the appointments-history section is shown
    document.querySelectorAll('.section-link').forEach(link => {
        if (link.getAttribute('data-section') === 'appointments') {
            link.addEventListener('click', function() {
                // Initialize the tabs after a brief delay to ensure the section is visible
                setTimeout(function() {
                    // Initialize Bootstrap tabs manually
                    const tabElements = document.querySelectorAll('#appointmentHistoryTabs button[data-bs-toggle="tab"]');
                    tabElements.forEach(tabEl => {
                        tabEl.addEventListener('click', function (event) {
                            event.preventDefault();
                            const tabTarget = document.querySelector(this.getAttribute('data-bs-target'));

                            // Hide all tab panes
                            document.querySelectorAll('#appointmentHistoryTabsContent .tab-pane').forEach(pane => {
                                pane.classList.remove('show', 'active');
                            });

                            // Deactivate all tab buttons
                            document.querySelectorAll('#appointmentHistoryTabs button').forEach(btn => {
                                btn.classList.remove('active');
                                btn.setAttribute('aria-selected', 'false');
                            });

                            // Show the selected tab pane
                            tabTarget.classList.add('show', 'active');

                            // Activate the clicked tab button
                            this.classList.add('active');
                            this.setAttribute('aria-selected', 'true');
                        });
                    });
                }, 100);
            });
        }
    });
});
</script>
{% endblock %}